<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="theme-color" content="#0055a5"/>
<link rel="manifest" href="manifest.json"/>
<title>CRM de Habilitaci√≥n - YPFB Transporte (v4)</title>
<link rel="stylesheet" href="https://unpkg.com/intro.js@7.1.0/minified/introjs.min.css"/>
<style>
:root{
  --bg:#ffffff; --panel:#f0f6ff; --muted:#0d3c78; --text:#00224d;
  --brand:#0055a5; --ok:#0a7f37; --warn:#b45309; --err:#b91c1c;
  --chip:#e6efff; --card:#ffffff; --input:#ffffff; --border:#bcd0ef;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;color:var(--text)}
header{position:sticky;top:0;background:var(--brand);color:#fff;padding:12px 16px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center;z-index:10;max-width:1280px;margin:0 auto}
.logo{font-weight:800;letter-spacing:.2px}
.spacer{flex:1}
.inp{padding:8px 10px;border:1px solid var(--border);background:var(--input);color:var(--text);border-radius:10px}
.btn{border:none;background:var(--brand);color:#fff;font-weight:700;padding:9px 12px;border-radius:12px;cursor:pointer}
.btn.secondary{background:#fff;color:var(--brand);border:1px solid var(--brand)}
.btn.ghost{background:transparent;border:1px solid var(--brand);color:var(--brand)}
.btn.icon{padding:6px 8px;display:inline-flex;align-items:center;justify-content:center}
.small{font-size:13px}
.wrap{max-width:1280px;margin:18px auto;padding:0 16px}
.banner{display:none;margin-top:10px;padding:10px;border:1px dashed var(--border);border-radius:10px;background:#e6efff;color:var(--text)}
.sidebar{position:fixed;top:0;left:0;bottom:0;width:60px;background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column;gap:4px;padding:20px 0;transition:width .2s}
.sidebar:hover{width:180px}
.sidebar .tab{display:flex;align-items:center;gap:8px;padding:10px 12px;color:var(--muted);cursor:pointer;white-space:nowrap;border-radius:0 20px 20px 0}
.sidebar .tab.active{background:var(--card);color:var(--text)}
.sidebar .tab i{width:24px;text-align:center;font-style:normal}
.sidebar .tab span{display:none}
.sidebar:hover .tab span{display:inline}
.main{margin-left:60px;width:calc(100% - 60px);transition:margin-left .2s,width .2s}
.sidebar:hover ~ .main{margin-left:180px;width:calc(100% - 180px)}
.panel{display:none;border:1px solid var(--border);background:var(--card);padding:16px;border-radius:0 12px 12px 12px}
.panel.active{display:block}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.col-12{grid-column:span 12}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}
label{font-size:13px;color:var(--muted);display:block;margin:2px 0 6px}
input[type="text"],input[type="email"],input[type="tel"],input[type="password"],select,textarea{width:100%;padding:9px 10px;border-radius:10px;border:1px solid var(--border);background:var(--input);color:var(--text)}
textarea{min-height:80px;resize:vertical}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{padding:5px 10px;border:1px solid var(--border);border-radius:999px;background:var(--chip);cursor:pointer;font-size:13px;user-select:none}
.chip input{display:none}
.chip.active{outline:2px solid var(--brand)}
.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}
.cardx{border:1px solid var(--border);background:var(--panel);border-radius:14px;padding:12px;box-shadow:8px 8px 16px #b3c5e5,-8px -8px 16px #ffffff}
.cardx h4{margin:0 0 4px}
.pill{display:inline-block;border:1px solid var(--border);padding:2px 6px;border-radius:999px;font-size:12px;margin-right:6px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px dashed var(--border);padding:8px 6px;text-align:left;vertical-align:top}
.proj-actions{display:flex;flex-wrap:wrap;gap:4px}
.proj-actions .btn{flex:1 1 calc(50% - 4px);text-align:center}
.hist-item{white-space:nowrap;margin-bottom:2px;}
.resp-card details{margin-top:8px;}
.resp-card summary{cursor:pointer;font-weight:600;}
.resp-card .log{margin-top:6px;padding-left:10px;border-left:2px solid var(--border);}
.status.aprob{color:var(--ok)}.status.observ{color:var(--err)}.status.parcial{color:var(--warn)}
.kpi{display:flex;gap:10px;flex-wrap:wrap}
.kpi>div{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
.section{margin:14px 0 6px;padding:10px;border-radius:12px;border:1px solid var(--border);background:var(--panel)}
.row{display:flex;gap:8px;align-items:center}
.right{margin-left:auto}
.note{font-size:12px;color:#516a98}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px}
.badge.ok{background:rgba(34,197,94,.15);color:var(--ok)}
.badge.warn{background:rgba(234,179,8,.15);color:var(--warn)}
.badge.err{background:rgba(239,68,68,.15);color:var(--err)}
.badge.muted{background:rgba(100,116,139,.2);color:#475569}
.table tr.row-hidden{opacity:.55}
.aprob-banner{padding:6px;margin-top:10px;text-align:center;font-weight:bold;border:2px solid}
.aprob-banner.ok{border-color:var(--ok);color:var(--ok)}
.aprob-banner.err{border-color:var(--err);color:var(--err)}
.canvas-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:12px}
.canvas-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;box-shadow:8px 8px 16px #b3c5e5,-8px -8px 16px #ffffff}
#panel-dashboard{font-size:16px}
#panel-dashboard .small{font-size:16px}
#panel-dashboard canvas{height:260px}
canvas{width:100%;height:300px;border-radius:8px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:20}
.modal .box{max-width:980px;width:min(92vw,980px);background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;max-height:85vh;overflow:auto}
.login-card{max-width:320px;width:90vw;background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:24px;display:flex;flex-direction:column;align-items:stretch;gap:12px;text-align:center}
.login-logo{width:120px;height:auto;margin:0 auto 12px;display:block}
.login-card h3{margin:0}
.login-card .inp{margin:0 0 10px}
.login-card label.row{align-self:flex-start;margin:0 0 4px}
.login-card .sticky-actions{position:static;justify-content:center;padding:0;margin-top:8px;border-top:none}
.admin-tab{display:none}
.user-card{display:flex;gap:10px;align-items:center}
.user-card-img{width:60px;height:60px;border-radius:50%;object-fit:cover}
.sticky-actions{position:sticky;bottom:0;background:var(--panel);padding:10px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end}
@media print{
  body{background:#fff;color:#000}
  header,.sidebar,.sticky-actions,.no-print{display:none!important}
  .panel{border:none}
  .print-container{padding:0;margin:0}
  .print-section{page-break-inside:avoid;margin:10px 0}
  table{border-collapse:collapse}
  th,td{border:1px solid #000;padding:4px 6px}
  .status.aprob{color:#0a0}.status.observ{color:#a00}.status.parcial{color:#a60}
}

/* Estilos para el Chatbot de IA */
#chat-ai-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 100;
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  border-radius: 999px;
  border: none;
  background: linear-gradient(135deg, var(--brand), #1e3a8a);
  color: #fff;
  font-size: 16px;
  font-weight: 700;
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
#chat-ai-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.3);
}
#chat-ai-container {
  position: fixed;
  bottom: 80px;
  right: 20px;
  width: 350px;
  max-width: 90vw;
  height: 500px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 16px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
  display: flex;
  flex-direction: column;
  z-index: 100;
  transform: scale(0);
  transform-origin: bottom right;
  transition: transform 0.2s ease-out;
}
#chat-ai-container.visible {
  transform: scale(1);
}
#chat-ai-header {
  padding: 12px;
  font-weight: 700;
  border-bottom: 1px solid var(--border);
  background: var(--panel);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
#chat-ai-close-btn {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--muted);
}
#chat-messages {
  flex: 1;
  padding: 12px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.chat-message {
  padding: 8px 12px;
  border-radius: 12px;
  max-width: 85%;
  line-height: 1.4;
}
.chat-message.user {
  background: var(--brand);
  color: #fff;
  align-self: flex-end;
  border-bottom-right-radius: 4px;
}
.chat-message.ai {
  background: var(--panel);
  color: var(--text);
  align-self: flex-start;
  border-bottom-left-radius: 4px;
}
#chat-ai-footer {
  padding: 10px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 8px;
}
#chat-input {
  flex: 1;
}

.introjs-tooltip{
  background:linear-gradient(135deg,var(--brand),#fef4e6);
  color:#fff;
  border-radius:6px;
  box-shadow:0 10px 20px rgba(0,0,0,0.15);
}
.introjs-tooltiptext{
  background:none;
}
.introjs-button{
  background:var(--brand);
  color:#fff;
  border:none;
  border-radius:4px;
}
.introjs-button:focus,.introjs-button:hover{
  background:#0960bd;
}
.introjs-bullets li a.active{background:#fff}
@media (max-width:768px){
  .sidebar{position:static;width:100%;height:auto;flex-direction:row;border-right:none;border-bottom:1px solid var(--border);}
  .sidebar .tab span{display:none;}
  .sidebar:hover{width:100%;}
  .sidebar:hover .tab span{display:none;}
  .main{margin-left:0;width:100%;}
  .grid{grid-template-columns:1fr;}
  .col-12,.col-8,.col-6,.col-4,.col-3{grid-column:span 1;}
}
@media (min-width:769px) and (max-width:1024px){
  .grid{grid-template-columns:repeat(8,1fr);}
  .col-12{grid-column:span 8;}
  .col-8{grid-column:span 8;}
  .col-6{grid-column:span 4;}
  .col-4{grid-column:span 4;}
  .col-3{grid-column:span 2;}
}

</style>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://unpkg.com/intro.js@7.1.0/minified/intro.min.js"></script>
<script src="outlook-email.js"></script>
</head>
<body>
<iframe name="iframe-invisible" style="display:none;"
></iframe>
<div id="login-modal" class="modal">
  <div class="login-card">
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABHUlEQVRYR+2WvQ2DMBBGn/HJ1VE3SKYgIcIl5lQEkFK2TykZISwH0LZ1sglaZu1roWAtxEvsC0BpvyEukgqS0bkkCm1cWAC5JyRzeM/7/8n0JAz9nALoAKAGQAIyb3MGIH6BMEGvVgDhXtOD87zADxg6D1GZNVVRFlEAVYyqS/fWznuaCG2lLBVmOAXoJ2Bs8CXUAK4J8WcA6gYGkc4Y5E9O+V1YxAECEV4Bjqw2gw2gYdExgkt1/3AFjlGIIKgD/KyqCCpt5TR1+t0NenE2noKGItgKeGaBuGJPD7WvMAqoAt4EvsC0Bp+YukgqU0bEktkbZVgB9DoP70uQgmO6ijLJrVN6a8GN28AL5OHnqd7qV3CyMfCVAA/gLwBPYEVAk0nnBYnAb4Jr/gdI+HgAAAABJRU5ErkJggg==" alt="YPFB" class="login-logo"/>
    <h3>Ingreso al sistema</h3>
    <input id="login-nombre" class="inp" list="personal-list" placeholder="Nombre"/>
    <input id="login-correo" class="inp" type="email" placeholder="Correo"/>
    <input id="login-codigo" class="inp" type="text" placeholder="C√≥digo empleado" readonly style="display:none"/>
    <input id="login-pass1" class="inp" type="password" placeholder="Contrase√±a"/>
    <input id="login-pass2" class="inp" type="password" placeholder="Confirmar contrase√±a"/>
    <label class="row small" style="margin:8px 0"><input type="checkbox" id="login-remember"/> Mantener sesi√≥n iniciada</label>
    <div class="sticky-actions"><button class="btn" onclick="confirmLogin()">Guardar</button></div>
  </div>
</div>
<datalist id="personal-list"></datalist>
<div id="config-modal" class="modal">
  <div class="login-card" style="max-width:400px">
    <h3>Configuraci√≥n</h3>
    <label>Sesi√≥n actual</label>
    <div class="row" style="gap:8px;flex-wrap:wrap;align-items:center;">
      <input id="cfg-session-email" class="inp" type="email" placeholder="usuario@ypfb.com" style="flex:1"/>
      <button class="btn secondary" id="cfg-open-login" type="button">Iniciar / cambiar sesi√≥n</button>
    </div>
    <label>API Key de Gemini</label>
    <input id="cfg-gemini" class="inp" type="text"/>
    <label>URL Script de Google</label>
    <input id="cfg-script" class="inp" type="text"/>
    <label>Contrase√±a actual</label>
    <input id="cfg-oldpass" class="inp" type="password"/>
    <label>Nueva contrase√±a</label>
    <input id="cfg-newpass" class="inp" type="password"/>
    <div id="cfg-admin" style="display:none">
      <label>Correo para habilitar IA</label>
      <input id="cfg-ai-email" class="inp" type="email"/>
      <div class="row" style="gap:8px">
        <button class="btn secondary" id="cfg-ai-enable">Habilitar IA</button>
        <button class="btn ghost" id="cfg-ai-disable">Deshabilitar IA</button>
      </div>
    </div>
    <div class="sticky-actions">
      <button class="btn" id="cfg-save">Guardar</button>
      <button class="btn secondary" id="cfg-change-pass">Cambiar contrase√±a</button>
      <button class="btn ghost" id="cfg-close">Cerrar</button>
    </div>
  </div>
</div>
<nav class="sidebar">
  <div class="tab active" data-tab="dashboard"><i>üè†</i><span>Dashboard</span></div>
  <div class="tab" data-tab="cards"><i>üóÇÔ∏è</i><span>Cards Empresa</span></div>
  <div class="tab" data-tab="resp" style="display:none"><i>üìä</i><span>Seguimiento</span></div>
  <div class="tab" data-tab="ypfb"><i>üßë‚Äçüíº</i><span>YPFB</span></div>
  <div class="tab" data-tab="empresa"><i>üè¢</i><span>Empresa</span></div>
  <div class="tab" data-tab="ls025"><i>üìã</i><span>LS.025</span></div>
  <div class="tab" data-tab="personal"><i>üë•</i><span>Personal</span></div>
  <div class="tab" data-tab="vehiculos"><i>üöö</i><span>Veh√≠culos</span></div>
  <div class="tab" data-tab="resumen"><i>üìÑ</i><span>Resumen</span></div>
  <div class="tab admin-tab" data-tab="usuarios"><i>üìá</i><span>Personal</span></div>
</nav>
<div class="main">
<header>
  <div class="logo">YPFB Transporte ‚Äî CRM Habilitaci√≥n Elaborado por David A. Machaca Pereyra <span class="small">(v4)</span></div>
  <div class="spacer"></div>
  <label class="small">Tu correo</label>
  <input id="userEmail" class="inp" type="email" placeholder="usuario@ypfb.com"/>
  <button class="btn secondary" id="btnPickDir">Carpeta BD</button>
  <button class="btn secondary" id="btnConfig">Configuraci√≥n</button>
 </header>

<div class="wrap">
  <div id="bd-banner" class="banner no-print"></div>

  <section id="panel-dashboard" class="panel active">
    <div class="kpi" style="margin-top:10px">
      <div>Empresas: <b id="k-empresas">0</b></div>
      <div>Proyectos: <b id="k-proyectos">0</b></div>
      <div>Aprobados: <b id="k-aprob">0</b></div>
      <div>Parciales: <b id="k-parc">0</b></div>
      <div>Observados: <b id="k-obsv">0</b></div>
    </div>

    <div class="canvas-grid" style="margin-top:12px">
      <div class="canvas-card"><div class="small">Global A/P/O</div><canvas id="cv-donut" width="500" height="300"></canvas></div>
      <div class="canvas-card"><div class="small">Revisiones SST</div><canvas id="cv-resp-sst" width="500" height="300"></canvas></div>
      <div class="canvas-card"><div class="small">Revisiones MA</div><canvas id="cv-resp-ma" width="500" height="300"></canvas></div>
      <div class="canvas-card"><div class="small">Revisiones RSE</div><canvas id="cv-resp-rse" width="500" height="300"></canvas></div>
      <div class="canvas-card"><div class="small">Responsables de proyecto asignados</div><canvas id="cv-resp-proy" width="500" height="300"></canvas></div>
      <div class="canvas-card">
        <div class="row" style="align-items:center;justify-content:space-between;">
          <div id="cv-series-title" class="small">Proyectos / mes (creados vs. aprobados)</div>
          <select id="series-scale" class="inp small" style="width:120px">
            <option value="month">Por mes</option>
            <option value="day">Por d√≠a</option>
          </select>
        </div>
        <canvas id="cv-series" width="500" height="300"></canvas>
      </div>
      <div class="canvas-card"><div class="small">Top 5 empresas con m√°s ‚ÄúNO‚Äù</div><canvas id="cv-top5" width="500" height="300"></canvas></div>
      <div class="canvas-card"><div class="small">Estados globales</div><canvas id="cv-estados" width="500" height="300"></canvas></div>
      <div class="canvas-card"><div class="small">Proyectos por tipo</div><canvas id="cv-tipos" width="500" height="300"></canvas></div>
      <div class="canvas-card"><div class="small">Top 5 empresas con m√°s proyectos</div><canvas id="cv-topproj" width="500" height="300"></canvas></div>
    </div>
  </section>

  <section id="panel-cards" class="panel">
    <div class="row">
      <input id="search" class="inp" type="text" placeholder="Buscar empresa / proyecto..." style="flex:2;min-width:260px"/>
      <select id="filtro-tipo" class="inp"><option value="">Tipo Carpeta</option><option>CI</option><option>HP</option><option>DB</option><option>HV</option></select>
      <select id="filtro-estado" class="inp"><option value="">Estado</option><option value="APROBADO">Aprobado</option><option value="PARCIAL">Parcial</option><option value="OBSERVADO">Observado</option></select>
      <button class="btn ghost no-print" onclick="limpiarCache()">Limpiar cache</button>
    </div>

    <div class="row" style="margin-top:10px">
      <h3 class="right">Empresas</h3>
      <div class="spacer"></div>
      <button class="btn secondary" onclick="toggleVista()">Tarjetas/Tabla</button>
    </div>
    <div id="cards" class="cards" style="margin-top:8px"></div>
    <div id="tabla" style="display:none;overflow:auto;margin-top:8px">
      <table class="table">
        <thead><tr><th>Empresa</th><th>Clave</th><th>Proyectos</th><th>Acciones</th></tr></thead>
        <tbody id="tabla-body"></tbody>
      </table>
    </div>
  </section>

  <section id="panel-ypfb" class="panel">
    <h2>Asignaciones YPFB</h2>
    <div class="section">
      <h4>Pendientes</h4>
      <div id="ypfb-pend" class="cards"></div>
    </div>
    <div class="section">
      <h4>Revisados</h4>
      <div id="ypfb-rev" class="cards"></div>
    </div>
  </section>

  <section id="panel-resp" class="panel">
    <h2>Mis Proyectos</h2>
    <div id="resp-proyectos" class="cards"></div>
  </section>

  <section id="panel-empresa" class="panel">
    <h2>Empresa</h2>
      <div class="grid">
        <div class="col-4"><label>Clave</label><input id="emp-clave" type="text" readonly/></div>
        <div class="col-8"><label>Nombre</label><input id="emp-nombre" class="inp" type="text" list="empresas-list"/><datalist id="empresas-list"></datalist></div>
      <div class="col-4"><label>Tel√©fono</label><input id="emp-tel" type="tel"/></div>
      <div class="col-4"><label>Correo</label><input id="emp-mail" type="email"/></div>
      <div class="col-12 row">
        <button class="btn" onclick="guardarEmpresa()">Guardar Empresa</button>
        <button class="btn ghost" onclick="eliminarEmpresa()">Eliminar Empresa</button>
        <div class="note">Los datos se guardan en este HTML; exporte el JSON desde el panel de Resumen cuando lo requiera.</div>
      </div>
    </div>

    <div class="section">
      <div class="row">
        <h3>Proyectos</h3><div class="spacer"></div>
        <button id="btn-nuevo-proyecto" class="btn secondary" onclick="crearProyecto()">Nuevo Proyecto (P00x)</button>
      </div>
      <div style="overflow:auto;margin-top:8px">
        <table class="table">
        <thead><tr><th>ID</th><th>Nombre</th><th>SST</th><th>MA</th><th>RSE</th><th>Resp. Proy</th><th>Tipos</th><th>Creado</th><th>Estado</th><th>Historial</th><th>Acciones</th></tr></thead>
          <tbody id="tb-proyectos"></tbody>
        </table>
      </div>
    </div>
  </section>

  <section id="panel-ls025" class="panel">
    <div class="row">
      <h2>LS.025 ‚Äî Carpeta de Inicio</h2><div class="spacer"></div>
      <select id="ls-empresaSel" class="inp" style="max-width:220px"></select>
      <select id="ls-proyectoSel" class="inp" style="max-width:160px"></select>
      <select id="ls-rol" class="inp" style="max-width:180px">
        <option value="">Todos los bloques</option>
        <option value="SEG">Solo Seguridad</option>
        <option value="MA">Solo Medio Ambiente</option>
        <option value="RSE">Solo RSE</option>
      </select>
    </div>
    <div class="kpi" style="margin-top:8px">
      <div>Total √≠tems: <b id="k-ls-total">95</b></div>
      <div>‚ÄúS‚Äù: <b id="k-ls-s">0</b></div>
      <div>‚ÄúN‚Äù: <b id="k-ls-n">0</b></div>
      <div>‚ÄúNA‚Äù: <b id="k-ls-na">0</b></div>
      <div>Estado: <b id="k-ls-est" class="status parcial">PARCIAL</b></div>
    </div>
    <div id="ls-conflict" class="banner" style="display:none"></div>
    <div id="ls025-container" class="section"></div>
  </section>

  <section id="panel-personal" class="panel">
    <div class="row">
      <h2>Habilitaci√≥n de Personal</h2><div class="spacer"></div>
      <select id="per-empresaSel" class="inp" style="max-width:220px"></select>
      <select id="per-proyectoSel" class="inp" style="max-width:160px"></select>
    </div>

    <div class="section">
      <div class="row">
        <input id="per-nombre" class="inp" type="text" placeholder="Nombre del trabajador" style="max-width:280px"/>
        <input id="per-cargo" class="inp" type="text" placeholder="Cargo" style="max-width:200px"/>
        <input id="per-id" class="inp" type="text" placeholder="PersonaID (ej. PER-0456)" style="max-width:180px"/>
        <button class="btn" onclick="agregarPersona()">Agregar</button>
      </div>
      <div class="note">FS.100 aparece cuando ‚ÄúEx√°menes de Riesgo‚Äù = S en requisitos.</div>
    </div>

    <div style="overflow:auto;margin-top:8px">
      <table class="table" id="tabla-personal">
        <thead><tr><th>PersonaID</th><th>Nombre</th><th>Cargo</th><th>FS100</th><th>Apto</th><th>Completado</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="panel-vehiculos" class="panel">
    <div class="row">
      <h2>Habilitaci√≥n de Veh√≠culos</h2><div class="spacer"></div>
      <select id="veh-empresaSel" class="inp" style="max-width:220px"></select>
      <select id="veh-proyectoSel" class="inp" style="max-width:160px"></select>
    </div>

    <div class="section">
      <div class="row">
        <input id="veh-placa" class="inp" type="text" placeholder="Placa (ej. 1234-ABC)" style="max-width:160px"/>
        <input id="veh-marca" class="inp" type="text" placeholder="Marca" style="max-width:160px"/>
        <input id="veh-tipo" class="inp" type="text" placeholder="Tipo/Modelo/A√±o" style="max-width:220px"/>
        <input id="veh-id" class="inp" type="text" placeholder="VehiculoID (ej. VEH-1234ABC)" style="max-width:200px"/>
        <button class="btn" onclick="agregarVehiculo()">Agregar</button>
      </div>
    </div>

    <div style="overflow:auto;margin-top:8px">
      <table class="table" id="tabla-vehiculos">
        <thead><tr><th>VehiculoID</th><th>Placa</th><th>Marca</th><th>Tipo</th><th>Completado</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="panel-resumen" class="panel">
    <h2>Resumen / Snapshot</h2>
    <div class="row">
      <select id="res-empresaSel" class="inp" style="max-width:220px"></select>
      <select id="res-proyectoSel" class="inp" style="max-width:160px"></select>
    </div>
    <div class="row" style="margin-top:10px">
      <select id="rev-accion" class="inp" style="max-width:160px">
        <option>Revisi√≥n</option>
        <option>Recibido</option>
        <option>Devoluci√≥n</option>
      </select>
      <button class="btn" onclick="registrarAccion()">Registrar</button>
      <button class="btn secondary" onclick="notificarSiguiente()">Notificar a SST/MA/RSE</button>
    </div>
  <div id="resumen-content" class="section" style="margin-top:10px"></div>
  </section>
  <section id="panel-usuarios" class="panel">
    <h2>Personal Registrado (<span id="usuarios-count">0</span>)</h2>
    <div id="usuarios-cards" class="cards"></div>
  </section>
</div>

<!-- cierre main -->
</div>

<!-- Modales -->
<div class="modal" id="modal-persona">
  <div class="box">
    <div class="row"><h3>Editar Persona</h3><div class="spacer"></div><button class="btn ghost" onclick="cerrarModal('modal-persona')">Cerrar</button></div>
    <div id="persona-form"></div>
    <div class="sticky-actions"><button class="btn" onclick="cerrarModal('modal-persona')">Cerrar</button></div>
  </div>
</div>
<div class="modal" id="modal-vehiculo">
  <div class="box">
    <div class="row"><h3>Editar Veh√≠culo</h3><div class="spacer"></div><button class="btn ghost" onclick="cerrarModal('modal-vehiculo')">Cerrar</button></div>
    <div id="vehiculo-form"></div>
    <div class="sticky-actions"><button class="btn" onclick="cerrarModal('modal-vehiculo')">Cerrar</button></div>
  </div>
</div>

<button id="chat-ai-btn" class="no-print" style="display:none">ü§ñ Asistente iDavid</button>

<div id="chat-ai-container" class="no-print">
  <div id="chat-ai-header">
    Asistente iDavid
    <button id="chat-ai-close-btn">√ó</button>
  </div>
  <div id="chat-messages"></div>
  <div id="chat-ai-footer">
    <input type="text" id="chat-input" placeholder="Escribe tu pregunta aqu√≠..."/>
    <button id="chat-send-btn">Enviar</button>
  </div>
</div>

<script id="personal-data" type="text/plain">
Codigo,Nombre completo,Telefono,Correo electronico
1001,Gregorio Vasquez Cruz,,
1007,Grover Mendoza Loayza,6726,grover.mendoza@ypfbtransporte.com.bo
1010,Heraclio Maximinio Sardina Ortega,,heraclio.sardina@ypfbtransporte.com.bo
1025,Justo Willy Flores Hinojosa,,
1036,Susy Miranda Beck,6608,susy.miranda@ypfbtransporte.com.bo
1037,Omar Rodrigo Mollinedo Calderon,6672,omar.mollinedo@ypfbtransporte.com.bo
1038,Ricardo Montalvan Hurtado,6985,ricardo.montalvan@ypfbtransporte.com.bo
1041,Efrain Remy Padilla Martinez,,efrain.padilla@ypfbtransporte.com.bo
1042,Roger Parra Azuga,6782,roger.parra@ypfbtransporte.com.bo
1056,Nelson Vaca Vaca,6980,nelson.vaca@ypfbtransporte.com.bo
1061,Renan Yurquina Delfin,6879,renan.yurquina@ypfbtransporte.com.bo
1062,Freddy Susano Calizaya Lea√É¬±os,6153,freddy.calizaya@ypfbtransporte.com.bo
113,Mavel Bolivia Anaya Cordero,6120,mavel.anaya@ypfbtransporte.com.bo
121,Carlos Humberto Arancibia Balderrama,,carlos.arancibia@ypfbtransporte.com.bo
125,Johnny Jesus Arce Cisneros,,johnny.arce@ypfbtransporte.com.bo
131,Fernando Froilan Arostegui Garcia,,fernando.arostegui@ypfbtransporte.com.bo
145,Rene Federico Bleichner Melgar,,rene.bleichner@ypfbtransporte.com.bo
148,Dieter Ibori Borja Canedo,,dieter.borja@ypfbtransporte.com.bo
149,James Frans Borja Canedo,,james.borja@ypfbtransporte.com.bo
151,Lenny Buitrago Cruz,6150,lenny.buitrago@ypfbtransporte.com.bo
197,Edwin Sandro Cossio Limache,,edwin.cossio@ypfbtransporte.com.bo
200,Rose Marie Cuellar Casanova,6181,rosemarie.cuellar@ypfbtransporte.com.bo
223,Pedro Galindo Velasco,,
238,Wilfredo Guzman Perez,,wilfredo.guzman@ypfbtransporte.com.bo
263,Jesus Larrazabal Sanchez,6957,jesus.larrazabal@ypfbtransporte.com.bo
265,Walter Lea Plaza Vaca,,walter.lea.plaza@ypfbtransporte.com.bo
275,Limberth Lobo Velez,,
277,Fernando Carlos Lopez Garzotto,,carlos.lopez@ypfbtransporte.com.bo
282,Freddy Fernando Merida Pereira,6787,fernando.merida@ypfbtransporte.com.bo
301,Mario Mendoza Verduguez,,
302,Carlos Agustin Mendoza Eyzaguirre,6736,carlos.mendoza@ypfbtransporte.com.bo
305,Jorge Arturo Michel Camacho,,
323,Jeannette Corina Murillo Guzman,6951,jeannette.murillo@ypfbtransporte.com.bo
331,Rene Ordo√É∆í√Ç¬±ez Garcia,,
341,David Ovando Manuel,6546,david.ovando@ypfbtransporte.com.bo
348,Jose Marcelo Pardo Paniagua,,jpardo@ypfbtransporte.com.bo
350,Francisco Orlando Pati√É∆í√Ç¬±o Vargas,,orlando.patino@ypfbtransporte.com.bo
375,Patricia Silvia Rocha Borja,6401,patricia.rocha@ypfbtransporte.com.bo
385,Angel Rojas Padilla,6747,angel.rojas@ypfbtransporte.com.bo
389,Jose Gil Romero Aguirre,,
390,Carlos Romero Diaz,,carlos.romero@ypfbtransporte.com.bo
398,Vicente Salas Sensano,,
399,Carlos Salazar Mara√É∆í√Ç¬±on,,carlos.salazar@ypfbtransporte.com.bo
400,Susana Beatriz Salazar Rodriguez,6631,susana.salazar@ypfbtransporte.com.bo
406,Ruben Santander Arratia,,
408,Johnny Hugo Sardan Maldonado,6735,jhonny.sardan@ypfbtransporte.com.bo
419,Luis Carlos Soruco Benitez,,luis.soruco@ypfbtransporte.com.bo
439,Marcos Guillermo Vasquez Zarate,6145,marcos.vasquez@ypfbtransporte.com.bo
449,Elias Jhonny Vargas Mendoza,,
500,Felix Ovidio Quiroz Collazos,6450,felix.quiroz@ypfbtransporte.com.bo
505,Carmen Norah Moreno Villarroel,6550,carmen.moreno@ypfbtransporte.com.bo
519,Fernando Jhosef Zegarra Cuellar,6243,fernando.zegarra@ypfbtransporte.com.bo
528,Olver Guerra Corcuy,,olver.guerracorcuy@ypfbtransporte.com.bo
536,Franklin Padilla Arroyo,,franklin.padilla@ypfbtransporte.com.bo
537,Walter Romulo Justiniano Alpire,,walter.justiniano@ypfbtransporte.com.bo
538,Felix Aranibar Padilla,,
540,Luis Medina Cerrano,,luis.medina@ypfbtransporte.com.bo
543,Maria Paula Hurtado Rico,6070,paula.hurtado@ypfbtransporte.com.bo
546,Jesus Vasquez Chavez,,jesus.vasquez@ypfbtransporte.com.bo
550,Jesus Delin Arias,,jesus.delin@ypfbtransporte.com.bo
559,Ramon Luis Ricaldi Rossi,6828,ramon.ricaldi@ypfbtransporte.com.bo
572,Juan Carlos Iba√É∆í√Ç¬±ez Roug,6846,juan.c.ibanez@ypfbtransporte.com.bo
581,Marco Antonio Ampuero Calderon,6535,marco.ampuero@ypfbtransporte.com.bo
589,Silvia Giovanna Garcia Agreda Vargas,6526,giovanna.garcia-agreda@ypfbtransporte.com.bo
623,Jose Alberto Gutierrez Pardo,6074,jose.gutierrez@ypfbtransporte.com.bo
627,Willy Calvimontes Zenteno,,willy.calvimontes@ypfbtransporte.com.bo
628,Hernan Guzman Linarez,,
630,Jose Luis Hervoso Sossi,6179,joseluis.hervoso@ypfbtransporte.com.bo
631,Jhonny Rolando Chuquimia Quinteros,6720,jhonny.chuquimia@ypfbtransporte.com.bo
633,Manuel Lucas Conza Conza,6106,manuel.conza@ypfbtransporte.com.bo
636,Hernando Francisco Avila Lopez,6800,hernando.avila@ypfbtransporte.com.bo
644,Aldrin Ever A√É∆í√Ç¬±ez Castillo,6180,aldrin.anez@ypfbtransporte.com.bo
645,Jorge Emilio Dorado Nava,6786,jorge.dorado@ypfbtransporte.com.bo
648,Jimena Del Rosario Matny Saracho,6201,jimena.matny@ypfbtransporte.com.bo
655,Arturo Enrique Poppe Salvador,6763,arturo.poppe@ypfbtransporte.com.bo
657,Abraham Oscar Mercado Terrazas,6886,abraham.mercado@ypfbtransporte.com.bo
660,Sandro Morales Terrazas,6753,sandro.morales@ypfbtransporte.com.bo
661,Juan Jose Lagraba Pe√É∆í√Ç¬±aloza,6815,juan.lagraba@ypfbtransporte.com.bo
672,Boris Edwin Iporre Gonzales,6888,boris.iporre@ypfbtransporte.com.bo
673,Hector Efirio Almendras Luizaga,,
683,Fidel Jose Castro Ponce,5182,fidel.castro@ypfbtransporte.com.bo
685,Miguel Angel Villarroel Mendez,,
688,Mateo Ticona Calcina,6759,mateo.ticona@ypfbtransporte.com.bo
690,Lider Ovando Morales,,
700,Juan Yerko Alvarez Valda,,
703,Fernando Joaquin Parraga Ramirez,6953,fernando.parraga@ypfbtransporte.com.bo
709,Jose Luis Quintana Duran,,jose.quintana@ypfbtransporte.com.bo
725,Juan Carlos Mena Franco,,juancarlos.mena@ypfbtransporte.com.bo
726,Hebert Soleto Leon,6897,hebert.soleto@ypfbtransporte.com.bo
727,Jose Luis Ortiz Maraz,,jose.ortiz@ypfbtransporte.com.bo
731,Viviana Esther Lopez Fortun,6533,viviana.lopez@ypfbtransporte.com.bo
732,German Herrera Teran,6187,german.herrera@ypfbtransporte.com.bo
736,Ingrid Perrogon Suarez,6916,ingrid.perrogon@ypfbtransporte.com.bo
747,Ivan Meneses Rivero,6749,ivan.meneses@ypfbtransporte.com.bo
750,Yenny Guadalupe Rios Kempff,6612,yenny.rios@ypfbtransporte.com.bo
756,Elizabeth Viviana Angulo Calderon,6781,viviana.angulo@ypfbtransporte.com.bo
757,Luis Alberto Aponte Vaca,6524,luis.aponte@ypfbtransporte.com.bo
764,Carmen Lorena Hurtado A√É∆í√Ç¬±ez,6318,lorena.hurtado@ypfbtransporte.com.bo
768,Gustavo Cruz Barriga,6966,gustavo.cruz@ypfbtransporte.com.bo
777,Jose Rodrigo Manrique Castro,6808,jose.manrique@ypfbtransporte.com.bo
790,Raul Pradel Ramirez,6751,raul.pradel@ypfbtransporte.com.bo
791,Jorge Javier Rojas Arias,6885,jorge.rojas@ypfbtransporte.com.bo
792,Jorge Neill A√É∆í√Ç¬±ez Castillo,6733,neil.anez@ypfbtransporte.com.bo
793,Juan Carlos Guzman Garcia,6593,juancarlos.guzman@ypfbtransporte.com.bo
794,Margie Yanett Vargas Bueno,6307,janeth.vargas@ypfbtransporte.com.bo
796,Miguel Alejandro Viscarra Guillen,6849,miguel.viscarra@ypfbtransporte.com.bo
797,Bernardino Caral Calcina,6845,bernardino.caral@ypfbtransporte.com.bo
800,Rafael Oscar Camacho Calderon,,rafael.camacho@ypfbtransporte.com.bo
801,Carlos Fernando Caballero Morales,6710,carlos.caballero@ypfbtransporte.com.bo
803,Jimmy Fernando Muguertegui Torrico,6727,jimmy.muguertegui@ypfbtransporte.com.bo
804,Marcelo Antonio Rodriguez Cuellar,6813,marcelo.rodriguez@ypfbtransporte.com.bo
808,Julio Frey Saavedra Riojas,,julio.saavedra@ypfbtransporte.com.bo
809,Oscar Gonzalo Guevara Zuleta,6956,oscar.guevara@ypfbtransporte.com.bo
812,Wilson Terrazas Perez,6827,wilson.terrazas@ypfbtransporte.com.bo
815,Alfonso Marcelo Heredia Crespo,6712,alfonso.heredia@ypfbtransporte.com.bo
821,Fernando Lliully Davalos,,fernando.lliully@ypfbtransporte.com.bo
822,Dieter Rivera Porcel,6843,dieter.rivera@ypfbtransporte.com.bo
824,Adhemar Zapata Mendoza,6725,adhemar.zapata@ypfbtransporte.com.bo
825,Victor Eduardo Saldias Salas,,victor.saldias@ypfbtransporte.com.bo
826,Alex Emerson Andrade Pe√É∆í√Ç¬±aloza,,
827,Alejandro Montes Colque,,alejandro.montes@ypfbtransporte.com.bo
828,Guido Dario Alcaraz Rodriguez,,guido.alcaraz@ypfbtransporte.com.bo
829,Vladimir Mu√É∆í√Ç¬±oz Arevalo,,vladimir.munoz@ypfbtransporte.com.bo
831,Luis Alberto Villca Quispe,,luisalberto.villca@ypfbtransporte.com.bo
832,Gerson Roger Fuentes Ramirez,6298,gerson.fuentes@ypfbtransporte.com.bo
833,Never Arcibio Vides Navarro,6598,never.vides@ypfbtransporte.com.bo
835,Jorge Velasco Gutierrez,6724,jorge.velasco@ypfbtransporte.com.bo
837,Ruben Churqui Barrionuevo,,
842,Celman Eduardo Roca Zubieta,6875,celman.roca@ypfbtransporte.com.bo
844,Rosario Susana Mercado Armaza,6316,susana.mercado@ypfbtransporte.com.bo
845,Omar Ariel Garnica Moron,6757,ariel.garnica@ypfbtransporte.com.bo
851,Walter Flores Flores,6816,walter.flores@ypfbtransporte.com.bo
852,Mario Calvetty Angelo,6605,mario.calvetty@ypfbtransporte.com.bo
855,Boris Abdon Mu√É∆í√Ç¬±oz Vedia,6818,boris.munozvedia@ypfbtransporte.com.bo
856,Jose Richard Soto Mendez,,jose.soto@ypfbtransporte.com.bo
871,Roly Diaz Terrazas,,roly.diaz@ypfbtransporte.com.bo
874,Jose Irahola Paredes,6837,jose.irahola@ypfbtransporte.com.bo
875,Ernesto Vargas Flores,,
880,Wilfredo Mallon Mercado,6076,wilfredo.mallon@ypfbtransporte.com.bo
882,Daniel Ramiro Rejas Rechi,6836,daniel.rejas@ypfbtransporte.com.bo
886,Francisco Sandro Espada Zapata,6315,francisco.espada@ypfbtransporte.com.bo
891,Manfred Boris Mallcu Condori,,manfred.mallcu@ypfbtransporte.com.bo
893,Jhonn Gonzalo Zelaya Prudencio,,jhonn.zelaya@ypfbtransporte.com.bo
903,Isaac Ojeda Mamani,,isaac.ojeda@ypfbtransporte.com.bo
904,Roberth Willman Sandoval Arandia,6838,roberth.sandoval@ypfbtransporte.com.bo
905,Wilfredo Saucedo Mendez,,wilfredo.saucedo@ypfbtransporte.com.bo
908,Jorge Villegas Vidaurre,6135,jorge.villegas@ypfbtransporte.com.bo
909,Jorge Teodomiro Rocha Herbas,,jorge.rocha-herbas@ypfbtransporte.com.bo
914,Luz Melina Ordo√É∆í√Ç¬±ez Caballero,6854,melina.ordonez@ypfbtransporte.com.bo
915,Ricardo Montero Vasquez,,ricardo.montero@ypfbtransporte.com.bo
918,Roxana Banzer Gutierrez,6513,roxana.banzer@ypfbtransporte.com.bo
919,Leonel Dante Aguilera Sanchez,6983,leonel.aguilera@ypfbtransporte.com.bo
921,Jaime Gonzalo Guillen Rosales,6646,jaime.guillen@ypfbtransporte.com.bo
922,Luis Alberto Santander Saavedra,6174,luis.santander@ypfbtransporte.com.bo
924,Helder Cabrera Arteaga,6718,helder.cabrera@ypfbtransporte.com.bo
934,Hugo Quiroga Bonilla,6868,hugo.quiroga@ypfbtransporte.com.bo
935,Felix Basilio Cabrera,6425,felix.basilio@ypfbtransporte.com.bo
936,Javier Pablo Quisbert Flores,,javier.quisbert@ypfbtransporte.com.bo
937,Henry Orlando Aguilar Acha,,henry.aguilar@ypfbtransporte.com.bo
941,Jorge Alberto Ordo√É∆í√Ç¬±ez Soruco,6773,jorge.ordonez@ypfbtransporte.com.bo
942,Ives Taboada Ya√É∆í√Ç¬±ez,,ives.taboada@ypfbtransporte.com.bo
943,Jesus Herbas Ortega,,jesus.herbas@ypfbtransporte.com.bo
945,Mario Erlan Cortez Ortiz,6842,mario.cortez@ypfbtransporte.com.bo
949,Juan Paz Medina,,
950,Edwin Mario Kaune Cabrera,6806,mario.kaune@ypfbtransporte.com.bo
951,Victor Vaca Veliz,,
952,Carlos Esteban Caballero Vargas,6723,carlosesteban.caballero@ypfbtransporte.com.bo
954,David Jimenez Rivero,6126,david.jimenez@ypfbtransporte.com.bo
958,Rolando Huanca Torrez,,rolando.huanca@ypfbtransporte.com.bo
959,Leny Melgar Castedo,6326,leny.melgar@ypfbtransporte.com.bo
961,Othoniel Enrique Corona Salcedo,6880,othoniel.corona@ypfbtransporte.com.bo
964,Gonzalo Mollo Montoya,,
967,Candido Rodolfo Cossio Camacho,,rodolfo.cossio@ypfbtransporte.com.bo
969,Vladimir Aldo Mendivil Bejarano,6673,vladimir.mendivil@ypfbtransporte.com.bo
971,Enrique Avelino Herrera Alpire,6834,enrique.herrera@ypfbtransporte.com.bo
972,Jose Luis Fernandez Sequeiros,,
974,Edwin Isaac Loayza Murga,,eloayza@ypfbtransporte.com.bo
975,Rolando Alvaro Urjel Toledo,,
976,Paul Sanchez Bazoberry,,paul.sanchez@ypfbtransporte.com.bo
978,Juan Corrales Choque,,juan.corrales@ypfbtransporte.com.bo
980,Manuel Aldo Davila Garcia,6778,manuel.davila@ypfbtransporte.com.bo
981,Herberth Cerezo Zambrana,,herberth.cerezo@ypfbtransporte.com.bo
982,Paul Selman Portillo Ferrufino,,paul.portillo@ypfbtransporte.com.bo
986,David Calizaya Cruz,,
987,Delicio Calizaya Cruz,,delicio.calizaya@ypfbtransporte.com.bo
988,Jaime Portugal Zeballos,6264,jaime.portugal@ypfbtransporte.com.bo
990,Juan Pablo Alberto Pino Frerking,6273,juanpablo.pino@ypfbtransporte.com.bo
991,Roger Antonio Hurtado Arias,,roger.hurtado@ypfbtransporte.com.bo
992,Alcides Llanque Choque,,alcides.llanque@ypfbtransporte.com.bo
993,Maria Esther Porras Calderon,6721,maria.porras@ypfbtransporte.com.bo
995,Manuel Rojas Terceros,6596,manuel.rojas@ypfbtransporte.com.bo
996,Jesus Mendoza Rioja,6594,jesus.mendoza@ypfbtransporte.com.bo
997,Ezequiel Marvin Barrientos Alba,6592,marvin.barrientos@ypfbtransporte.com.bo
999,Luis Fernando Bohorquez Torrez,6591,luis.bohorquez@ypfbtransporte.com.bo
1001,Gregorio Vasquez Cruz,,
1007,Grover Mendoza Loayza,6726,grover.mendoza@ypfbtransporte.com.bo
1010,Heraclio Maximinio Sardina Ortega,,heraclio.sardina@ypfbtransporte.com.bo
1025,Justo Willy Flores Hinojosa,,
1036,Susy Miranda Beck,6608,susy.miranda@ypfbtransporte.com.bo
1037,Omar Rodrigo Mollinedo Calderon,6672,omar.mollinedo@ypfbtransporte.com.bo
1038,Ricardo Montalvan Hurtado,6985,ricardo.montalvan@ypfbtransporte.com.bo
1041,Efrain Remy Padilla Martinez,,efrain.padilla@ypfbtransporte.com.bo
1042,Roger Parra Azuga,6782,roger.parra@ypfbtransporte.com.bo
1056,Nelson Vaca Vaca,6980,nelson.vaca@ypfbtransporte.com.bo
1061,Renan Yurquina Delfin,6879,renan.yurquina@ypfbtransporte.com.bo
1062,Freddy Susano Calizaya Lea√É∆í√Ç¬±os,6153,freddy.calizaya@ypfbtransporte.com.bo
1065,Henry Eugenio Meruvia Espinoza,,
1067,Jackeline Paz Soldan Quintela,6185,jackelin.pazsoldan@ypfbtransporte.com.bo
1075,Angel Marcelo Cuba Casta√É∆í√Ç¬±os,,angel.cuba@ypfbtransporte.com.bo
1081,Freddy Lopez Vasquez,,freddy.lopez@ypfbtransporte.com.bo
1082,Daniel Morales Casso,6978,daniel.morales@ypfbtransporte.com.bo
1102,Vivian Aponte Ribera,6442,vivian.aponte@ypfbtransporte.com.bo
1107,Luis Fernando Armas,6890,luisfernando.armas@ypfbtransporte.com.bo
1110,Jose Luis Genaro Auza Cortes,6762,joseluis.auza@ypfbtransporte.com.bo
1125,Marcos Fernando Camacho Fernandez,6896,marcos.camacho@ypfbtransporte.com.bo
1128,Marcelo Canavire Castillo,6797,marcelo.canavire@ypfbtransporte.com.bo
1133,Alvaro Luis Castro Pary,6878,alvaro.castro@ypfbtransporte.com.bo
1176,Ernesto Laime Condori,6251,ernesto.laime@ypfbtransporte.com.bo
1182,Pablo Lizarraga Zamora,,
1289,Victor Grover Quispe Adrian,6738,victor.quispe@ypfbtransporte.com.bo
1295,Freddy Mariano Aguilera Paz,6975,mariano.aguilera@ypfbtransporte.com.bo
1297,Juan Carlos Landivar Jimenez,6552,carlos.landivar@ypfbtransporte.com.bo
1305,Adhemar Zu√É∆í√Ç¬±agua Flores,,adhemar.zunagua@ypfbtransporte.com.bo
1320,Jose Domingo Justiniano Suarez,6894,domingo.justiniano@ypfbtransporte.com.bo
2166,Johannes Francisco Valdivia Sarria,,johannes.valdivia@ypfbtransporte.com.bo
2169,Pablo Freddy Rodriguez Lafuente,,pablo.rodriguez@ypfbtransporte.com.bo
2177,Pablo Huaylla Eyzaguirre,,pablo.huaylla@ypfbtransporte.com.bo
2178,Luis Rolando Martinez Mita,,luis.martinez@ypfbtransporte.com.bo
2180,Orlando Vladimir Vedia Michel,6790,orlando.vedia@ypfbtransporte.com.bo
2181,Albaro Felix Forteza Rosales,6193,albaro.forteza@ypfbtransporte.com.bo
2185,Victor Humberto Lozada,,victor.lozada@ypfbtransporte.com.bo
2189,Carlos Bautista Camacho,,
30119,Juan De Dios Roca Callejas,6841,juandedios.roca@ypfbtransporte.com.bo
30164,David Milton Vega Mu√É∆í√Ç¬±oz,6228,david.vega@ypfbtransporte.com.bo
30165,Omar Felix Calderon Sanchez,,
30174,Maria Olivia Lafuente Mendez,6554,olivia.lafuente@ypfbtransporte.com.bo
30183,Rosita Ferreira Ardaya,6901,rosita.ferreira@ypfbtransporte.com.bo
30734,Norberto Wily Catari Bautista,6717,norberto.catari@ypfbtransporte.com.bo
30838,Virgilio Alvaro Suca Gutierrez,,virgilio.suca@ypfbtransporte.com.bo
30923,Jhones Vargas Urdininea,6832,jhones.vargas@ypfbtransporte.com.bo
30964,Nelda Isabel A√É∆í√Ç¬±ez Mustafa,6711,nelda.anez@ypfbtransporte.com.bo
30967,Remy Victor Cespedes Cors,,
30969,Marvin Guerrero Padilla,6175,marvin.guerrero@ypfbtransporte.com.bo
30970,Rider Arauz Rego,6075,rider.arauz@ypfbtransporte.com.bo
30977,Juan Marcelo Suarez Guillaux,6527,marcelo.suarez@ypfbtransporte.com.bo
30978,David Adonay Crespo Cuellar,,david.crespo@ypfbtransporte.com.bo
30979,Alberto Daniel Toyama Oshiro,6630,alberto.toyama@ypfbtransporte.com.bo
30985,Steve Alex Riveros Vogtschmidt,6321,steve.riveros@ypfbtransporte.com.bo
30986,Rossdely Salvatierra Eguez,6521,rossdely.salvatierra@ypfbtransporte.com.bo
30996,Gustavo Guzman Coca,6666,gustavo.guzman@ypfbtransporte.com.bo
31004,Rene Jorge Echavarria Arancibia,,
31006,Carlos Fernando Paz Vargas,6932,carlos.paz@ypfbtransporte.com.bo
31010,Marcelo Alejandro Mena Navarro,6970,marcelo.mena@ypfbtransporte.com.bo
31018,Javier Agreda Farrell,,javier.agreda@ypfbtransporte.com.bo
31019,Adel Jorge Sasamoto Monta√É∆í√Ç¬±o,6508,adel.sasamoto@ypfbtransporte.com.bo
31021,Claudia Paola Saucedo Jimenez,6317,claudia.saucedo@ypfbtransporte.com.bo
31028,David Damian Cespedes Ramirez,6936,david.cespedes@ypfbtransporte.com.bo
31035,Fatima Daria Zabala Flores,6614,fatima.zabala@ypfbtransporte.com.bo
31040,Juan Pablo Reinoso Uzeda,6671,juan.reinoso@ypfbtransporte.com.bo
31049,Raul Flores Osinaga,6900,raul.flores@ypfbtransporte.com.bo
31055,Narcizo Sanchez Cuellar,6449,narcizo.sanchez@ypfbtransporte.com.bo
31068,Fernando Rios,,fernando.rios@ypfbtransporte.com.bo
31069,Freddy Daniel Gambarte Rivera,6867,daniel.gambarte@ypfbtransporte.com.bo
31072,Lucas Damian Audivert Gutierrez,6748,lucas.audivert@ypfbtransporte.com.bo
31083,Prospero Peres Ochoa,6764,prospero.peres@ypfbtransporte.com.bo
31084,Mauricio Duran Cruz,6752,mauricio.duran@ypfbtransporte.com.bo
31086,Franco Luis Pizarroso Monasterio,6986,franco.pizarroso@ypfbtransporte.com.bo
31087,Julio Yucra Lea√É∆í√Ç¬±os,,julio.yucra@ypfbtransporte.com.bo
31101,Marco Antonio Bustamante Camacho,,marco.bustamante@ypfbtransporte.com.bo
31102,Ivo Americo Rivero Mendez,,ivo.rivero@ypfbtransporte.com.bo
31108,Gregory Reynold Bustamante Rojas,,
31109,Christian Frederich Eulert Mendoza,6937,christian.eulert@ypfbtransporte.com.bo
31112,Giovanny Helmuth Mendoza Rocabado,6855,giovanny.mendoza@ypfbtransporte.com.bo
31124,Nelson Marcelo Quispe Zuna,6451,nelson.quispe@ypfbtransporte.com.bo
31126,Claudia Ines Delfin Auza,6765,claudia.delfin@ypfbtransporte.com.bo
31137,Rafael Flavio Duran Moran,,rafael.duran@ypfbtransporte.com.bo
31141,Bladimir Lara Berdeja,6128,bladimir.lara@ypfbtransporte.com.bo
31143,Raul Rigoberto Roque Yujra,6743,raul.roque@ypfbtransporte.com.bo
31145,Jaime Condori Huanaco,,jaime.condori@ypfbtransporte.com.bo
31148,Israel Tapia Pereira,6730,israel.tapia@ypfbtransporte.com.bo
31149,Abel Jaime Ramos Beltran,,abel.ramos@ypfbtransporte.com.bo
31151,Gustavo Garcia Mu√É∆í√Ç¬±oz,,gustavo.garcia@ypfbtransporte.com.bo
31155,Freddy Apala Flores,6835,freddy.apala@ypfbtransporte.com.bo
31164,Jose Dorado Rodriguez,6981,jose.dorado@ypfbtransporte.com.bo
31168,Sergio Jorge Serrano Garrett,6308,sergio.serrano@ypfbtransporte.com.bo
31177,Gabriela Janine Antelo Guillen,6266,gabriela.antelo@ypfbtransporte.com.bo
31179,Felix Zarate Copa,6183,felix.zarate@ypfbtransporte.com.bo
31182,Adalid Gustavo Aguanta Choque,,adalid.aguanta@ypfbtransporte.com.bo
31183,Jhon Oliver Medrano Garcia,,
31185,Florencio Gutierrez Arteaga,6982,florencio.gutierrez@ypfbtransporte.com.bo
31187,Esteban Ayala Quiroga,6542,esteban.ayala@ypfbtransporte.com.bo
31194,Elena Sarmiento Hernandez,6222,elena.sarmiento@ypfbtransporte.com.bo
31204,Alexander Farel Saldias,,alexander.farel@ypfbtransporte.com.bo
31211,Eliseo Callapa Quispe,,
31212,Marcos Daniel Lavezzo,,marcos.lavezzo@ypfbtransporte.com.bo
31213,Armin Mendez Mamani,6839,armin.mendez@ypfbtransporte.com.bo
31214,Juan Pablo Bejarano Lopez,,
31216,Huascar Cespedes Fernandez,,huascar.cespedes@ypfbtransporte.com.bo
31217,Edwin Flores Laguna,,edwin.flores@ypfbtransporte.com.bo
31219,Victor Alfonso Rojas Saavedra,,
31248,Cristian Alex Portugal Leon,6241,alex.portugal@ypfbtransporte.com.bo
31249,Elvys Reynaldo Aramayo Villca,,elvys.aramayo@ypfbtransporte.com.bo
31253,Ikaro Simoes De Souza Pinto,6976,ikaro.simoes@ypfbtransporte.com.bo
31264,Clodomyr Marcelo Tordoya Melgares,,marcelo.tordoya@ypfbtransporte.com.bo
31268,Federico Jose Escobar Rivera,,fescobar@ypfbtransporte.com.bo
31270,Ivan Humberto Paredes Kohlberg,6242,ivan.paredes@ypfbtransporte.com.bo
31292,Carlos Manuel Richter Birbuet,6683,carlos.richter@ypfbtransporte.com.bo
31293,Seferino Huanca Silva,,
31300,Claudia Cecilia Serrano Zambrana,6798,claudia.serrano@ypfbtransporte.com.bo
31301,Hugo Cesar Alcazar Leyton,6640,hugo.alcazar@ypfbtransporte.com.bo
31302,Alberto Mendez Rodriguez,6267,alberto.mendez@ypfbtransporte.com.bo
31309,Herland Silvestre Lara Katimi,6262,herlan.lara@ypfbtransporte.com.bo
31311,Henrry Becerra Claure,,henrry.becerra@ypfbtransporte.com.bo
31316,Rafael Barrios Poma,6647,rafael.barrios@ypfbtransporte.com.bo
31318,Yamil Dillman Flores Leon,6661,yamil.flores@ypfbtransporte.com.bo
31324,Samuel Peredo Claros,6648,samuel.peredo@ypfbtransporte.com.bo
31325,Jose Enoc Marin Anivarro,6684,jose.marin@ypfbtransporte.com.bo
31329,Marco Antonio Gareca Guthrie,,marco.gareca@ypfbtransporte.com.bo
31341,Renee Fernando Caballero Moscoso,,fernando.caballero@ypfbtransporte.com.bo
31342,Anibal Palenque Cardenas,,anibal.palenque@ypfbtransporte.com.bo
31344,Nelo Yhosser Mu√É∆í√Ç¬±oz Salazar,,nelo.munoz@ypfbtransporte.com.bo
31347,Maria Luisa Sanchez De Lozada Aranibar,6413,maria.sanchez@ypfbtransporte.com.bo
31350,Kathia Emily De La Quintana Lara,6701,kathia.delaquintana@ypfbtransporte.com.bo
31351,Williams Antonio Cabrera Alarcon,,william.cabreraalarcon@ypfbtransporte.com.bo
31367,Ruth Elizabeth Padilla Valero,,ruth.padilla@ypfbtransporte.com.bo
31373,Ernesto Delgadillo Vargas,6784,ernesto.delgadillo@ypfbtransporte.com.bo
31376,Carolina Viera Correa,6452,carolina.viera@ypfbtransporte.com.bo
31381,Abel Casassa Mercado,6857,abel.casassa@ypfbtransporte.com.bo
31393,Victor Hugo Ortiz Choque,,victor.ortiz@ypfbtransporte.com.bo
31396,Rodrigo Arrien Zamora,6915,rodrigo.arrien@ypfbtransporte.com.bo
31398,Edgar Arsenio Zapata Suarez,6300,edgar.zapata@ypfbtransporte.com.bo
31399,Isabel Teresinna Rioja De La Via,6323,isabel.rioja@ypfbtransporte.com.bo
31400,Luis Eduardo Coca Trujillo,6275,luis.coca@ypfbtransporte.com.bo
31400,Luis Eduardo Coca Trujillo,6884,luis.coca@ypfbtransporte.com.bo
31401,Santiago Ricardo Paz Revollo,6641,santiago.paz@ypfbtransporte.com.bo
31402,Aracely Villarroel Ayllon,6766,aracely.villarroel@ypfbtransporte.com.bo
31409,Mario Uzeda Hurtado,,
31413,Alejandro Lionel Merino Almaraz,6173,alejandro.merino@ypfbtransporte.com.bo
31415,Giovanni Rojas Mojica,6768,giovanni.rojas@ypfbtransporte.com.bo
31417,Ademar Vargas Quintela,6288,ademar.vargas@ypfbtransporte.com.bo
31419,Marcos Antonio Vargas Romero,,marcos.vargas@ypfbtransporte.com.bo
31425,Elthon Gumiel Guerrero,,
31426,Paolo Cesar Mendieta Dias De Oropeza,,paolo.mendieta@ypfbtransporte.com.bo
31427,Edgar Canelas Jaimes,,
31433,Donald Ivan Ventura Sanchez,6862,ivan.ventura@ypfbtransporte.com.bo
31436,Ariel Reynaldo Callpa Cayo,6143,ariel.callpa@ypfbtransporte.com.bo
31438,Gregorio Gongora Zabala,,gregorio.gongora@ypfbtransporte.com.bo
31440,Rodolfo Claros Lujan,,rodolfo.claros@ypfbtransporte.com.bo
31441,Lourdes Katherine Barba Moreno,6518,katherine.barba@ypfbtransporte.com.bo
31442,Juan Edison Aranibar Ortu√É∆í√Ç¬±o,,juan.aranibar@ypfbtransporte.com.bo
31443,Jorge Martin Belmonte Aguilar,6792,jorge.belmonte@ypfbtransporte.com.bo
31451,Miguel Angel Bustos Soliz,,miguel.bustos@ypfbtransporte.com.bo
31455,Edwin Anibal Ramirez Teran,6132,edwin.ramirez@ypfbtransporte.com.bo
31474,Oscar Armando Iraola Orias,6660,oscar.iraola@ypfbtransporte.com.bo
31475,Leila Yushenka Mercedes Cortez Perez,6979,leila.cortez@ypfbtransporte.com.bo
31476,Jose Daniel Parada Tababary,,
31479,Hildegard Valeria Escobar Reque,6447,hildegard.escobar@ypfbtransporte.com.bo
31480,Alvaro Romero Salazar,6512,alvaro.romero@ypfbtransporte.com.bo
31482,Carlos Marcelo Perales Henrich,6511,marcelo.perales@ypfbtransporte.com.bo
31487,Francisco Javier Grock Pereira,6314,francisco.grock@ypfbtransporte.com.bo
31489,Claudia Liseth Sanchez Justiniano,6545,claudia.sanchez@ypfbtransporte.com.bo
31492,Pablo Rodrigo Moron Jimenez,,
31495,Raul Diego Quispe Rivero,6769,raul.quispe@ypfbtransporte.com.bo
31498,Melody Matny Soliz,6224,melody.matny@ypfbtransporte.com.bo
31501,Jorge Antonio Rocabado Dantas,,jorge.rocabado@ypfbtransporte.com.bo
31502,Jorge Alexander Vargas Moscoso,,jorge.vargas@ypfbtransporte.com.bo
31504,Omar Cristian Cuellar Sanchez,6883,omar.cuellar@ypfbtransporte.com.bo
31507,Lorena Marcela Hernandez Bellido,6232,lorena.hernandez@ypfbtransporte.com.bo
31514,Alejandro Mercado Bravo,6677,alejandro.mercado@ypfbtransporte.com.bo
31518,Cledy Lizet Cardozo Revollo,6799,cledy.cardozo@ypfbtransporte.com.bo
31524,Jorge Cuellar Gutierrez,6477,jorge.cuellar@ypfbtransporte.com.bo
31526,Juan Carlos Choquilla Mamani,,juan.choquilla@ypfbtransporte.com.bo
31533,Jesus Alberto Nu√É∆í√Ç¬±ez Mendoza,,jesus.nunez@ypfbtransporte.com.bo
31534,Jesus Orlando Salazar Montero,,orlando.salazar@ypfbtransporte.com.bo
31535,Aurelio Cespedes Arauz,,aurelio.cespedes@ypfbtransporte.com.bo
31537,Carlos Javier Vidal Torrico,6817,carlos.vidal@ypfbtransporte.com.bo
31538,Herman Arauz Pe√É∆í√Ç¬±a,,herman.arauz@ypfbtransporte.com.bo
31540,Saul Zurita A√É∆í√Ç¬±ez,,saul.zurita@ypfbtransporte.com.bo
31542,Edwin Reynaldo Pomarayme Miranda,,edwin.pomarayme@ypfbtransporte.com.bo
31544,Jesus Javier Soto Huerta,6873,jesus.soto@ypfbtransporte.com.bo
31550,Jorge Antonio Serna Ayala,6876,jorge.serna@ypfbtransporte.com.bo
31564,Wilber Alexis Correa Salguero,,
31565,Kevin Hancel Aleman Orellana,,
31566,Werner Aquezolo Villarroel,,werner.aquezolo@ypfbtransporte.com.bo
31569,Carlos Richard Cardona Lino,6939,richard.cardona@ypfbtransporte.com.bo
31570,Andres Jacinto Rodriguez Alarcon,6324,andres.rodriguez@ypfbtransporte.com.bo
31584,Vania Esther Ferrufino Alvarez,6538,vania.ferrufino@ypfbtransporte.com.bo
31586,Eliana Cecilia Rivero Perez,6418,cecilia.rivero@ypfbtransporte.com.bo
31587,Gabriela Farell Osinaga,6258,gabriela.farell@ypfbtransporte.com.bo
31595,Elbis Bonilla Cabrera,,
31599,Hammer Nivardo Castro Saavedra,,hcastro@ypfbtransporte.com.bo
31613,Juan Carlos Davalos Guerrero,,juan.davalos@ypfbtransporte.com.bo
31621,Juan Pablo Marquez Soria,6607,juan.marquez@ypfbtransporte.com.bo
31626,Felix Ismael Eid Chalan,6311,felix.eid@ypfbtransporte.com.bo
31629,Jessica Vera Guzman,6414,jessica.vera@ypfbtransporte.com.bo
31630,Maria Elena Guzman Lopez,6444,elena.guzman@ypfbtransporte.com.bo
31631,David Angel Machaca Pereyra,6977,david.machaca@ypfbtransporte.com.bo
31636,Franz Reinaldo Orosco Caceres,6367,franz.orosco@ypfbtransporte.com.bo
31646,Oscar Vigabriel Camacho,6889,oscar.vigabriel@ypfbtransporte.com.bo
31648,Jorge Marcelo Laime Buezo,,
31651,Pedro Leigue Aroni,6078,pedro.leigue@ypfbtransporte.com.bo
31652,Johnny Darwin Contreras Sanchez,6984,jhonny.contreras@ypfbtransporte.com.bo
31654,Juan Hugo Titirico Apaza,,jtitirico@ypfbtransporte.com.bo
31657,Leonardo Cuellar Jovio,,
31664,Arnold Dario Arancibia Siles,6212,arnold.arancibia@ypfbtransporte.com.bo
31666,Limber Jair Lamas Soto,6856,limber.lamas@ypfbtransporte.com.bo
31667,Mario Alan Jimmy Osaki Llanos,6618,jimmy.osaki@ypfbtransporte.com.bo
31670,Juan Carlos Maturano Ferrufino,,juan.maturano@ypfbtransporte.com.bo
31674,Julio Cesar Quezada Ferrufino,,
31676,Alejandro Borda Ferrufino,,aborda@ypfbtransporte.com.bo
31678,Daniel Solares Tellez,6871,daniel.solares@ypfbtransporte.com.bo
31680,Ronald Reyes Gonzales,6973,ronald.reyes@ypfbtransporte.com.bo
31681,Miguel Angel Torrico Andia,,
31682,Diego Rafael Anaya Leigue,,diego.anaya@ypfbtransporte.com.bo
31683,Jaime Enrique Sanabria Yepes,,enrique.sanabria@ypfbtransporte.com.bo
31685,Nery Einar Villegas Cruz,,nvillegas@ypfbtransporte.com.bo
31687,Ariel Coca Avila,,
31697,Ruddy Benedicto Guzman Villarroel,6125,rudy.guzman@ypfbtransporte.com.bo
31702,Freddy Orias Gonzales,6539,freddy.orias@ypfbtransporte.com.bo
31705,Franz Abel Alanes Mallco,6758,franz.alanes@ypfbtransporte.com.bo
31709,Wendy Sisy Echeverria Soliz,6301,wendy.echeverria@ypfbtransporte.com.bo
31710,Rolando Mamani Alberto,,rmamani@ypfbtransporte.com.bo
31721,Sofia Esther Oporto Vargas,6226,sofia.oporto@ypfbtransporte.com.bo
31737,Erick Reynaldo Vaca Quiroga,,
31738,Edith Ramirez Vidaurre,6586,edith.ramirez@ypfbtransporte.com.bo
31751,Jeanine Pe√É∆í√Ç¬±a Sosa,6061,jeanine.pena@ypfbtransporte.com.bo
31762,Valeria Stephanie Dominguez Gallo,6274,valeria.dominguez@ypfbtransporte.com.bo
31770,Luis Fernando Pe√É∆í√Ç¬±arrieta Oropeza,6934,fernando.penarrieta@ypfbtransporte.com.bo
31775,Nibetzy Sosa Ayaviri,6776,nibetzy.sosa@ypfbtransporte.com.bo
31781,Grover Escalera Quinteros,6530,grover.escalera@ypfbtransporte.com.bo
31787,Bladimir Roberto Vallejos Armas,6770,bladimir.vallejos@ypfbtransporte.com.bo
31800,Richard Ibert Rojas Sarabia,6887,richard.rojas@ypfbtransporte.com.bo
31801,Fabiola Cespedes Cossio,6543,fabiola.cespedes@ypfbtransporte.com.bo
31803,Jairo Kivertt Olguin Centellas,6783,jairo.olguin@ypfbtransporte.com.bo
31804,Ingrid Arredondo Torrico,6507,ingrid.arredondo@ypfbtransporte.com.bo
31814,Jose Rojas Soliz,6791,jose.rojas@ypfbtransporte.com.bo
31815,Niceforo Camaque Baldiviezo,,niceforo.camaque@ypfbtransporte.com.bo
31816,Anacleto Rojas Coca,,
31817,Jhonny Marcos Zenteno Castro,,
31818,Sebastian Paco Gomez,,
31819,Milton Garcia Rojas,,milton.garciarojas@ypfbtransporte.com.bo
31825,Freddy Marcos Arias Mercado,,
31826,Favian Yucra Kuiro,,
31828,Luis Alberto Hoyos Camacho,,
31829,Fidel Herbas Ledezma,,
31832,Basilio Sarzuri Catari,,
31834,Efrain Pe√É∆í√Ç¬±arrieta Marquina,,
31835,Ponciano Leon Cuico,,
31836,Lucio Villca Choque,,
31837,Maximo Gutierrez Mejia,,
31838,Costo Ledezma Quiroga,,
31840,Abel Guzman Monta√É∆í√Ç¬±o,,
31841,Windzor Roque Caizana,,
31842,Emilio Lima Pari,,
31844,Eliseo Flores Mercado,,
31845,German Arrieta Escalante,,
31846,Juan Padilla Jaqui,,
31847,Rodolfo Maldonado Fuentes,,
31850,Hilton Warnes Torrico,,hilton.warnes@ypfbtransporte.com.bo
31851,Angel Carriazo Ballesteros,,
31852,Wilson Garcia Garcia,,wilson.garciagarcia@ypfbtransporte.com.bo
31854,Marco Antonio Peralta Albornoz,,
31855,Ovidio Mamani Matias,,
31856,Augusto Palacios Mollinedo,,
31857,Edgar Aranibar Lazo,,
31859,Teodoro Cruz Gutierrez,,teodoro.cruz@ypfbtransporte.com.bo
31861,Gualberto Villarroel Vallejos,,
31862,Damian Fernandez Morales,,
31863,Jose Hernan Ovando Mendez,,
31864,Maximo Heredia Torrico,,
31866,Samuel Porfirio Tancara Vino,,
31868,German Olivera Rocabado,,
31869,Jose Luis Almanza Escobar,,
31870,Flaviano Gutierrez Diaz,,
31871,Alfredo Sansuste Gonzales,,
31872,Filomon Paniagua Vasquez,,
31873,Teodoro Salazar Vargas,,
31874,Benedicto Perez Cruz,,
31876,Alfredo Cano Leon,,
31879,Elvis Jhomsson Gonzales Miqui,,elvis.gonzales@ypfbtransporte.com.bo
31880,Emilio Cadima Luna,,
31883,Jose Miguel Rodriguez Arce,,jose.rodriguez@ypfbtransporte.com.bo
31884,Sergio Rene Colbert Morales,,
31885,Yersson Bazoalto Nogales,,
31886,Sevelio Miguel Coca Gonzales,,
31887,Eliseo Huayta Calizaya,,
31890,Sergio Rocha Alegre,,
31891,Esteban Garcia Espinoza,,
31892,Liborio Guzman Rendon,,
31895,Josimar Camacho Balderrama,,josimar.camacho@ypfbtransporte.com.bo
31896,Oscar Miguel Gorritti Vera,,
31897,Seul Alberto Huarachi Choque,,
31900,Carmen Julia Rojas Borja,6246,carmen.rojasborja@ypfbtransporte.com.bo
31905,Fabiana Beatriz Boiano,6617,fabiana.boiano@ypfbtransporte.com.bo
31907,Luis Carlos Terrazas Velasquez,,
31908,Victor Hugo Ventura Burgos,,victor.ventura@ypfbtransporte.com.bo
31953,Paola Karina Villarroel Oropeza,6851,paola.villarroel@ypfbtransporte.com.bo
31999,Miguel Daguino Ayala,,
32006,Juan Jose Francisco Soria Vattuone,6670,juanjose.soria@ypfbtransporte.com.bo
32017,Celestino Rojas Olivera,,
32019,Max David Rosas Mendez,,max.rosas@ypfbtransporte.com.bo
32020,Fortunato Sacaico Cuico,,
32021,Maximo Zapata Salazar,,
32022,Vladimir Roberto Hinojosa Vasquez,,vladimir.hinojosa@ypfbtransporte.com.bo
32023,Martin Flores Aduviri,,
32024,Lohe Lorhen Luna Encinas,,
32025,Abrahan Escobar Galarza,,
32026,Franco Romero Ordo√É∆í√Ç¬±ez,,franco.romero@ypfbtransporte.com.bo
32028,Ronald Albert Cordero Vera,6814,ronald.cordero@ypfbtransporte.com.bo
32029,Alexander Machuca Franco,6974,alexander.machucafranco@ypfbtransporte.com.bo
32061,Alvaro Astoraque Duran,,
32064,Gary Edson Crespo,,gary.crespo@ypfbtransporte.com.bo
32070,Ruth Miriam Salazar Caceres,6988,ruth.salazar@ypfbtransporte.com.bo
32075,Leodan Romero Sierra,,
32076,Miguel Angel Melcon Sanchez,6812,miguel.melcon@ypfbtransporte.com.bo
32077,Luis Eduardo Uriona Reyes,,
32078,Jesus Alberto Salazar Leon,,
32079,Carlos Alberto Carrasco Gil,,carlos.carrasco@ypfbtransporte.com.bo
32081,Marioly Paola Duran Zarate,6191,marioly.duran@ypfbtransporte.com.bo
32104,Iverth Angel Limache Mier,,
32106,Jose Inchausti Salinas,,jose.inchausti@ypfbtransporte.com.bo
32116,Edwin Rodriguez Mercado,,
32117,Alvaro Erick Bejarano Zarate,,alvaro.bejarano@ypfbtransporte.com.bo
32118,Juan Carlos Crespo Gutierrez,,juan.crespo@ypfbtransporte.com.bo
32124,Antonio Manuel Rojas Salguero,6265,antonio.rojas@ypfbtransporte.com.bo
32128,Hector Rolando Reque Coaquira,6146,rolando.reque@ypfbtransporte.com.bo
32130,Wilfredo Negrette Becerra,6514,wilfredo.negrette@ypfbtransporte.com.bo
32131,Andres Zeballos Chocomani,,
32133,Maria Yolanda Jimenez Zambrana,6079,yolanda.jimenez@ypfbtransporte.com.bo
32134,Ramiro Moises Ordo√É∆í√Ç¬±ez Ari√É∆í√Ç¬±ez,6416,ramiro.ordonez@ypfbtransporte.com.bo
32135,Emilio Guzman Mancilla,,
32136,Guido Emilio Farfan Espinoza,6255,guido.farfan@ypfbtransporte.com.bo
32137,Geronimo Pedrozo Franco,6794,geronimo.pedrozo@ypfbtransporte.com.bo
32138,Charles Willains Chavez Cardozo,6803,charles.chavez@ypfbtransporte.com.bo
32139,Diego Jhoan Delgadillo Moreira,6802,diego.delgadillo@ypfbtransporte.com.bo
32142,Alejo Hervas Olivera,,alejo.hervas@ypfbtransporte.com.bo
32143,Mario Colomi Pacsi,,mario.colomi@ypfbtransporte.com.bo
32144,Johnn Omar Rivero Vidal,,johnn.rivero@ypfbtransporte.com.bo
32145,Juan Rollano Carvajal,,juan.rollano@ypfbtransporte.com.bo
32146,Carlos Picha Coanqui,,carlos.picha@ypfbtransporte.com.bo
32147,Dionicio Pandal Quintana,,dionicio.pandal@ypfbtransporte.com.bo
32148,Luis Santos Cutipa Fernandez,,luis.cutipa@ypfbtransporte.com.bo
32150,Armando Amado Condori,,armando.condori@ypfbtransporte.com.bo
32151,Martin Sonabe Tellez,,martin.sonabe@ypfbtransporte.com.bo
32152,Roberto Lopez Ruiz,,roberto.lopez@ypfbtransporte.com.bo
32153,Filemon Soreta Chavez,,filemon.soreta@ypfbtransporte.com.bo
32155,Isaac Ledezma Rivera,,isaac.ledezma@ypfbtransporte.com.bo
32156,Ivan Mamani Canaviri,,ivan.mamani@ypfbtransporte.com.bo
32157,Rene Siles Maita,,rene.siles@ypfbtransporte.com.bo
32159,Edbert Atilio Ricalde Oylo,,edber.ricalde@ypfbtransporte.com.bo
32161,Robin Soruco Gareca,,robin.soruco@ypfbtransporte.com.bo
32162,Elvio Horacio Miranda Soliz,,elvio.miranda@ypfbtransporte.com.bo
32164,Edgar Roman Poma,,edgar.roman@ypfbtransporte.com.bo
32165,Gaston Sylvio Saavedra Ovando,,gaston.saavedra@ypfbtransporte.com.bo
32166,Hernan Mayan Herrera,,hernan.mayan@ypfbtransporte.com.bo
32167,Humberto Ondarza Achacollo,,humberto.ondarza@ypfbtransporte.com.bo
32168,Esteban Cerezo Morales,,esteban.cerezo@ypfbtransporte.com.bo
32169,Saul Marcelo Gomez Choque,,saul.gomez@ypfbtransporte.com.bo
32170,Jose Antonio Trigo Pacheco,,jose.trigo@ypfbtransporte.com.bo
32171,Saturnino Choque Villca,,saturnino.choque@ypfbtransporte.com.bo
32172,Isidro Colomi Flores,,isidro.colomi@ypfbtransporte.com.bo
32173,Ricardo Francisco Villca Villca,,ricardo.villca@ypfbtransporte.com.bo
32175,Carlos Julian Cuchallo Castro,,carlos.cuchallo@ypfbtransporte.com.bo
32177,Cristhian Meneses Heredia,6844,cristhian.meneses@ypfbtransporte.com.bo
32178,Dennis Camacho Chalar,,dennis.camacho@ypfbtransporte.com.bo
32179,Walter Rafael Guzman Mercado,6811,walter.guzman@ypfbtransporte.com.bo
32180,Gheovana Villca Vasquez,6935,gheovana.villca@ypfbtransporte.com.bo
32182,Herlan Renan Castillo Ortiz,,herlan.castillo@ypfbtransporte.com.bo
32184,Wilbert Rider Salazar Ferrufino,,wilbert.salazar@ypfbtransporte.com.bo
32185,Oscar Israel Salazar Duran,6260,oscar.salazar@ypfbtransporte.com.bo
32186,Reinaldo Encinas Rojas,6954,reinaldo.encinas@ypfbtransporte.com.bo
32187,Fortunato Kanchi Coanqui,,fortunato.kanchi@ypfbtransporte.com.bo
32188,Mariano Ortiz Uribe,,mariano.ortiz@ypfbtransporte.com.bo
32189,Juan Carlos Roncales Borora,,juan.roncales@ypfbtransporte.com.bo
32193,Mirtha Laida Nacif Vieira,6587,mirtha.nacif@ypfbtransporte.com.bo
32194,Limber Gildres Flores,,limber.gildres@ypfbtransporte.com.bo
32195,Julio Fernando Rivero Efen,6899,fernando.rivero@ypfbtransporte.com.bo
32196,Edgar Romero Magne,,edgar.romero@ypfbtransporte.com.bo
32197,Francisco Trujillo Lara,6127,francisco.trujillo@ypfbtransporte.com.bo
32198,Miriam Paco Choque,6805,miriam.paco@ypfbtransporte.com.bo
32199,Marco Antonio Centellas Vaca,6831,marco.centellas@ypfbtransporte.com.bo
32201,Dionicio Maxi Cruz Mamani,,
32203,Franco Modesto Ramos Romero,,franco.ramos@ypfbtransporte.com.bo
32205,Wilbert Perez Pe√É∆í√Ç¬±aranda,,
32206,Willy Poeta Villalba,,
32207,Christian Enrique Luizaga Espada,6137,christian.luizaga@ypfbtransporte.com.bo
32208,Adhemar Nelson Mendoza Balboa,6328,adhemar.mendoza@ypfbtransporte.com.bo
32209,Ricardo Marcelo Tejada Inza,6122,ricardo.tejada@ypfbtransporte.com.bo
32212,Ramiro Chumacero Cors,6136,ramiro.chumacero@ypfbtransporte.com.bo
32213,Iver Fernando Flores Michel,,iver.flores@ypfbtransporte.com.bo
32214,Hugo Vargas Encinas,,hugo.vargas@ypfbtransporte.com.bo
32215,Avelino Ruiz Lerma,,avelino.ruiz@ypfbtransporte.com.bo
32216,Alfredo Jhosseph Gallardo Claure,6804,alfredo.gallardo@ypfbtransporte.com.bo
32219,Wilson Mamani Ocampo,,wilson.mamani@ypfbtransporte.com.bo
32224,Juan Carlos Llanos Soto,,juan.llanos@ypfbtransporte.com.bo
32225,Jose Guido Aleman,,jose.aleman@ypfbtransporte.com.bo
32226,Alvaro Felipe Copa Nina,,alvaro.copa@ypfbtransporte.com.bo
32227,Adon Alex Ponce Condori,,adon.ponce@ypfbtransporte.com.bo
32228,Jhazmany Javier Nina Velasco,,jhazmany.nina@ypfbtransporte.com.bo
32229,Emilio Caballero Santiva√É∆í√Ç¬±ez,,emilio.caballero@ypfbtransporte.com.bo
32230,Jose Wilfredo Arteaga Cespedes,6152,jose.arteaga@ypfbtransporte.com.bo
32233,Zovek Paul Torrez Apodaca,,
32234,Marcos Antonio Salvatierra,,
32235,Javier Esteban Campos Larrea,,
32236,Julio Gonzales Rios,,
32238,Ramiro Hugo Soto Chavarria,6952,ramiro.soto@ypfbtransporte.com.bo
32239,Marco Antonio Enriquez Mariscal,6950,marco.enriquez@ypfbtransporte.com.bo
32240,Cecilio Ricaldi Sandi,,
32241,Frany Feldy Ramos Quintana,,
32245,Omar Chuquimia Mamani,,omar.chuquimia@ypfbtransporte.com.bo
32246,Hector Ticlla Salazar,,
32247,Luis Franco Arandia Davezies,,
32248,Rolando Edgar Pairumani Medrano,,
32249,Eliseo Huallpa Quispe,,
32250,Marco Antonio Terrazas Coronado,,
32251,Severo Gutierrez Ponce,,
32253,Jorge Jimme Mamani Marca,,
32254,Ivan Humberto Funes Zelada,,ivan.funes@ypfbtransporte.com.bo
32256,Limbert Orellana Martinez,,limbert.orellana@ypfbtransporte.com.bo
32257,David Carrion Soto,,
32258,Mauro Freddy Alcoba Angulo,,
32259,Alvaro Daniel Perez Jimenez,,
32260,Juan Victor Roque Flores,,
32261,Julian Aguilar Puyal,,
32262,Yber Colque Hua√É∆í√Ç¬±apaco,,yber.colque@ypfbtransporte.com.bo
32263,Alex Edmundo Apaza Gutierrez,,
32264,Walter Armando Barroso Caballero,,walter.barroso@ypfbtransporte.com.bo
32266,Alex Yerson Justiniano Santos,,
32267,Carlos Roberto Ovando Salas,,
32269,Ronald Edwin Sarabia Zamora,6734,edwin.sarabia@ypfbtransporte.com.bo
32270,Geronimo Quispe Mamani,6969,geronimo.quispe@ypfbtransporte.com.bo
32271,Reinaldo Alvis,,reynaldo.alvis@ypfbtransporte.com.bo
32272,Cirilo Yupanqui Sanchez,,
32273,Oscar Paracta Zelaya,,
32276,Sergio Rolando Lovera Velasquez,,
32277,Carlos Erquicia Diaz,,
32278,Juan Jaime Claros Serrudo,,
32279,Miguel Angel Rodriguez Diez De Medina,,
32281,Jorge Tejerina Gutierrez,,
32282,Jose Eli Davalos Sardan,,
32284,Arnaldo Aramayo Perez,,arnaldo.aramayo@ypfbtransporte.com.bo
32286,Orlando Varnoux Serrano,,
32288,Luis Manuel Guerrero Rivero,,
32292,Cristian Liders Mayta Amador,,
32293,Sandro Ariel Toro Vallejo,,
32294,Juan Carlos Yujra Condori,,
32296,Victor Hugo Riera Tintares,,
32297,Eloy Simeon Villca Vasquez,,eloy.villca@ypfbtransporte.com.bo
32298,Emilio Alberto Merino Revollo,,
32299,Igor Norberto Lopez Monje,,
32302,Ramiro Rolando Fernandez Ugarte,,
32304,Marcelo Gonzalo Mangudo Flores,,
32305,Julio Cesar Cronembold Paniagua,,julio.cronembold@ypfbtransporte.com.bo
32306,Jose Mauricio Calderon Guzman,,
32307,Victor Aguilar Almendras,,
32308,Oscar Rodrigo Ramirez Cuellar,,
32309,Carlos Antonio Oropeza Ferrufino,,carlos.oropeza@ypfbtransporte.com.bo
32310,Rodolfo Aquino Valeriano,,
32311,Luis Richard Rivera Dominguez,,
32312,Ronald Pedro Perez Toledo,,ronald.perez@ypfbtransporte.com.bo
32313,Fabian Armando Higueras Alvarez,,
32314,Esteban Escobar Avalos,,
32315,Alejandro Avila Vargas,,
32316,Rene Suarez Garcia,,
32317,Henry Hernan Rivera Guerrero,,
32319,Wilson Robert Arce Chirinos,,wilson.arce@ypfbtransporte.com.bo
32320,Jose Gil Gareca Castro,,
32323,Martin Cejas Vargas,,
32325,Freddy Alejandro Mendez,,
32326,Ariel Fernandez Meneses,,
32328,Angel Omar Jimenez Acha,6955,angel.jimenez@ypfbtransporte.com.bo
32329,Henrry Justiniano Garcia,,henrry.justiniano@ypfbtransporte.com.bo
32330,Esteban Saul Monta√É∆í√Ç¬±o Torruella,,esteban.montano@ypfbtransporte.com.bo
32331,Yemaldo Martin Valdivia Medrano,,yemaldo.valdivia@ypfbtransporte.com.bo
32333,Efrain Gutierrez,,efrain.gutierrez@ypfbtransporte.com.bo
32334,Juan Grobert Cuellar Leon,,juan.cuellar@ypfbtransporte.com.bo
32336,Williams Calatayud Monzon,,wcalatayud@ypfbtransporte.com.bo
32337,Edwin Leon Espada,,edwin.leon@ypfbtransporte.com.bo
32338,Jose Luis Duran Espinoza,,jose.duran@ypfbtransporte.com.bo
32340,Ginner Daniel Ledezma Nogales,,ginner.ledezma@ypfbtransporte.com.bo
32341,Jose Humberto Cespedes Romero,,jose.cespedes@ypfbtransporte.com.bo
32342,Wilson Felix Ramirez Mena,,wilson.ramirez@ypfbtransporte.com.bo
32343,Ernesto Quisbert Miranda,,
32344,Marcelo Pedro Gumiel Calderon,,
32345,Edson John Arias Salvatierra,,
32346,Ricardo Antonio Aguilar Prieto,,raguilar@ypfbtransporte.com.bo
32348,Robert Isaac Vargas Escobar,,robert.vargas@ypfbtransporte.com.bo
32350,Papi Freddy Miranda Trujillo,,papi.miranda@ypfbtransporte.com.bo
32351,Ricardo Amado Ortega Antelo,,rortega@ypfbtransporte.com.bo
32352,Wilmer Silvio Villanueva Fulguera,,wilmer.villanueva@ypfbtransporte.com.bo
32353,Juan Jose Vasquez Castrillo,,juan.vasquez@ypfbtransporte.com.bo
32354,Nicolas Cruz Colque,,
32355,Pastor Pe√É∆í√Ç¬±arrieta Quino,,pastor.penarrieta@ypfbtransporte.com.bo
32358,Celestino Ortega Loayza,,celestino.ortega@ypfbtransporte.com.bo
32359,Juan Carlos Garcia Morales,,juancarlos.garcia@ypfbtransporte.com.bo
32360,Ciro Rioja Peralta,,ciro.rioja@ypfbtransporte.com.bo
32361,Dietrich Dillmar De La Barra Severich,6154,dietrich.delabarra@ypfbtransporte.com.bo
32362,Marco Antonio Fuentes Colque,,marco.fuentes@ypfbtransporte.com.bo
32363,Rosendo Marcani Valencia,,rosendo.marcani@ypfbtransporte.com.bo
32364,Oscar Alfredo Tacuri Soliz,,
32365,Eucebio Condori Argote,,eucebio.condori@ypfbtransporte.com.bo
32367,Isidoro Ivar Francisco Ferrufino Lopez,,isidoro.ferrufino@ypfbtransporte.com.bo
32368,Wilber Llanes Ceron,,wilber.llanes@ypfbtransporte.com.bo
32369,Antonino Alvares Maras,,antonino.alvares@ypfbtransporte.com.bo
32370,Giovany Javier Loro√É∆í√Ç¬±o Bautista,,giovany.lorono@ypfbtransporte.com.bo
32371,Jesus Canchi Huallpa,,jesus.canchi@ypfbtransporte.com.bo
32372,Eufronio Gonzales Miranda,,eufronio.gonzales@ypfbtransporte.com.bo
32374,Juan Carlos Fernandez Burgoa,,
32375,Juan Yobany Herrera Rioja,,juan.herrera@ypfbtransporte.com.bo
32376,Felix Huaytari Paryna,,felix.huaytari@ypfbtransporte.com.bo
32377,Ruben Albino Cuba,,ruben.albino@ypfbtransporte.com.bo
32378,Rudy Caballero Gareca,,rudy.caballero@ypfbtransporte.com.bo
32379,Genaro Caceres Baldiviezo,,genaro.caceres@ypfbtransporte.com.bo
32380,Orlando Morales Loayza,,orlando.morales@ypfbtransporte.com.bo
32381,Serafin Betancur Onofre,,serafin.betancur@ypfbtransporte.com.bo
32382,Aniceto Alanis Pe√É∆í√Ç¬±arrieta,,aniceto.alanis@ypfbtransporte.com.bo
32383,Juan Lutre Pe√É∆í√Ç¬±arrieta,,juan.lutre@ypfbtransporte.com.bo
32385,Gonzalo Flores Perez,,gonzalo.flores@ypfbtransporte.com.bo
32386,Limber Eduardo Capurata Flores,,
32387,Freddy Mijhail Garcia Orellana,,freddy.garcia@ypfbtransporte.com.bo
32388,Macario Gutierrez Roldan,,macario.gutierrez@ypfbtransporte.com.bo
32389,Andres Oquendo Garcia,,andres.oquendo@ypfbtransporte.com.bo
32390,Leonardo Vargas Malale,,leonardo.vargas@ypfbtransporte.com.bo
32391,Juan De Dios Calero Vargas,,juan.calero@ypfbtransporte.com.bo
32392,Luis Caceres Cueto,,luis.caceres@ypfbtransporte.com.bo
32393,Marco Antonio Martinez Velasquez,,marco.martinez@ypfbtransporte.com.bo
32394,Rosendo Sifuentes Piuca,,rosendo.sifuentes@ypfbtransporte.com.bo
32395,Guiber Villalba Ortiz,,guiber.villalba@ypfbtransporte.com.bo
32396,Manuel Cupari Mamani,,manuel.cupari@ypfbtransporte.com.bo
32398,Carlos Perez Ortiz,,carlos.perez@ypfbtransporte.com.bo
32399,Modesto Rivera Padilla,,modesto.rivera@ypfbtransporte.com.bo
32400,Julio Avila Vedia,,julio.avila@ypfbtransporte.com.bo
32404,Juan Carlos Rivera Perez,,juan.rivera@ypfbtransporte.com.bo
32405,Ruddy Rodriguez Ninachi,,ruddy.rodriguez@ypfbtransporte.com.bo
32406,Juanito Yucra Mercado,,juanito.yucra@ypfbtransporte.com.bo
32407,Anibar Aguilar,,anibar.aguilar@ypfbtransporte.com.bo
32408,Toribio Flores Chambi,,toribio.flores@ypfbtransporte.com.bo
32409,William Tejerina Segovia,,willian.tejerina@ypfbtransporte.com.bo
32411,Henrry Vargas Campos,,henrry.vargas@ypfbtransporte.com.bo
32412,Elvis Telmo Villca Mamani,,elvis.villca@ypfbtransporte.com.bo
32413,Hugo Carballo Zabala,,hugo.carballo@ypfbtransporte.com.bo
32415,Giovanna Claudia Gareca I√É∆í√Ç¬±iguez,6532,giovanna.gareca@ypfbtransporte.com.bo
32424,Juan Carlos Vaca Vargas,6971,juan.vaca@ypfbtransporte.com.bo
32425,Marcio Sergio Martinez Copa,,
32426,Vivian Jenny Gianella Arauz,6525,vivian.gianella@ypfbtransporte.com.bo
32427,Ameth Jaime Chumacero Sierra,,ameth.chumacero@ypfbtransporte.com.bo
32428,Jessica Suarez Saucedo,6268,jessica.suarez@ypfbtransporte.com.bo
32432,Herman Adalid Mariscal Soria,,herman.mariscal@ypfbtransporte.com.bo
32433,Wilfredo Villarpando Lazcano,,wilfredo.villarpando@ypfbtransporte.com.bo
32435,Erick Mauricio Flores Padilla,,erick.flores@ypfbtransporte.com.bo
32436,Julio Alberto Sanchez Barrientos,,julio.sanchez@ypfbtransporte.com.bo
32438,Erick Mauricio Arteaga Flores,,erick.arteaga@ypfbtransporte.com.bo
32439,Jorge Enrique Duran Salazar,,jorge.duran@ypfbtransporte.com.bo
32440,Maria Elizabeth Calderon Herrera,,maria.calderon@ypfbtransporte.com.bo
32441,Rene Valda Churqui,6352,rene.valda@ypfbtransporte.com.bo
32442,Marcos Antonio Cardozo Altamirano,,marcos.cardozo@ypfbtransporte.com.bo
32443,Simeon Molina Avila,,simeon.molina@ypfbtransporte.com.bo
32445,Luis Enrique Claure Vargas,,luis.claure@ypfbtransporte.com.bo
32446,Edson Mauricio Jorge Amatller Castro,6881,edson.amatller@ypfbtransporte.com.bo
32448,Franz Litt Miranda Herrera,,franz.miranda@ypfbtransporte.com.bo
32449,Juan Carlos Rojas Mendieta,,juan.rojas@ypfbtransporte.com.bo
32452,Lilian Fabiola Bonilla Rojas,6853,lilian.bonilla@ypfbtransporte.com.bo
32454,Roberto Pablo Sanchez Gomez,6536,roberto.sanchez@ypfbtransporte.com.bo
32455,Jose Asuncion Romero Velasquez,6893,jose.romero@ypfbtransporte.com.bo
32458,Shirley Tatiana Lea√É∆í√Ç¬±os Pereira,6761,tatiana.leanos@ypfbtransporte.com.bo
32459,Carlos Mauricio Martinez Diaz,,
32460,Juan Carlos Portugal Leon,,juan.portugal@ypfbtransporte.com.bo
32461,Jose Andres Quiller Choquechambi,,jose.quiller@ypfbtransporte.com.bo
32462,Everth Amaya Moscoso,6676,everth.amaya@ypfbtransporte.com.bo
32463,Maria Eugenia Miranda Guzman,6517,maria.miranda@ypfbtransporte.com.bo
32464,Yesy Gerardo Avalos Cortez,,yesy.avalos@ypfbtransporte.com.bo
32465,Gaille Wilma Camacho Arenas,6309,gaille.camacho@ypfbtransporte.com.bo
32467,Maria Cecilia Rea Queirolo,6501,cecilia.rea@ypfbtransporte.com.bo
32491,Enrique Gonzales Mejia,6305,enrique.gonzales@ypfbtransporte.com.bo
32496,Carla Lizeth Villarroel Flores,6606,carla.villarroel@ypfbtransporte.com.bo
32513,German Prado Jimenez,,
32520,Luis Fuentes Quispe,,
32528,Brenda Ninoska Gutierrez Zegarrundo,6504,brenda.gutierrez@ypfbtransporte.com.bo
32532,Toninho Edson Cerezo Huaita,6663,toninho.cerezo@ypfbtransporte.com.bo
32533,Felix Ismael Tarqui Colque,6678,ismael.tarqui@ypfbtransporte.com.bo
32536,Eduardo Daza Sandoval,6522,eduardo.daza@ypfbtransporte.com.bo
32538,Jafeth Acha Acebey,6177,jafeth.acha@ypfbtransporte.com.bo
32546,Jaime Herrera Chacon,,jaime.herrera@ypfbtransporte.com.bo
32547,Alejandro Raphael Palacios Morales,,alejandro.palacios@ypfbtransporte.com.bo
32549,Jose Rojas Meneses,,jose.rojas.meneses@ypfbtransporte.com.bo
32583,Freddy Waldo Rocha Trive√É∆í√Ç¬±o,,
32596,Marco Antonio Gallardo Navia,6068,marco.gallardo@ypfbtransporte.com.bo
32604,Leandro Rene Villarroel Fuentes,6756,leandro.villarroel@ypfbtransporte.com.bo
32623,Jessica Jasmina Flores Rojas,6293,jessica.flores@ypfbtransporte.com.bo
32627,Alfredo Sifuentes Cueto,,alfredo.sifuentes@ypfbtransporte.com.bo
32628,Gary Artunduaga Moreno,6294,gary.artunduaga@ypfbtransporte.com.bo
32629,Silvia Anagua Garron,6821,silvia.anagua@ypfbtransporte.com.bo
32630,Rilmar Felix Saavedra Zambrana,6271,rilmar.saavedra@ypfbtransporte.com.bo
32632,Luis Alberto Davalos Herrera,,luis.davalos@ypfbtransporte.com.bo
32636,Luis Fernando Buzolic Cuellar,,
32637,Scarlet Hurtado Torrez,6833,scarlet.hurtado@ypfbtransporte.com.bo
32638,Hector Hernan Pita Perez,6785,hector.pita@ypfbtransporte.com.bo
32642,Liliana Villa Ovando,6286,liliana.villa@ypfbtransporte.com.bo
32656,Jose Roland Pardo Vidal,,
40001102,Limbert Olmos Pinto,,
40001250,Paola Veronica Revollo Cabrera,6772,paola.revollo@ypfbtransporte.com.bo
40001284,Luis Arturo Alba Cadima,,arturo.alba@ypfbtransporte.com.bo
40001285,Patricia Lily Chavarria Yevara,6987,patricia.chavarria@ypfbtransporte.com.bo
40001286,Horacio Rodriguez Mamani,,
40008002,Edith Gloria Vera Romero,6688,edith.vera@ypfbtransporte.com.bo
40008003,Renato Foronda Cuellar,6891,rene.foronda@ypfbtransporte.com.bo
40008012,Manuel Eduardo Antonio Canedo Sanchez,,
40008013,Cecil Ely Cespedes Frias,6249,cecil.cespedes@ypfbtransporte.com.bo
40008015,Celso Franco Martinez,,celso.franco@ypfbtransporte.com.bo
40008030,Robert Vaca Guzman Guzman,,
40008037,Franz Pe√±aloza Robledo,,
40008045,Carminia Calle Vadillo,,carminia.calle@ypfbtransporte.com.bo
40008046,Viviana Suarez Suarez,6601,viviana.suarez@ypfbtransporte.com.bo
40008053,Fernando Herlan Fernandez Rodriguez,,fernando.fernandez@ypfbtransporte.com.bo
40008056,Cosme Daniel Lazarte Terceros,,
40008057,Dante Victor Flores Herbas,,dante.flores@ypfbtransporte.com.bo
40008058,Alex Adrian Cruz Ortiz,,alex.cruz@ypfbtransporte.com.bo
40008059,Mario Fernando Barrero Ribera,,
40008060,Omar Burgos Quinteros,,
40008061,Gerardo Edgar Lopez Trujillo,,gerardo.lopez@ypfbtransporte.com.bo
40008094,Fernando Jair Huanca Paco,,
40008095,Mauricio Sanchez Siles,,masanchezs@ypfbtransporte.com.bo
40008096,Mauricio Saucedo Sapag,,mauricio.saucedo.sapag@ypfbtransporte.com.bo
40008097,Bismar Sandoval Alpiri,,bismar.sandoval@ypfbtransporte.com.bo
40008098,Judith Barreta Vargas,6531,judith.barreta@ypfbtransporte.com.bo
40008163,Isaac Alvaro Mu√É∆í√Ç¬±oz Mu√É∆í√Ç¬±oz,,imunozm@ypfbtransporte.com.bo
40008168,Maikel Jerson Padilla Severiche,,maikel.padilla@ypfbtransporte.com.bo
40008171,Kevin Daniel Arteaga Vaca,,
40008172,Jhonn Iver Serna Guti√É∆í√Ç¬©rrez,,jisernag@ypfbtransporte.com.bo
40008211,Carlos Mauricio Ramirez Gutierrez,6541,carlos.ramirez@ypfbtransporte.com.bo
40008247,Carlos Santiago Carvallo Padilla,6168,carlos.carvallo@ypfbtransporte.com.bo
40008249,Ramon Dario Sandoval Salvatierra,6178,ramon.sandoval@ypfbtransporte.com.bo
40008250,Arturo Arce Soto,6285,arturo.arce@ypfbtransporte.com.bo
40008252,Charles Aldo Jimenez Quinteros,6642,aldo.jimenez@ypfbtransporte.com.bo
40008255,Pran Igor Kalam Maldonado,6682,pran.kalam@ypfbtransporte.com.bo
40008286,Oscar Guillermo Ticona Chuipa,6417,oscar.ticona@ypfbtransporte.com.bo
40008292,Carlos Ramon Navas Clouzet,,ramon.navas@ypfbtransporte.com.bo
40008302,Vania Molina Aguilera,6272,vania.molina@ypfbtransporte.com.bo
40008303,Alberto Soto Pe√É∆í√Ç¬±a,6245,alberto.soto@ypfbtransporte.com.bo
40008344,Oscar Cesar Guzman Velarde,6060,oscar.guzman@ypfbtransporte.com.bo
40008352,Vania Paola Ribera Costas,6555,
40008355,Javier Alejandro Viveros Cossio,6919,javier.viveros@ypfbtransporte.com.bo
40008357,Luis Alberto Soria Balderas,,luis.soria@ypfbtransporte.com.bo
40008359,Tito Efrain Yurquina Palavecino,6165,tito.yurquina@ypfbtransporte.com.bo
40008366,Rodrigo Samuel Suarez De Gumucio,,rodrigo.suarez.gumucio@ypfbtransporte.com.bo
40008369,Sergio Luis Retamozo Acosta,,sergio.retamozo@ypfbtransporte.com.bo
40008370,Julio Cesar Galarza Lobo,,julio.galarza@ypfbtransporte.com.bo
40008375,Jesus Antonio Lima Camacho,,
40008376,Gonzalo Andres Llanquin Gonzalez,,
40008384,Samuel Caba Vergara,,samuel.caba@ypfbtransporte.com.bo
40008385,Dianet Gareca Cassia,6595,dianet.gareca@ypfbtransporte.com.bo
40008386,Roland Ponce Fleig,6200,roland.ponce@ypfbtransporte.com.bo
40008388,Judith Garcia Rojas,6415,judith.garcia@ypfbtransporte.com.bo
40008391,Gary Carrasco Carrasco,6589,gary.carrasco@ypfbtransporte.com.bo
40008393,Jose Yasmanny Vasquez Arnez,6679,jose.vasquez@ypfbtransporte.com.bo
40008396,Andres Denker Bejarano,6081,andres.denkerbejarano@ypfbtransporte.com.bo
40008397,Liliana Mendez Cabrera,,liliana.mendez@ypfbtransporte.com.bo
40008400,Renan Luis Layme Yucra,6632,renan.layme@ypfbtransporte.com.bo
40008401,Jimena Arevalo Nogales,,jimena.arevalo@ypfbtransporte.com.bo
40008415,Ariely Dayan Menacho Montenegro,6557,ariely.menacho@ypfbtransporte.com.bo
40008416,Teodora Mendez Guzman,6588,teodora.mendez@ypfbtransporte.com.bo
40008421,Alvaro Cerezo Salazar,,alvaro.cerezo@ypfbtransporte.com.bo
40008422,Andres Flores Mamani,,
40008425,Jesus Neil Colque Choque,,
40008427,Jose Luis Antelo Quiroga,,
40008428,Juan Carlos Rodriguez Bernabe,,
40008430,Juan Pablo Melgar,,
40008431,Marcelino Medrano Almendras,,
40008432,Marco Barba Rodriguez,,
40008433,Miguel Angel Lijeron,,
40008434,Paul Jurado,,
40008435,Raul Prieto Portillo,,raul.prieto@ypfbtransporte.com.bo
40008437,Ricardo Macedo Duran,,
40008438,Ricardo Saucedo Carrasco,,
40008439,Simon Ribera Zurita,,simon.ribera@ypfbtransporte.com.bo
40008441,Wilber Eloy Tirado Barrios,,wilber.tirado@ypfbtransporte.com.bo
40008442,Dyango Eguez Gomez,,
40008449,Cliver Anzaldo Avenda√É∆í√Ç¬±o,,cliver.anzaldo@ypfbtransporte.com.bo
40008454,Jose Luis Justiniano Fernandez,,jose.justiniano@ypfbtransporte.com.bo
40008456,Bismark Zalazar Salguero,,bismark.zalazar@ypfbtransporte.com.bo
40008457,Alejandro Moreno Davalos,,alejandro.moreno@ypfbtransporte.com.bo
40008458,Luis Alexander Rojas Crespo,,luis.rojas@ypfbtransporte.com.bo
40008459,German Barrios Herrera,,german.barrios@ypfbtransporte.com.bo
40008460,Freddy Romero Arteaga,,freddy.romero@ypfbtransporte.com.bo
40008461,Gonzalo Da Silva Hurtado,,gonzalo.dasilva@ypfbtransporte.com.bo
40008462,Hernan Ribera Arteaga,,hernan.ribera@ypfbtransporte.com.bo
40008463,Sergio Abel Cruz Mancilla,,sergio.cruz@ypfbtransporte.com.bo
40008464,Pedro Wilber Soliz Vaca,,pedro.soliz@ypfbtransporte.com.bo
40008465,Nancy Elvira Quispe Padilla,6602,nancy.quispe@ypfbtransporte.com.bo
40008475,Hugo Tarifa Vaca,,
40008476,Robert Marcelo Hurtado Gomez,6895,robert.hurtado@ypfbtransporte.com.bo
40008477,Celia Limachi Pinto,6807,celia.limachi@ypfbtransporte.com.bo
40008482,Luis Alberto Alarcon Sanchez,,luis.alarcon@ypfbtransporte.com.bo
40008483,Ernesto Osinaga Perez,,ernesto.osinaga@ypfbtransporte.com.bo
40008484,Miguel Angel Suarez Hernandez,,miguel.suarez@ypfbtransporte.com.bo
40008485,Agust√É∆í√Ç¬≠n Cabrera Bravo,,agustin.cabrera@ypfbtransporte.com.bo
40008486,Eliseo Pedraza Terrazas,,eliseo.pedraza@ypfbtransporte.com.bo
40008487,Guillermo Adan Aparicio,,guillermo.adan@ypfbtransporte.com.bo
40008507,Carlos Carrillo Duchen,,
40008508,Jhony Albes Garcia,,jhony.albes@ypfbtransporte.com.bo
40008509,Efrain Zarate Onofre,6775,efrain.zarate@ypfbtransporte.com.bo
40008510,Rainer Nilio Torrico Caballero,,rainer.torrico@ypfbtransporte.com.bo
40008511,Marvin Estivarez Palacios,,marvin.estivarez@ypfbtransporte.com.bo
40008512,Robbin Garcia Menacho,,
40008513,Tito Ribero Lino,,tito.ribero@ypfbtransporte.com.bo
40008514,Simon Mamani Avila,,
40008515,Adan Alejandro Chova Vaca,,adan.chova@ypfbtransporte.com.bo
40008516,Cesar Enrique Macuri Cordero,,cesar.macuri@ypfbtransporte.com.bo
40008518,Luis Antonio Salazar Zelaya,,luis.salazar@ypfbtransporte.com.bo
40008534,Alexander Heredia Maigua,,alexander.heredia@ypfbtransporte.com.bo
40008550,Roger Dery La Fuente Estrada,,roger.lafuente@ypfbtransporte.com.bo
40008553,Ana Rosalia Lipa Choque,6082,ana.lipa@ypfbtransporte.com.bo
40008558,Santiago Ponce Chambi,,
40008613,Carlos Rodrigo Quintana Orsini,6080,rodrigo.quintana@ypfbtransporte.com.bo
40008628,Carlos Humberto Linares Alvarez,,carlos.linares@ypfbtransporte.com.bo
40008637,Morgan Noel Angelo Montes,,morgan.angelo@ypfbtransporte.com.bo
40008642,Ariel Rodriguez Ledezma,6144,ariel.rodriguez@ypfbtransporte.com.bo
40008648,Asunta Rosmery Herrera Salda√É∆í√Ç¬±a,6992,rosmery.herrera@ypfbtransporte.com.bo
40008652,Jose Matny Saracho,6500,jose.matny@ypfbtransporte.com.bo
40008656,Angel Yba√É∆í√Ç¬±ez Pedraza,6306,angel.ybanez@ypfbtransporte.com.bo
40008658,Wilder Ruiz,,
40008659,David Gonzalo Gutierrez,,
40008660,Oscar Padilla,,
40008661,Estanislao Hilaquita Cari,,estanislao.hilaquita@ypfbtransporte.com.bo
40008682,Maria Elena Satt Subirana,6942,maria.satt@ypfbtransporte.com.bo
40008693,Harlexs Milton Bustos Barja,,
40008697,Osmar Vladimir Requena Delgado,6882,osmar.requena@ypfbtransporte.com.bo
40008698,Shakira Diana Chiri Michel,6547,diana.chiri@ypfbtransporte.com.bo
40008715,Paula Carola Copia Pardo,,paula.copia@ypfbtransporte.com.bo
40008721,Arturo Jose Zelaya Galvis,6227,arturo.zelaya@ypfbtransporte.com.bo
40008753,Rene Hilari Choque,6604,rene.hilari@ypfbtransporte.com.bo
40008769,Neven Matijasevic Contreras,6938,neven.matijasevic@ypfbtransporte.com.bo
40008781,Abel Alfonzo Barja Monta√É∆í√Ç¬±o,6276,abel.barja@ypfbtransporte.com.bo
40008784,Carlos Miguel Reque Balcazar,6858,carlos.reque@ypfbtransporte.com.bo
40008791,Leonel Arispe Sullka,3919,leonel.arispe.ext@ypfbtransporte.com.bo
40008792,Natalia Adelia Morales Cuellar,3922,natalia.morales.ext@ypfbtransporte.com.bo
40008794,Winny Chacon Balderrama,6124,winny.chacon@ypfbtransporte.com.bo
40008796,Rene Luis Perez Magne,6700,rene.perez@ypfbtransporte.com.bo
40008797,Hermes Flores Eguez,6600,hermes.flores@ypfbtransporte.com.bo
40008798,Victor Fernando Molina Galvan,6400,fernando.molina@ypfbtransporte.com.bo

</script>
<script>
const PERSONAL_CSV = document.getElementById('personal-data').textContent;
const PERSONAL_LIST = PERSONAL_CSV.trim().split(/\n+/).slice(1).map(line=>{
  const [codigo,nombre,telefono,correo] = line.split(',');
  return {codigo,nombre,telefono,correo};
});
</script>
<script id="db-json" type="application/json"></script>

<script>
/* ================== Conexi√≥n a Firebase ================== */
const firebaseConfig = {
  apiKey: "AIzaSyDGn5LhReOV_Ucl9NjgjAW8JWy4Vx4Cz2k",
  authDomain: "crm-habilitacion-ypfb.firebaseapp.com",
  databaseURL: "https://crm-habilitacion-ypfb-default-rtdb.firebaseio.com",
  projectId: "crm-habilitacion-ypfb",
  storageBucket: "crm-habilitacion-ypfb.firebasestorage.app",
  messagingSenderId: "1080151200863",
  appId: "1:1080151200863:web:165ef20b9318946c9737ea"
};
let database = null;
let auth = null;
if (window.firebase) {
  firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  database = firebase.database();
} else {
  console.warn("Firebase no disponible, usando almacenamiento local");
}
/* ================== Fin de Conexi√≥n a Firebase ================== */

/* ================== Persistencia de carpeta BD ================== */
const NET_HINT = "O:\\\\Practicantes\\\\EQUIPO GSSMS (2021-2022)\\\\CONTROL DE CARPETAS DE SSMS\\\\Aplicaci√≥n\\\\Habilitaci√≥n Proyectos\\\\BD";
const CARPETA_BASE = "O:\\\\Practicantes\\\\EQUIPO GSSMS (2021-2022)\\\\CONTROL DE CARPETAS DE SSMS\\\\Aplicaci√≥n\\\\Habilitaci√≥n Proyectos\\\\YPFB_HABILITACI√ìN";
let SHEET_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwB77IBe2_uc1sY-bSgqPfieems5-1q8UaXiiP7MH1TeKhtNIgc5qKZRusNZSWeXgBy/exec";
const storedSheetUrl = localStorage.getItem('sheetWebAppUrl');
if(storedSheetUrl) SHEET_WEBAPP_URL = storedSheetUrl;
let EXPORT_DIR_HANDLE = null;
const DB_NAME = "ypfb-crm-db-v4"; const STORE = "fs";
const BANNER_OK_STATES = new Set(["APROBADO","NO APLICA","SIN PERSONAL","SIN VEHICULO"]);
function idbOpen(){return new Promise((res,rej)=>{const req = indexedDB.open(DB_NAME,1);req.onupgradeneeded=e=>e.target.result.createObjectStore(STORE);req.onsuccess=e=>res(e.target.result);req.onerror=e=>rej(e.target.error);});}
async function idbSet(k,v){const db=await idbOpen();return new Promise((res,rej)=>{const tx=db.transaction(STORE,"readwrite");tx.objectStore(STORE).put(v,k);tx.oncomplete=()=>res();tx.onerror=e=>rej(e.target.error);});}
async function idbGet(k){const db=await idbOpen();return new Promise((res,rej)=>{const tx=db.transaction(STORE,"readonly");const rq=tx.objectStore(STORE).get(k);rq.onsuccess=()=>res(rq.result);rq.onerror=e=>rej(e.target.error);});}
async function ensurePermission(dir){if(!dir) return false; let p=await dir.queryPermission({mode:"readwrite"}); if(p==="granted") return true; if(p==="prompt") p=await dir.requestPermission({mode:"readwrite"}); return p==="granted";}
async function pickDir(){try{const h=await window.showDirectoryPicker(); if(await ensurePermission(h)){EXPORT_DIR_HANDLE=h; await idbSet("dataDir", h); banner(`Carpeta BD establecida. Cargando JSON...`); await loadAllFromDir();} else { banner(`No se concedi√≥ permiso de escritura. Se usar√° DESCARGA.`, true);} }catch(e){console.warn(e);}}
document.getElementById("btnPickDir").addEventListener("click", pickDir);
function banner(msg, warn=false){const el=document.getElementById("bd-banner"); el.style.display="block"; el.innerHTML = `<b>${warn?"Aviso":"Info"}:</b> ${msg}<div class="note">Ruta sugerida: ${NET_HINT}</div>`;}
async function saveJSON(filename, obj){
  const txt = JSON.stringify(obj,null,2);
  if(EXPORT_DIR_HANDLE && await ensurePermission(EXPORT_DIR_HANDLE)){
    try{
      const file = await EXPORT_DIR_HANDLE.getFileHandle(filename,{create:true});
      const ws = await file.createWritable(); await ws.write(txt); await ws.close();
      banner(`Guardado en carpeta BD: ${filename}`);
      return;
    }catch(e){ console.warn("FS save error", e); }
  }
  // Fallback descarga
  const blob = new Blob([txt], {type:"application/json"});
  const a = document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1200);
}
async function saveDBSnapshot(){
  const all = { schema:"ypfb.crm.v4.snapshot.global", version:1, generadoEn: nowIso(), empresas: DBCACHE };
  await saveJSON("SNAPSHOT_GLOBAL.json", all);
}

async function enviarASheet(data) {
  if (!SHEET_WEBAPP_URL) {
    alert("Error: La URL del script no est√° configurada.");
    throw new Error("SHEET_WEBAPP_URL vac√≠o");
  }

  return new Promise((resolve, reject) => {
    try {
      // Crear un formulario en la memoria
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = SHEET_WEBAPP_URL;
      form.target = 'iframe-invisible'; // Apunta al iframe que creamos

      // Crear un campo invisible para contener todos los datos como un string JSON
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'jsonData'; // El nombre que usaremos en el script
      input.value = JSON.stringify(data);
      form.appendChild(input);

      // A√±adir el formulario al documento, enviarlo y luego removerlo
      document.body.appendChild(form);
      form.submit();
      document.body.removeChild(form);

      console.log("Formulario invisible enviado. La respuesta se cargar√° en el iframe.");
      
      // Como no podemos leer la respuesta del iframe, asumimos √©xito si no hay error.
      // Damos un peque√±o tiempo para que se complete el env√≠o.
      setTimeout(() => {
        resolve({ status: 'ok', message: 'Datos enviados para procesamiento.' });
      }, 1500); // Espera 1.5 segundos

    } catch (err) {
      console.error("Error al crear o enviar el formulario invisible:", err);
      alert("Error al construir la solicitud: " + err.message);
      reject(err);
    }
  });
}
/* ================== Datos / Estado ================== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
// Fecha y hora local para Bolivia (UTC-4)
const nowIso = ()=>{
  const now = new Date();
  const utc = now.getTime() + now.getTimezoneOffset() * 60000;
  const bol = new Date(utc - 4 * 3600000);
  const p = n => String(n).padStart(2,'0');
  return `${bol.getFullYear()}-${p(bol.getMonth()+1)}-${p(bol.getDate())}T${p(bol.getHours())}:${p(bol.getMinutes())}:${p(bol.getSeconds())}-04:00`;
};
function ts(){
  const d=new Date();
  const utc=d.getTime()+d.getTimezoneOffset()*60000;
  const bol=new Date(utc-4*3600000);
  const p=n=>String(n).padStart(2,"0");
  return bol.getFullYear()+p(bol.getMonth()+1)+p(bol.getDate())+"-"+p(bol.getHours())+p(bol.getMinutes())+p(bol.getSeconds());
}
function uid(){return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16));}

let DBCACHE = {}; // { [empresaClave]: { empresa:{...}, proyectos:{ [proyectoId]: {proyecto, ls025, personal, vehiculos, updatedAt} } } }
let REMOTE_SNAPSHOT = {}; // Copia del √∫ltimo estado descargado desde Firebase
const LOCAL_CACHE_KEY = "dbCacheV4";

const LOCAL_CACHE_BACKUP_KEY = "dbCacheV4Backup";

const REMOTE_CACHE_KEY = "dbCacheV4Remote";
const CACHE_META_KEY = "dbCacheV4Meta";
const LAST_PAYLOAD_KEY = "dbCacheV4LastPayload";
const RESERVED_EMPRESAS = ["geminikeys","historial","sistema-1"]; // claves que no deben mostrarse en dashboard

const RESERVED_ROOT_KEYS = new Set(["usuarios","historial","geminikeys","aiusers"]); // nodos controlados por m√≥dulos dedicados

function empresaKeys(){
  return Object.keys(DBCACHE).filter(k=>{
    if(RESERVED_EMPRESAS.includes(k.toLowerCase())) return false;
    const emp = DBCACHE[k];
    const nombre = emp?.empresa?.datos?.empresa || emp?.empresa?.nombre;
    return !!nombre;
  });
}
let CURRENT = JSON.parse(localStorage.getItem("currentV4")||"{}"); // { empresaClave, proyectoId }
let USERS = JSON.parse(localStorage.getItem("usuariosApp")||"{}") || {};
let USUARIO = JSON.parse(localStorage.getItem("usuarioActual") || sessionStorage.getItem("usuarioActual") || "null") || {nombre:"", correo:"", codigo:"", admin:false};
let READONLY = false;
let ES_RESPONSABLE = false;
let USER_ROLES = new Set();
let ls025FilteredIds = null;
let conversation = JSON.parse(localStorage.getItem('aiConversation') || 'null');
let HISTORIAL = {};
let currentProyecto = null;
if (!conversation) {
  conversation = [{
    role: 'model',
    parts: [{
      text: 'Por favor, cu√©ntame TODO sobre el proyecto: de qu√© se trata, d√≥nde se har√° (estaci√≥n/DDV/terminal, ciudad/pa√≠s), fechas y duraci√≥n, actividades principales (p. ej., conducci√≥n, trabajos en caliente, izaje, alturas, espacio confinado, electricidad, arenado, hot tap, excavaci√≥n), si habr√° campamentos y rutas, cu√°ntas personas y roles, si hay conductores u operadores de equipo pesado, si manipulan sustancias qu√≠micas o alimentos, si trabajar√°n fuera de Bolivia o con personal extranjero, veh√≠culos/equipos previstos y cualquier tema ambiental (licencias, desmonte, √°ridos, ruido/emisiones).'
    }]
  }];
} else {
  let updated = false;
  conversation = conversation.map(msg => {
    if (msg.role === 'model') {
      const raw = msg.parts.map(p => p.text).join('');
      const parsed = extractResponseObject(raw);
      if (parsed) {
        updated = true;
        return { role: 'model', parts: [{ text: JSON.stringify(parsed) }] };
      }
    }
    return msg;
  });
  if (updated) {
    saveConversation();
  }
}
function saveConversation(){
  const max = 50;
  const toSave = conversation.slice(-max);
  localStorage.setItem('aiConversation', JSON.stringify(toSave));
}
function getDataForFirebase(source){
  if(!source || typeof source !== 'object') return {};
  const clean={};
  Object.entries(source).forEach(([key,value])=>{
    if(value===undefined || value===null) return;
    const lower=String(key).toLowerCase();
    if(!RESERVED_ROOT_KEYS.has(lower)) clean[key]=value;
  });
  return clean;
}

function mergeDeep(base, incoming){
  if(incoming===undefined) return base;
  if(incoming===null) return null;
  if(Array.isArray(incoming)){
    return incoming.map(item=>{
      if(item && typeof item === 'object'){
        return mergeDeep(undefined, item);
      }
      return item;
    });
  }
  if(typeof incoming !== 'object') return incoming;
  const baseObj = (base && typeof base === 'object' && !Array.isArray(base)) ? base : {};
  const result = {};
  let changed=false;
  const keys=new Set([...Object.keys(baseObj), ...Object.keys(incoming)]);
  keys.forEach(key=>{
    if(!(key in incoming)){
      result[key]=baseObj[key];
      return;
    }
    const mergedVal=mergeDeep(baseObj[key], incoming[key]);
    result[key]=mergedVal;
    if(mergedVal!==baseObj[key]) changed=true;
  });
  if(!changed && keys.size===Object.keys(baseObj).length){
    return base;
  }
  return result;
}
function cloneData(source){
  if(source===undefined) return undefined;
  return mergeDeep(undefined, source);
}
function sanitizeCacheData(source){
  if(!source || typeof source !== 'object') return {};
  const clean={};
  Object.entries(source).forEach(([key,value])=>{
    if(value===undefined || value===null) return;
    const lower=String(key).toLowerCase();
    if(RESERVED_ROOT_KEYS.has(lower)) return;
    if(value && typeof value === 'object'){
      clean[key]=cloneData(value);
    }else{
      clean[key]=value;
    }
  });
  return clean;
}
function persistLocalCache(data){
  if(data && typeof data === 'object'){
    DBCACHE=cloneData(data);
  }
  const tag=document.getElementById("db-json");
  if(tag){
    try{
      const visible=JSON.stringify(getDataForFirebase(DBCACHE));
      tag.textContent=visible;
    }catch(err){
      console.error("No se pudo serializar el estado actual de la base de datos:", err);
    }
  }
}

function persistRemoteBackup(snapshot){
  REMOTE_SNAPSHOT = sanitizeCacheData(snapshot || {});
  return REMOTE_SNAPSHOT;
}
function deepEqual(a,b){
  if(a===b) return true;
  if(typeof a!==typeof b) return false;
  if(a && typeof a==='object'){
    if(Array.isArray(a)){
      if(!Array.isArray(b) || a.length!==b.length) return false;
      for(let i=0;i<a.length;i++){
        if(!deepEqual(a[i], b[i])) return false;
      }
      return true;
    }
    if(!b || typeof b!=='object') return false;
    const keys=new Set([...Object.keys(a), ...Object.keys(b)]);
    for(const key of keys){
      if(!deepEqual(a[key], b[key])) return false;
    }
    return true;
  }
  return false;
}

function computeDiffPayload(current, previous){
  const payload={};
  const keys=new Set([
    ...Object.keys(current||{}),
    ...Object.keys(previous||{})
  ]);
  keys.forEach(key=>{
    const cur=current?current[key]:undefined;
    const prev=previous?previous[key]:undefined;
    if(cur===undefined){
      if(prev!==undefined){
        payload[key]=null;
      }
      return;
    }
    if(prev===undefined || !deepEqual(cur, prev)){
      payload[key]=cur;
    }
  });
  return payload;
}

function persistDB(){
  const sanitizedCurrent = sanitizeCacheData(DBCACHE);
  const payload = computeDiffPayload(sanitizedCurrent, REMOTE_SNAPSHOT);

  if(!payload || typeof payload !== 'object' || !Object.keys(payload).length){
    persistLocalCache();
    return;
  }

  if (database) {
    database.ref().update(payload)
      .then(()=>{
        REMOTE_SNAPSHOT = cloneData(sanitizedCurrent);
      })
      .catch(error=>{
        console.error("Error al guardar datos en Firebase:", error);
        alert("Error: No se pudieron guardar los cambios en la nube.");
      });
  }

  persistLocalCache();

}

function persistPersonal(){
  const clave=document.querySelector("#per-empresaSel")?.value;
  const pid=document.querySelector("#per-proyectoSel")?.value;
  if(!clave || !pid){ persistDB(); return; }
  const pr=ensureProyecto(clave,pid);
  if(database){
    database.ref(`${clave}/proyectos/${pid}/personal`).set(pr.personal)
      .catch(error=>{
        console.error("Error al guardar datos en Firebase:", error);
        alert("Error: No se pudieron guardar los cambios en la nube.");
      });
  }

  persistLocalCache();

}

function persistVehiculos(){
  const clave=document.querySelector("#veh-empresaSel")?.value;
  const pid=document.querySelector("#veh-proyectoSel")?.value;
  if(!clave || !pid){ persistDB(); return; }
  const pr=ensureProyecto(clave,pid);
  if(database){
    database.ref(`${clave}/proyectos/${pid}/vehiculos`).set(pr.vehiculos)
      .catch(error=>{
        console.error("Error al guardar datos en Firebase:", error);
        alert("Error: No se pudieron guardar los cambios en la nube.");
      });
  }

  persistLocalCache();

}

function cargarUsuariosDesdeFirebase(){
  if(!database){
    USERS = JSON.parse(localStorage.getItem("usuariosApp")||"{}") || {};
    return;
  }
  const usersRef = database.ref('usuarios');
  usersRef.once('value')
    .then(snap => {
      USERS = snap.val() || {};
      localStorage.setItem("usuariosApp", JSON.stringify(USERS));
      renderUsuarios();
      console.log("Usuarios sincronizados con Firebase.");
    })
    .catch(err => {
      console.error("Error al leer usuarios de Firebase:", err);
    });
}

function cargarHistorialDesdeFirebase(){
  if(!database){
    HISTORIAL = {};
    return;
  }
  const histRef = database.ref('historial').limitToLast(100);
  histRef.once('value')
    .then(snap => {
      const data = snap.val() || {};
      HISTORIAL = {};
      Object.values(data).forEach(item => {
        const key = (item.proyecto || '').toLowerCase();
        if(!HISTORIAL[key]) HISTORIAL[key] = [];
        HISTORIAL[key].push(item);
      });
    })
    .catch(err => {
      console.error('Error al leer historial de Firebase:', err);
    });
}

function guardarHistorialRegistro(entry){
  if(!database) return;
  database.ref('historial').push(entry).catch(err=>{
    console.error('Error al guardar historial en Firebase:', err);
  });
}

function obtenerHistorialProyecto(nombre){
  const key = (nombre || '').toLowerCase();
  return HISTORIAL[key] || [];
}

function cargarDatosDesdeFirebase(){
  if (!database) {
    DBCACHE = {};
    REMOTE_SNAPSHOT = {};
    persistLocalCache();
    renderDashboard();
    refreshSelectorsAll();
    refreshEmpresaList();
    renderYPFB();
    checkResponsableRole();
    return;
  }
  const dbRef = database.ref();
  const applySnapshot = snapshot => {
    const data = snapshot.val() || {};
    const sanitized = persistRemoteBackup(data);
    persistLocalCache(sanitized);
    console.log("Datos sincronizados desde Firebase (modo tiempo real).");
    renderDashboard();
    refreshSelectorsAll();
    refreshEmpresaList();
    renderYPFB();
    checkResponsableRole();
  };
  dbRef.on('value', applySnapshot, error => {
    console.error("Error al leer datos de Firebase:", error);
    alert("Error de conexi√≥n con la base de datos en la nube. Revisa tu conexi√≥n a internet.");
  });
}

function logProyecto(clave,pid){
  if(!clave || !pid) return;
  const pr = ensureProyecto(clave,pid);
  pr.updatedAt = nowIso();
}

function populatePersonalList(){
  const dl=document.getElementById("personal-list");
  PERSONAL_LIST.forEach(p=>{const o=document.createElement("option"); o.value=p.nombre; o.dataset.correo=p.correo; dl.appendChild(o);});
}

function refreshEmpresaList(){
  const dl=document.getElementById("empresas-list");
  if(!dl) return;
  const empresas = empresaKeys().filter(clave=>{
    const emp=DBCACHE[clave];
    const n=emp?.empresa?.datos?.empresa || emp?.empresa?.nombre;
    if(!n) return false;
    if(ES_RESPONSABLE && !USUARIO.admin){
      return Object.values(emp.proyectos||{}).some(pr=> esResponsableEnProyecto(pr, USUARIO.correo));
    }
    return true;
  });
  dl.innerHTML = empresas.map(clave=>{
    const n = DBCACHE[clave]?.empresa?.datos?.empresa || DBCACHE[clave]?.empresa?.nombre || clave;
    return `<option value="${n}"></option>`;
  }).join("");
}

function toggleAdminUI(isAdmin){
  const adminTab=document.querySelector('[data-tab="usuarios"]');
  if(adminTab) adminTab.style.display=isAdmin?"flex":"none";
}

function toggleResponsableUI(isResp){
  const active = document.querySelector('.sidebar .tab.active')?.dataset.tab;
  if(isResp){
    let allowed=new Set(['cards','ypfb','resp']);
    READONLY=true;
    if(USER_ROLES.has('SST')){
      ['empresa','ls025','personal','vehiculos','resumen'].forEach(t=>allowed.add(t));
      READONLY=false;
    }
    if(USER_ROLES.has('MA') || USER_ROLES.has('RSE')){
      ['ls025','resumen'].forEach(t=>allowed.add(t));
      READONLY=false;
    }
    document.querySelectorAll('.sidebar .tab').forEach(t=>{
      t.style.display = allowed.has(t.dataset.tab) ? 'flex' : 'none';
    });
    if(!active || !allowed.has(active)) switchTab('cards');
  }else{
    READONLY=false;
    document.querySelectorAll('.sidebar .tab').forEach(t=>{t.style.display='';});
  }
}

function esResponsableEnProyecto(pr, correo){
  const resp = pr?.proyecto?.responsables || {};
  return resp.proyecto?.correo===correo || resp.sst?.correo===correo || resp.ma?.correo===correo || resp.rse?.correo===correo;
}

function tieneAsignacionResponsable(correo){
  if(!correo) return false;
  return empresaKeys().some(k=>{
    const emp=DBCACHE[k];
    return Object.values(emp.proyectos||{}).some(pr=> esResponsableEnProyecto(pr, correo));
  });
}

function rolesUsuario(correo){
  const roles = new Set();
  if(!correo) return roles;
  empresaKeys().forEach(k=>{
    const emp=DBCACHE[k];
    Object.values(emp.proyectos||{}).forEach(pr=>{
      const resp = pr.proyecto?.responsables || {};
      if(resp.sst?.correo===correo) roles.add('SST');
      if(resp.ma?.correo===correo) roles.add('MA');
      if(resp.rse?.correo===correo) roles.add('RSE');
    });
  });
  return roles;
}

function checkResponsableRole(){
  ES_RESPONSABLE=false;
  USER_ROLES = new Set();
  if(!USUARIO || !USUARIO.correo) return;
  ES_RESPONSABLE = tieneAsignacionResponsable(USUARIO.correo);
  if(ES_RESPONSABLE) USER_ROLES = rolesUsuario(USUARIO.correo);
  if(!USUARIO.admin) toggleResponsableUI(ES_RESPONSABLE);
}

/* =============================================================== */
function confirmLogin(){
  const nombre=$("#login-nombre").value.trim();
  const correo=$("#login-correo").value.trim().toLowerCase();
  const pass1=$("#login-pass1").value.trim();
  const pass2=$("#login-pass2").value.trim();
  const codigoInput=$("#login-codigo");
  const codigo=codigoInput?codigoInput.value.trim():"";
  const remember=$("#login-remember").checked;
  const key=codigo||correo;
  if(!nombre||!correo||!pass1){alert("Complete los datos");return;}
  let u=USERS[key];
  if(u){
    if(u.pass!==pass1){alert("Contrase√±a incorrecta");return;}
    u.ultimoLogin = new Date().toISOString();
  }else{
    if(pass1!==pass2){alert("Las contrase√±as no coinciden");return;}
    u={codigo:key,nombre,correo,pass:pass1,fecha:new Date().toISOString(), ultimoLogin:new Date().toISOString()};
    USERS[key]=u;
  }
  if(correo!=="david.machaca@ypfbtransporte.com.bo" && !tieneAsignacionResponsable(correo)){
    alert("No tiene responsabilidades asignadas en ning√∫n proyecto.");
    return;
  }
  localStorage.setItem("usuariosApp",JSON.stringify(USERS));
  if(database){
    database.ref('usuarios/'+key).set(u).catch(err=>{
      console.error("Error al guardar usuario en Firebase:", err);
    });
  }
  USUARIO={codigo:key,nombre,correo,admin:correo==="david.machaca@ypfbtransporte.com.bo"};
  if(remember){
    localStorage.setItem("usuarioActual",JSON.stringify(USUARIO));
  }else{
    sessionStorage.setItem("usuarioActual",JSON.stringify(USUARIO));
    localStorage.removeItem("usuarioActual");
  }
  $("#userEmail").value=correo;
  $("#login-modal").style.display="none";
  toggleAdminUI(USUARIO.admin);
  if(USUARIO.admin){
    renderUsuarios();
    setTimeout(()=>{iniciarAsistenteIA();},1000);
  }
  renderYPFB();
  checkResponsableRole();
  checkAiAccess();
}

function resetLoginForm(){
  const nombreInput=$("#login-nombre");
  if(nombreInput) nombreInput.value="";
  const correoInput=$("#login-correo");
  if(correoInput){
    correoInput.value="";
    correoInput.readOnly=false;
  }
  const codigoInput=$("#login-codigo");
  if(codigoInput) codigoInput.value="";
  const pass1=$("#login-pass1");
  if(pass1) pass1.value="";
  const pass2=$("#login-pass2");
  if(pass2){
    pass2.value="";
    pass2.style.display="block";
  }
  const remember=$("#login-remember");
  if(remember) remember.checked=false;
}

function applyPersonaToLogin(per){
  if(!per) return;
  const nombreInput=$("#login-nombre");
  if(nombreInput) nombreInput.value=per.nombre || "";
  const correoInput=$("#login-correo");
  if(correoInput){
    correoInput.value=per.correo || "";
    correoInput.readOnly=!!per.correo;
  }
  const codigoInput=$("#login-codigo");
  if(codigoInput) codigoInput.value=per.codigo || "";
  const pass2=$("#login-pass2");
  if(pass2){
    const keyCodigo = per.codigo ? USERS[per.codigo] : null;
    const keyCorreo = per.correo ? USERS[per.correo.toLowerCase()] : null;
    const exists = keyCodigo || keyCorreo;
    pass2.style.display = exists?"none":"block";
    pass2.value="";
  }
}

function handleLoginNombreChange(e){
  const per = PERSONAL_LIST.find(p=>p.nombre===e.target.value);
  if(per){
    applyPersonaToLogin(per);
  }else{
    const correoInput=$("#login-correo");
    if(correoInput) correoInput.readOnly=false;
    const codigoInput=$("#login-codigo");
    if(codigoInput) codigoInput.value="";
    const pass2=$("#login-pass2");
    if(pass2) pass2.style.display="block";
  }
}

let loginListenersReady=false;
function attachLoginListeners(){
  if(loginListenersReady) return;
  const nombreInput=$("#login-nombre");
  if(!nombreInput) return;
  nombreInput.addEventListener("change", handleLoginNombreChange);
  loginListenersReady=true;
}

function showLoginModal(){
  attachLoginListeners();
  resetLoginForm();
  const modal=$("#login-modal");
  if(modal) modal.style.display="flex";
  const nombreInput=$("#login-nombre");
  if(nombreInput) nombreInput.focus();
}

function renderUsuarios(){
  const cont=$("#usuarios-cards");
  if(!cont) return;
  const arr = Object.values(USERS||{});
  cont.innerHTML="";
  arr.forEach(u=>{
    const esMujer = /a$/i.test(u.nombre.split(' ')[0]);
    const avatar = esMujer ? 'üë©' : 'üë®';
    const fecha = new Date(u.fecha).toLocaleDateString();
    cont.innerHTML += `<div class="cardx"><div class="user-card"><div class="user-card-img" style="display:flex;align-items:center;justify-content:center;font-size:32px">${avatar}</div><div><h4>${u.nombre}</h4><div>${u.codigo}</div><div>${u.correo}</div><div>${fecha}</div></div></div></div>`;
  });
  $("#usuarios-count").textContent = arr.length;
}

/* ================== Cat√°logos ================== */
const CATALOG_LS025 = [
  {id:"L001", bloque:"Requisitos Generales del Proyecto", txt:"Descripci√≥n y Alcance general del Proyecto", req:true},
  {id:"L002", bloque:"Requisitos Generales del Proyecto", txt:"Permiso de Trabajo No Rutinario y/o Orden de Trabajo (FS.059)", req:true},
  {id:"L003", bloque:"Requisitos Generales del Proyecto", txt:"Cronograma de Trabajo y roles de turno del personal", req:true},
  {id:"L004", bloque:"Requisitos Generales del Proyecto", txt:"Plan de Movilizaci√≥n e Instalaci√≥n de Campamentos", req:true},
  {id:"L005", bloque:"Requisitos Generales del Proyecto", txt:"Plan de Preparaci√≥n y Respuesta ante Emergencias (ITS.016)", req:true},
  {id:"L006", bloque:"Requisitos Generales del Proyecto", txt:"Programa de Gesti√≥n de Seguridad y Salud en el Trabajo (NTS.009)", req:true},
  {id:"L007", bloque:"Requisitos Generales del Proyecto", txt:"Evaluaci√≥n de Riesgos de SSO (FS.082)", req:true},
  {id:"L008", bloque:"Requisitos Generales del Proyecto", txt:"Tratamiento de Riesgos / FS.072 (control, mitigaci√≥n, contingencia)", req:true},
  {id:"L009", bloque:"Requisitos Generales del Proyecto", txt:"Participaci√≥n de trabajadores en gesti√≥n de riesgos y oportunidades", req:true},
  {id:"L010", bloque:"Requisitos Generales del Proyecto", txt:"Procedimientos espec√≠ficos (Operativos, MA, Seguridad)", req:false},
  {id:"L011", bloque:"Requisitos Generales del Proyecto", txt:"Certificados de Calibraci√≥n de Medidores de Gases", req:false},
  {id:"L012", bloque:"Requisitos Generales del Proyecto", txt:"Inspecci√≥n de Herramientas (el√©ctricas, manuales, neum√°ticas, etc.)", req:false},
  {id:"L013", bloque:"Requisitos Generales del Proyecto", txt:"HDSM ‚Äì Hoja de Datos de Seguridad del Material", req:true},
  {id:"L014", bloque:"Requisitos Generales del Proyecto", txt:"Permiso SENASAG para uso de Pesticidas/Plaguicidas (si aplica)", req:true},

  {id:"L015", bloque:"Requisitos Generales del Personal", txt:"Planilla detallada del personal asignado al proyecto/servicio", req:true},
  {id:"L016", bloque:"Requisitos Generales del Personal", txt:"Organigrama del Proyecto/Servicio", req:false},
  {id:"L017", bloque:"Requisitos Generales del Personal", txt:"Descripci√≥n de responsabilidades (manual de funciones/perfil de cargo)", req:false},
  {id:"L018", bloque:"Requisitos Generales del Personal", txt:"Carnet de Identidad vigente", req:true},
  {id:"L019", bloque:"Requisitos Generales del Personal", txt:"Curso de Primeros Auxilios (‚â• 8h, vigencia 3 a√±os)", req:true},
  {id:"L020", bloque:"Requisitos Generales del Personal", txt:"Curso Control de Incendios y manejo de Extintores (vigencia 3 a√±os)", req:true},
  {id:"L021", bloque:"Requisitos Generales del Personal", txt:"Curso de Uso de EPP (vigencia 3 a√±os)", req:true},
  {id:"L022", bloque:"Requisitos Generales del Personal", txt:"Curso de Ergonom√≠a (vigencia 3 a√±os)", req:true},
  {id:"L023", bloque:"Requisitos Generales del Personal", txt:"Curso de Comunicaci√≥n de Peligros (vigencia 3 a√±os)", req:true},
  {id:"L024", bloque:"Requisitos Generales del Personal", txt:"Registro de Dotaci√≥n de EPP", req:true},
  {id:"L025", bloque:"Requisitos Generales del Personal", txt:"Cursos espec√≠ficos seg√∫n tarea", req:true},
  {id:"L026", bloque:"Requisitos Generales del Personal", txt:"Vacuna Fiebre Amarilla", req:true},
  {id:"L027", bloque:"Requisitos Generales del Personal", txt:"Vacuna Difteria y T√©tanos", req:true},
  {id:"L028", bloque:"Requisitos Generales del Personal", txt:"Vacuna Influenza (anual)", req:true},

  {id:"L029", bloque:"Personal Mayor a 90 d√≠as", txt:"Contrato de Trabajo visado", req:true},
  {id:"L030", bloque:"Personal Mayor a 90 d√≠as", txt:"Seguro M√©dico (Afiliaci√≥n y Aportes)", req:true},
  {id:"L031", bloque:"Personal Mayor a 90 d√≠as", txt:"Planilla de Aporte y afiliaci√≥n a Gestora", req:true},

  {id:"L032", bloque:"Personal Menor a 90 d√≠as", txt:"Contrato de Trabajo firmado", req:true},
  {id:"L033", bloque:"Personal Menor a 90 d√≠as", txt:"Seguro de Salud Privado (m√≠n. 10.000 USD)", req:true},
  {id:"L034", bloque:"Personal Menor a 90 d√≠as", txt:"Seguro contra Accidentes (m√≠n. 10.000 USD)", req:true},
  {id:"L035", bloque:"Personal Menor a 90 d√≠as", txt:"Seguro de Vida (m√≠n. 20.000 USD)", req:true},

  {id:"L036", bloque:"Consultores Externos", txt:"Seguro de Salud Privado (m√≠n. 10.000 USD)", req:true},
  {id:"L037", bloque:"Consultores Externos", txt:"Seguro contra Accidentes (m√≠n. 10.000 USD)", req:true},
  {id:"L038", bloque:"Consultores Externos", txt:"Seguro de Vida (m√≠n. 20.000 USD)", req:true},

  {id:"L039", bloque:"Fuera de Bolivia", txt:"Contrato visado por Ministerio de Trabajo", req:true},
  {id:"L040", bloque:"Fuera de Bolivia", txt:"Seguro de Salud Internacional (hasta 100.000 USD)", req:true},
  {id:"L041", bloque:"Fuera de Bolivia", txt:"Seguro contra Accidentes (m√≠n. 10.000 USD)", req:true},
  {id:"L042", bloque:"Fuera de Bolivia", txt:"Seguro de Vida (m√≠n. 20.000 USD)", req:true},

  {id:"L043", bloque:"Extranjero en Bolivia", txt:"Contrato visado (>90d) o contrato pa√≠s de origen (‚â§90d)", req:true},
  {id:"L044", bloque:"Extranjero en Bolivia", txt:"Seguro de Salud Internacional (hasta 100.000 USD)", req:true},
  {id:"L045", bloque:"Extranjero en Bolivia", txt:"Seguro contra Accidentes (m√≠n. 10.000 USD)", req:true},
  {id:"L046", bloque:"Extranjero en Bolivia", txt:"Seguro de Vida (m√≠n. 20.000 USD)", req:true},

  {id:"L047", bloque:"Bioseguridad", txt:"Vacunas COVID-19 (‚â•3 dosis)", req:true},

  {id:"L048", bloque:"Riesgo Salud", txt:"Evaluaci√≥n m√©dica FS.100", req:true},
  {id:"L049", bloque:"Riesgo Salud", txt:"An√°lisis m√©dicos seg√∫n gu√≠a FS.100", req:true},

  {id:"L050", bloque:"Conductores y/u Operadores", txt:"Licencia de Conducci√≥n Defensiva y 4x4 Vigente", req:true},
  {id:"L051", bloque:"Conductores y/u Operadores", txt:"Licencia de Tr√°nsito Vigente", req:true},
  {id:"L052", bloque:"Conductores y/u Operadores", txt:"Certificados de Operador de Equipo Pesado / Licencia correspondiente", req:true},

  {id:"L053", bloque:"Manipulaci√≥n de Alimentos", txt:"Carnet Sanitario Vigente", req:true},
  {id:"L054", bloque:"Manipulaci√≥n de Alimentos", txt:"Curso de BPM/BPH o Inocuidad Alimentaria", req:true},

  {id:"L055", bloque:"Supervisor SSMS / Salud", txt:"Curr√≠culum SSMS + respaldos", req:true},
  {id:"L056", bloque:"Supervisor SSMS / Salud", txt:"Certificaci√≥n del Curso de SSMS40", req:true},
  {id:"L057", bloque:"Supervisor SSMS / Salud", txt:"Cumplimiento RM 595/16 (Registro Nacional)", req:true},
  {id:"L058", bloque:"Supervisor SSMS / Salud", txt:"Matr√≠cula Profesional y Registro (Colegio M√©dico)", req:true},

  {id:"L059", bloque:"Veh√≠culos Livianos y Semi-Pesados", txt:"Listado de veh√≠culos", req:true},
  {id:"L060", bloque:"Veh√≠culos Livianos y Semi-Pesados", txt:"Checklist de veh√≠culos (vigencia 1 mes / antig√ºedad)", req:true},
  {id:"L061", bloque:"Veh√≠culos Livianos y Semi-Pesados", txt:"CRPVA / RUAT", req:true},
  {id:"L062", bloque:"Veh√≠culos Livianos y Semi-Pesados", txt:"ITV y SOAT", req:true},
  {id:"L063", bloque:"Veh√≠culos Livianos y Semi-Pesados", txt:"P√≥liza RC Contractual ‚â• 30.000 USD", req:true},
  {id:"L064", bloque:"Veh√≠culos Livianos y Semi-Pesados", txt:"Certificado de Monitoreo Satelital", req:true},

  {id:"L065", bloque:"Equipo Pesado", txt:"Certificaci√≥n + P√≥lizas de Seguro", req:true},
  {id:"L066", bloque:"Equipo Pesado", txt:"Checklist de equipos (vigencia 1 mes)", req:true},

  {id:"L067", bloque:"Medio Ambiente (No rutinarias)", txt:"Plan de Medio Ambiente", req:true},
  {id:"L068", bloque:"Medio Ambiente (No rutinarias)", txt:"Aspectos Ambientales (FS-082)", req:true},
  {id:"L069", bloque:"Medio Ambiente (No rutinarias)", txt:"Medidas de Control (FS-072)", req:false},
  {id:"L070", bloque:"Medio Ambiente (No rutinarias)", txt:"Licencia Ambiental de YPFB TR", req:true},
  {id:"L071", bloque:"Medio Ambiente (No rutinarias)", txt:"Licencia Ambiental/permiso de Contratista", req:true},
  {id:"L072", bloque:"Medio Ambiente (No rutinarias)", txt:"LASP YPFB TR (si manipulan)", req:false},
  {id:"L073", bloque:"Medio Ambiente (No rutinarias)", txt:"LASP de la Contratista (si manipulan)", req:false},
  {id:"L074", bloque:"Medio Ambiente (No rutinarias)", txt:"Medici√≥n de gases de combusti√≥n (Anual)", req:true},
  {id:"L075", bloque:"Medio Ambiente (No rutinarias)", txt:"Medici√≥n de ruido (fijas/m√≥viles)", req:false},
  {id:"L076", bloque:"Medio Ambiente (No rutinarias)", txt:"Permiso de Desmonte de YPFB TR", req:false},
  {id:"L077", bloque:"Medio Ambiente (No rutinarias)", txt:"Empresa Desmontadora habilitada (ABT)", req:false},
  {id:"L078", bloque:"Medio Ambiente (No rutinarias)", txt:"Licencia/Autorizaci√≥n de √°ridos/agregados", req:false},
  {id:"L079", bloque:"Medio Ambiente (No rutinarias)", txt:"Registro SAO + personal autorizado", req:false},
  {id:"L080", bloque:"Medio Ambiente (No rutinarias)", txt:"Tabla compromisos PPM-PASA", req:true},

  {id:"L081", bloque:"Est√°ndares / Procedimientos / Planes", txt:"Conservaci√≥n de Biodiversidad", req:true},
  {id:"L082", bloque:"Est√°ndares / Procedimientos / Planes", txt:"Gesti√≥n de Residuos", req:true},
  {id:"L083", bloque:"Est√°ndares / Procedimientos / Planes", txt:"Preventivas Ambientales", req:false},
  {id:"L084", bloque:"Est√°ndares / Procedimientos / Planes", txt:"Aguas Residuales y Pluviales", req:false},
  {id:"L085", bloque:"Est√°ndares / Procedimientos / Planes", txt:"Aguas de Pruebas Hidrost√°ticas", req:false},
  {id:"L086", bloque:"Est√°ndares / Procedimientos / Planes", txt:"Prevenci√≥n y Control de Derrames", req:false},
  {id:"L087", bloque:"Est√°ndares / Procedimientos / Planes", txt:"Recursos Culturales y Arqueol√≥gicos", req:false},
  {id:"L088", bloque:"Est√°ndares / Procedimientos / Planes", txt:"Contaminaci√≥n Atmosf√©rica", req:false},
  {id:"L089", bloque:"Est√°ndares / Procedimientos / Planes", txt:"Medici√≥n de Ruido en Fuentes", req:false},
  {id:"L090", bloque:"Est√°ndares / Procedimientos / Planes", txt:"Manejo de Asbestos y PCB's (si aplica)", req:false},
  {id:"L091", bloque:"Est√°ndares / Procedimientos / Planes", txt:"Desmonte (procedimiento)", req:false},

  {id:"L092", bloque:"Social", txt:"C√≥digo de Conducta + inducci√≥n", req:true},
  {id:"L093", bloque:"Social", txt:"Pol√≠tica de SSM y RSE", req:true},
  {id:"L094", bloque:"Social", txt:"Capacitaci√≥n en C√≥digo de Conducta y Pol√≠tica SSMS y RSE", req:true},
  {id:"L095", bloque:"Social", txt:"Plan de Relacionamiento Comunitario espec√≠fico", req:false},
];

const CAT_PERSONAL = {
  "Documentos":{P_DOC_CI:"Copia CI", P_DOC_CONTRATO_VISADO:"Contrato Visado", P_DOC_CARNET_SANITARIO:"Carnet Sanitario"},
  "Vacunas":{P_VAC_FA:"Fiebre Amarilla", P_VAC_DIF_TET:"Difteria/T√©tanos", P_VAC_INFLU:"Influenza", P_VAC_COVID:"COVID-19 (‚â•3)"},
  "Cursos":{P_CUR_EPP:"EPP", P_CUR_COM_PEL:"Comunicaci√≥n de Peligros", P_CUR_1AUX:"Primeros Auxilios", P_CUR_INC:"Contra Incendios", P_CUR_INT_MA:"Intro Medio Ambiente", P_CUR_ERG:"Ergonom√≠a", P_CUR_BPM_BPH:"BPM/BPH", P_CUR_ESPEC:"Curso Espec√≠fico"},
  "Personal > 90 d√≠as":{P_M90_SEGURO_MED:"Seguro M√©dico", P_M90_APORTE_GEST:"Aportes Gestora", P_M90_AVISO_AFIL:"Aviso Afiliaci√≥n"},
  "Personal < 90 d√≠as":{P_MEN90_SEG_SALUD_PRIV:"Salud Privado 10k", P_MEN90_SEG_ACC:"Accidente 10k", P_MEN90_SEG_VIDA:"Vida 20k"},
  "Extranjeros / Exterior":{P_EXT_CONTRATO_MT:"Contrato MT / Pa√≠s", P_EXT_SEG_SALUD_INT:"Salud Internacional 100k", P_EXT_SEG_ACC:"Accidente 10k", P_EXT_SEG_VIDA:"Vida 20k"},
  "Riesgo Salud":{P_RIESGO_FS100:"FS.100 Aptitud", P_RIESGO_EXAMENES:"Ex√°menes de Riesgo"},
  "Conductores / Operadores":{P_COND_DEF:"Lic. Conducci√≥n Def.", P_COND_4X4:"Lic. 4x4", P_COND_CERT_OPER:"Cert. Operador", P_COND_LIC_TRANS:"Lic. Tr√°nsito", P_COND_CARNET_OPER:"Carnet Operador"},
  "Supervisor SSMS / Salud":{P_SSMS_CV:"CV SSMS", P_SSMS_CERT40:"SSMS40", P_SSMS_RM595:"RM 595/16", P_MED_MAT_PROF_REG:"Matr√≠cula/Registro M√©dico"}
};
const GUIAS_PERFILES = {
  CONDUCTOR:["GM_VISION","GM_AUDIO_EQ","GM_ECG","GM_INF_MED","GM_OBES"],
  PATRULLAJE_GLP:["GM_ECG","GM_INF_MED","GM_OBES"],
  SOLDADURA_AMOLADO:["GM_VISION","GM_AUDIO_EQ","GM_ECG","GM_INF_MED","GM_OBES"],
  MONTACARGAS:["GM_VISION","GM_EEG","GM_AUDIO_EQ","GM_ECG","GM_INF_MED","GM_OBES"],
  ESPACIOS_CONFINADOS:["GM_VISION","GM_EEG","GM_AUDIO_EQ","GM_ECG","GM_INF_MED","GM_OBES","GM_ESPIRO"],
  GRUA_IZAJE:["GM_VISION","GM_EEG","GM_AUDIO_EQ","GM_ECG","GM_INF_MED","GM_OBES"],
  ALTURAS:["GM_VISION","GM_EEG","GM_AUDIO_EQ","GM_ECG","GM_INF_MED","GM_OBES"],
  BUCEO_COMERCIAL:["GM_VISION","GM_EEG","GM_AUDIO_EQ","GM_ECG","GM_INF_MED","GM_ESPIRO"],
  PLAGUICIDAS:["GM_SANGRE"],
  SOBRE_3000_MSNM:["GM_ECG","GM_INF_MED","GM_OBES","GM_ESPIRO"]
};
const GUIAS_LABELS = {
  GM_VISION:"Visi√≥n", GM_EEG:"Electroencefalograma", GM_AUDIO_EQ:"Audiometr√≠a y equilibrio", GM_ECG:"Electrocardiograma",
  GM_INF_MED:"Informe M√©dico", GM_OBES:"Obesidad", GM_ESPIRO:"Espirometr√≠a", GM_SANGRE:"Pruebas de sangre"
};

const MAP_PERSONAL_TO_LS025 = {
  P_DOC_CI:"L018",
  P_CUR_1AUX:"L019",
  P_CUR_INC:"L020",
  P_CUR_EPP:"L021",
  P_CUR_ERG:"L022",
  P_CUR_COM_PEL:"L023",
  P_CUR_ESPEC:"L025",
  P_VAC_FA:"L026",
  P_VAC_DIF_TET:"L027",
  P_VAC_INFLU:"L028"
};

const MAP_VEH_TO_LS025 = {
  V_LISTADO:"L059",
  V_CHECKLIST:"L060",
  V_RUAT_CRPVA:"L061",
  V_ITV:"L062",
  V_SOAT:"L062",
  V_POLIZA_RC:"L063",
  V_SATELITAL:"L064"
};

/* ================== Utilidades ================== */
function chipsInit(containerSel){
  $$(containerSel+" .chip input").forEach(ch=>{
    const up = ()=> ch.parentElement.classList.toggle("active", ch.checked);
    ch.addEventListener("change", up); up();
  });
}
function getTiposFromChips(containerSel){return $$(containerSel+" .chip input").filter(x=>x.checked).map(x=>x.value);}

function ensureEmpresa(clave){
  if(!DBCACHE[clave]){
    DBCACHE[clave] = { empresa:null, proyectos:{} };
  }else if(!DBCACHE[clave].proyectos){
    DBCACHE[clave].proyectos = {};
  }
  return DBCACHE[clave];
}
function DBCacheHasEmpresa(clave){ return !!DBCACHE[clave]; }
function ensureProyecto(clave, pid){
  const emp = ensureEmpresa(clave);
  if(!emp.proyectos[pid]) emp.proyectos[pid] = { proyecto:null, ls025:null, personal:[], vehiculos:[], updatedAt:null, conflicts:[], historial:[] };
  const pr = emp.proyectos[pid];
  if(!pr.personal) pr.personal = [];
  if(!pr.vehiculos) pr.vehiculos = [];
  if(!pr.historial) pr.historial = [];
  return pr;
}
function slugify(str){
  return str.toLowerCase()
            .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
            .replace(/[^a-z0-9]+/g,"-")
            .replace(/(^-|-$)/g,"");
}

function sanitizeName(name){
  return (name || '').replace(/[\/\\:?*"<>|#%]/g, '-');
}
function computeEstadoRapido_SPN(items){
  // items: array of 'S' | 'N' | 'NA' | ''
  let hasS = false;
  for(const v of items){
    if(v === "N") return "OBSERVADO";
    if(v === "S") hasS = true;
  }
  return hasS ? "APROBADO" : "PARCIAL";
}

function registrarRevision(clave,pid,estSST,estMA,estRSE,estPer,estVeh,responsable,accion,correo){
  const pr = ensureProyecto(clave,pid);
  if(!pr.historial) pr.historial=[];
  pr.historial.push({
    rev: pr.historial.length+1,
    fecha: nowIso(),
    responsable: responsable||"",
    correo: correo||"",
    accion: accion||"Revisi√≥n",
    estados:{sst:estSST, ma:estMA, rse:estRSE, personal:estPer, vehiculos:estVeh}
  });
  persistDB();
  verificarRevisionesCompletas(clave,pid);
}

function verificarRevisionesCompletas(clave,pid){
  const pr = ensureProyecto(clave,pid);
  if(!pr?.proyecto?.responsables) return;
  const sst = pr.proyecto.responsables.sst?.correo || "";
  const ma  = pr.proyecto.responsables.ma?.correo || "";
  const rse = pr.proyecto.responsables.rse?.correo || "";
  const correos = [sst,ma,rse].filter(Boolean);
  if(correos.length < 3) return; // faltan responsables
    const completadas = correos.every(c=>pr.historial?.some(h=>h.correo===c));
    const yaNotif = pr.historial?.some(h=>h.accion==="Verificaci√≥n completa");
    if(completadas && !yaNotif){
      const creator = pr.proyecto?.capturadoPor || "";
      if(creator){
        enviarCorreoOutlook(creator, `Revisiones completas ${pid}`, 'SST, MA y RSE finalizaron sus revisiones.');
      }
      const {estSST, estMA, estRSE, estPer, estVeh} = calcularEstados(pr);
      pr.historial.push({
        rev: pr.historial.length+1,
        fecha: nowIso(),
        responsable:"Sistema",
        correo:"",
        accion:"Verificaci√≥n completa",
        estados:{sst:estSST, ma:estMA, rse:estRSE, personal:estPer, vehiculos:estVeh}
      });
      persistDB(); renderDashboard(); renderResumen(); renderYPFB();
      const emp = DBCACHE[clave] || {};
      const empresaCorreo = emp.empresa?.datos?.correo || '';
      const respProyecto = pr.proyecto?.responsables?.proyecto?.correo || creator;
      const destinatarios = [empresaCorreo, respProyecto].filter(Boolean).join(',');
      const asuntoFin = `Carpeta revisada ${emp.empresa?.datos?.empresa || emp.empresa?.nombre || clave} ${pid}`;
      const cuerpoFin = 'Su carpeta fue revisada. Se adjunta el PDF con las observaciones para que subsanen o, si est√° aprobada, puede recoger la carpeta f√≠sica.';
      pdfYCorreo(clave,pid,{destinatarios,asunto:asuntoFin,cuerpo:cuerpoFin,skipRevision:true,accion:'Verificaci√≥n completa'});
    }
  }

/* ================== Fusi√≥n/ingesta de archivos ================== */
function ingest(obj){
  try{
    if(!obj || typeof obj !== "object") return;
    // v4 snapshot global por proyecto
    if(obj.schema === "ypfb.crm.v4.snapshot"){
      const clave = obj.empresa?.empresaClave || obj.empresaClave || "SINCLAVE";
      const pid = obj.proyecto?.proyectoId || obj.proyectoId || "P001";
      const emp = ensureEmpresa(clave);
      if(obj.empresa) emp.empresa = obj.empresa;
      const pr = ensureProyecto(clave, pid);
      if(obj.proyecto) pr.proyecto = obj.proyecto;
      if(obj.ls025) pr.ls025 = obj.ls025;
      if(obj.personal) pr.personal = obj.personal;
      if(obj.vehiculos) pr.vehiculos = obj.vehiculos;
      if(obj.historial) pr.historial = obj.historial;
      pr.updatedAt = obj.generadoEn || nowIso();
      return;
    }
    // v4 entidades
    if(obj.schema === "ypfb.crm.v4.empresa"){
      const clave = obj.empresaClave;
      const emp = ensureEmpresa(clave);
      emp.empresa = obj;
      return;
    }
    if(obj.schema === "ypfb.crm.v4.proyecto"){
      const pr = ensureProyecto(obj.empresaClave, obj.proyectoId);
      pr.proyecto = obj;
      pr.updatedAt = obj.capturadoEn || nowIso();
      return;
    }
    if(obj.schema === "ypfb.crm.v4.ls025"){
      const pr = ensureProyecto(obj.empresaClave, obj.proyectoId);
      // Fusionar por reqId: √∫ltimo por modificadoEn gana
      const prev = (pr.ls025 && pr.ls025.respuestas) ? pr.ls025.respuestas : [];
      const map = new Map(prev.map(r=>[r.reqId, r]));
      const conflicts = [];
      (obj.respuestas||[]).forEach(r=>{
        const cur = map.get(r.reqId);
        if(cur){
          const t1 = new Date(cur.modificadoEn||cur.capturadoEn||obj.capturadoEn||nowIso()).getTime();
          const t2 = new Date(r.modificadoEn||r.capturadoEn||obj.capturadoEn||nowIso()).getTime();
          if(Math.abs(t2 - t1) <= 10*60*1000 && (cur.autor||cur.capturadoPor)!==(r.autor||r.capturadoPor)){
            conflicts.push({reqId:r.reqId, a:(cur.autor||cur.capturadoPor)||"", b:(r.autor||r.capturadoPor)||""});
          }
          if(t2 >= t1) map.set(r.reqId, r);
        } else {
          map.set(r.reqId, r);
        }
      });
      pr.ls025 = {schema:"ypfb.crm.v4.ls025",version:1,empresaClave:obj.empresaClave,proyectoId:obj.proyectoId,respuestas:[...map.values()]};
      pr.updatedAt = obj.capturadoEn || nowIso();
      if(conflicts.length) pr.conflicts = conflicts;
      return;
    }
    if(obj.schema === "ypfb.crm.v4.personal"){
      const pr = ensureProyecto(obj.empresaClave, obj.proyectoId);
      pr.personal = obj.personal||[];
      pr.updatedAt = obj.capturadoEn || nowIso();
      return;
    }
    if(obj.schema === "ypfb.crm.v4.vehiculos"){
      const pr = ensureProyecto(obj.empresaClave, obj.proyectoId);
      pr.vehiculos = obj.vehiculos||[];
      pr.updatedAt = obj.capturadoEn || nowIso();
      return;
    }

    // Compatibilidad v3
    if(obj.schema === "ypfb.crm.snapshot"){
      const clave = (obj.empresa?.empresaId) || "SINCLAVE";
      const pid = "P001";
      const emp = ensureEmpresa(clave);
      emp.empresa = {schema:"ypfb.crm.v4.empresa",version:1,empresaClave:clave,datos:obj.empresa?.datos||obj.empresa||{}};
      const pr = ensureProyecto(clave, pid);
      pr.proyecto = {schema:"ypfb.crm.v4.proyecto",version:1,empresaClave:clave,proyectoId:pid, nombre: obj.empresa?.datos?.proyecto || "Proyecto", tipos: obj.empresa?.datos?.tiposCarpeta || []};
      if(obj.ls025) pr.ls025 = {schema:"ypfb.crm.v4.ls025",version:1,empresaClave:clave,proyectoId:pid,respuestas:obj.ls025.respuestas||[]};
      pr.personal = obj.personal||[];
      pr.vehiculos = obj.vehiculos||[];
      pr.updatedAt = obj.generadoEn || nowIso();
      return;
    }
    if(obj.schema === "ypfb.crm.hab.emp"){
      const clave = obj.empresaId;
      const emp = ensureEmpresa(clave);
      emp.empresa = {schema:"ypfb.crm.v4.empresa",version:1,empresaClave:clave,datos:obj.datos||{}};
      return;
    }
    if(obj.schema === "ypfb.crm.hab.ls025"){
      const clave = obj.empresaId, pid="P001";
      const pr = ensureProyecto(clave, pid);
      pr.ls025 = {schema:"ypfb.crm.v4.ls025",version:1,empresaClave:clave,proyectoId:pid,respuestas:obj.respuestas||[]};
      pr.updatedAt = obj.capturadoEn || nowIso();
      return;
    }
    if(obj.schema === "ypfb.crm.hab.personal"){
      const clave = obj.empresaId, pid="P001";
      const pr = ensureProyecto(clave, pid);
      pr.personal = obj.personal||[]; pr.updatedAt = obj.capturadoEn || nowIso(); return;
    }
    if(obj.schema === "ypfb.crm.hab.vehiculos"){
      const clave = obj.empresaId, pid="P001";
      const pr = ensureProyecto(clave, pid);
      pr.vehiculos = obj.vehiculos||[]; pr.updatedAt = obj.capturadoEn || nowIso(); return;
    }
  }catch(e){ console.warn("ingest error", e); }
}
async function loadAllFromDir(){
  if(!EXPORT_DIR_HANDLE || !(await ensurePermission(EXPORT_DIR_HANDLE))) return false;
  let count=0;
  for await (const [name, handle] of EXPORT_DIR_HANDLE.entries()){
    if(handle.kind==="file" && name.toLowerCase().endsWith(".json")){
      try{
        const file = await handle.getFile(); const txt = await file.text();
        const obj = JSON.parse(txt); ingest(obj); count++;
      }catch(e){ console.warn("JSON inv√°lido:", name, e); }
    }
  }
  persistDB();
  renderDashboard(); banner(`Cargado autom√°ticamente ${count} JSON desde carpeta BD.`);
  refreshSelectorsAll();
  return count>0;
}

/* ================== Dashboard ================== */
function pickGlobal(a,b,c){
  const vals=[a,b,c].filter(v=>v && v!=="NO APLICA");
  if(vals.includes("OBSERVADO")) return "OBSERVADO";
  if(vals.some(v=>v==="PARCIAL" || (v && v.startsWith("SIN")))) return "PARCIAL";
  return "APROBADO";
}
function estadoLSSST(ls){
  if(!ls || !ls.respuestas) return "PARCIAL";
  const ids = new Set(CATALOG_LS025.slice(0,66).map(it=>it.id));
  const vals = ls.respuestas.filter(r=>ids.has(r.reqId)).map(r=>r.valor||"");
  return computeEstadoRapido_SPN(vals);
}
function estadoLSMA(ls){
  if(!ls || !ls.respuestas) return "PARCIAL";
  const ids = new Set(CATALOG_LS025.slice(66,91).map(it=>it.id));
  const vals = ls.respuestas.filter(r=>ids.has(r.reqId)).map(r=>r.valor||"");
  return computeEstadoRapido_SPN(vals);
}
function estadoLSRSE(ls){
  if(!ls || !ls.respuestas) return "PARCIAL";
  const ids = new Set(CATALOG_LS025.slice(91,95).map(it=>it.id));
  const vals = ls.respuestas.filter(r=>ids.has(r.reqId)).map(r=>r.valor||"");
  return computeEstadoRapido_SPN(vals);
}
function estadoLS(ls){
  const a = estadoLSSST(ls), b = estadoLSMA(ls), c = estadoLSRSE(ls);
  return pickGlobal(a,b,c);
}
function estadoPersonal(arr){
  const visibles = (arr||[]).filter(p=>p.visible!==false);
  if(!visibles.length) return "SIN PERSONAL";
  const vals=[];
  visibles.forEach(p=>{
    Object.values(p.requisitos||{}).forEach(v=>{ if(v && v!=='NA') vals.push(v); });
    (p.guiasMedicas||[]).forEach(g=> Object.values(g.items||{}).forEach(v=>{ if(v && v!=='NA') vals.push(v); }));
  });
  return computeEstadoRapido_SPN(vals);
}
function estadoVehiculos(arr){
  const visibles = (arr||[]).filter(v=>v.visible!==false);
  if(!visibles.length) return "SIN VEHICULO";
  const vals=[];
  visibles.forEach(v=> Object.values(v.requisitos||{}).forEach(x=>{ if(x && x!=='NA') vals.push(x); }) );
  return computeEstadoRapido_SPN(vals);
}
function calcularEstados(pr){
  const tipos = pr.proyecto?.tipos || [];
  const estSST = tipos.includes('CI') ? estadoLSSST(pr.ls025) : 'NO APLICA';
  const estMA  = tipos.includes('CI') ? estadoLSMA(pr.ls025)  : 'NO APLICA';
  const estRSE = tipos.includes('CI') ? estadoLSRSE(pr.ls025) : 'NO APLICA';
  const personalVis = (pr.personal||[]).filter(p=>p.visible!==false);
  const vehiculosVis = (pr.vehiculos||[]).filter(v=>v.visible!==false);
  const hasPer = tipos.includes('HP') || personalVis.length;
  const hasVeh = tipos.includes('HV') || vehiculosVis.length;
  const estPer = hasPer ? estadoPersonal(personalVis) : 'NO APLICA';
  const estVeh = hasVeh ? estadoVehiculos(vehiculosVis) : 'NO APLICA';
  const estLS  = tipos.includes('CI') ? pickGlobal(estSST, estMA, estRSE) : 'NO APLICA';
  const est    = pickGlobal(estLS, estPer, estVeh);
  return {estSST, estMA, estRSE, estPer, estVeh, estLS, est};
}
function estadoProyecto(pr){
  return calcularEstados(pr).est;
}
function cls(est){
  if(est==="APROBADO" || est==="NO APLICA") return "aprob";
  if(est==="OBSERVADO") return "observ";
  if(est==="PARCIAL" || (est && est.startsWith("SIN"))) return "parcial";
  return "";
}

function renderDashboard(){
  const q = $("#search").value.trim().toLowerCase();
  const fTipo = $("#filtro-tipo").value;
  const fEstado = $("#filtro-estado").value;

  const empresas = empresaKeys().filter(clave=>{
    const emp = DBCACHE[clave];
    const nombre = emp?.empresa?.datos?.empresa || emp?.empresa?.nombre;
    if(!nombre) return false;
    if(ES_RESPONSABLE && !USUARIO.admin){
      return Object.values(emp.proyectos||{}).some(pr=> esResponsableEnProyecto(pr, USUARIO.correo));
    }
    return true;
  });
  $("#k-empresas").textContent = empresas.length;

  let proyectosCount=0, ap=0, pa=0, ob=0;

  const rows = empresas.map(clave=>{
    const emp = DBCACHE[clave] || {empresa:null, proyectos:{}};
    const empName = emp.empresa?.datos?.empresa || emp.empresa?.nombre || "";
    const proyectos = Object.keys(emp.proyectos||{}).filter(pid=>{
      if(ES_RESPONSABLE && !USUARIO.admin){
        const pr=emp.proyectos[pid];
        return esResponsableEnProyecto(pr, USUARIO.correo);
      }
      return true;
    }).map(pid=>{
      const pr = emp.proyectos[pid];
      const {estLS, estPer, estVeh, est} = calcularEstados(pr);
      if(est==="APROBADO") ap++; else if(est==="PARCIAL") pa++; else if(est==="OBSERVADO") ob++;
      proyectosCount++;
      return {pid, est, estLS, estPer, estVeh, nombre: pr.proyecto?.nombre||pid, tipos: pr.proyecto?.tipos||[], updated: pr.updatedAt};
    });
    const tiposUnion = Array.from(new Set(proyectos.flatMap(p=>p.tipos||[])));
    return {clave, empName, tipos: tiposUnion, proyectos};
  }).filter(row=>{
    if(!row.empName) return false;
    const baseTxt = (row.empName+" "+row.clave).toLowerCase();
    if(q && !baseTxt.includes(q)) return false;
    if(fTipo && !row.tipos.includes(fTipo)){
      // permitir filtrar por tipo en cualquier proyecto del grupo
      if(!row.proyectos.some(p=> (p.tipos||[]).includes(fTipo))) return false;
    }
    if(fEstado && !row.proyectos.some(p=>p.est===fEstado)) return false;
    return true;
  });

  $("#k-proyectos").textContent = proyectosCount;
  $("#k-aprob").textContent = ap; $("#k-parc").textContent = pa; $("#k-obsv").textContent = ob;

  // Render tarjetas
  const cards = $("#cards"); cards.innerHTML = "";
  rows.forEach(r=>{
    const div = document.createElement("div"); div.className="cardx";
    const proyectosHtml = r.proyectos.map(p=>`
      <div class="row" style="margin:6px 0;flex-wrap:wrap">
        <span class="pill">${p.pid}</span>
        <span style="margin-left:6px">${p.nombre}</span>
        <div class="spacer"></div>
        <span class="status ${cls(p.estLS)}">LS.025: ${p.estLS}</span>
        <span class="status ${cls(p.estPer)}" style="margin-left:6px">Personal: ${p.estPer}</span>
        <span class="status ${cls(p.estVeh)}" style="margin-left:6px">Veh√≠culos: ${p.estVeh}</span>
        <span class="note" style="margin-left:6px">${p.updated?new Date(p.updated).toLocaleDateString():""}</span>
        <div class="spacer"></div>
        <button class="btn small" onclick="abrirProyecto('${r.clave}','${p.pid}')">Editar</button>
        <button class="btn secondary small" onclick="verPDF('${r.clave}','${p.pid}')">PDF</button>
        <button class="btn secondary small" onclick="pdfYCorreo('${r.clave}','${p.pid}')">PDF + Correo</button>
      </div>
    `).join("");
    div.innerHTML = `
      <h4>${r.empName}</h4>
      <div class="note">${r.clave}</div>
      <div class="row" style="margin:6px 0">${(r.tipos||[]).map(t=>`<span class="pill">${t}</span>`).join("")||"<span class='note'>sin tipos</span>"}</div>
      <div>${proyectosHtml || "<div class='note'>Sin proyectos</div>"}</div>
    `;
    cards.appendChild(div);
  });

  // Render tabla
  const tb = $("#tabla-body"); tb.innerHTML="";
  rows.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.empName}</td>
      <td>${r.clave}</td>
      <td>${r.proyectos.map(p=>`${p.pid} ${p.nombre} <span class=\"status ${cls(p.estLS)}\">LS:${p.estLS}</span> <span class=\"status ${cls(p.estPer)}\">Per:${p.estPer}</span> <span class=\"status ${cls(p.estVeh)}\">Veh:${p.estVeh}</span>`).join("<br/>")}</td>
      <td><button class="btn small" onclick="abrirEmpresa('${r.clave}')">Abrir</button></td>
    `;
    tb.appendChild(tr);
  });

  drawAllCharts();
  refreshEmpresaList();
}
function renderYPFB(){
  const pend=[], rev=[];
  const correo=USUARIO.correo;
  if(!correo){
    $("#ypfb-pend").innerHTML = "<div class='note'>Inicie sesi√≥n</div>";
    $("#ypfb-rev").innerHTML = "";
    return;
  }
  empresaKeys().forEach(clave=>{
    const emp=DBCACHE[clave];
    Object.entries(emp.proyectos||{}).forEach(([pid,pr])=>{
      const resp=pr.proyecto?.responsables||{};
      let rol=null;
      if(resp.sst?.correo===correo) rol="SST";
      else if(resp.ma?.correo===correo) rol="MA";
      else if(resp.rse?.correo===correo) rol="RSE";
      if(rol){
        const revisado=(pr.historial||[]).some(h=>h.correo===correo);
        const est=estadoProyecto(pr);
        const card=`<div class="cardx" onclick="abrirProyecto('${clave}','${pid}',${revisado?1:0})"><h4>${emp.empresa?.datos?.empresa||clave} / ${pid}</h4><div class="small">${pr.proyecto?.nombre||""}</div><div class="small">Rol: ${rol}</div><div class="status ${cls(est)}">${est}</div></div>`;
        (revisado?rev:pend).push(card);
      }
    });
  });
  $("#ypfb-pend").innerHTML = pend.join("") || "<div class='note'>Sin pendientes</div>";
  $("#ypfb-rev").innerHTML = rev.join("") || "<div class='note'>Sin revisiones</div>";
}
function renderResponsable(){
  const cont = $("#resp-proyectos");
  if(!cont) return;
  const correo = USUARIO.correo;
  const cards = [];
  empresaKeys().forEach(clave=>{
    const emp=DBCACHE[clave];
    const nombreEmp = emp.empresa?.datos?.empresa || emp.empresa?.nombre || clave;
    Object.entries(emp.proyectos||{}).forEach(([pid,pr])=>{
      if(esResponsableEnProyecto(pr, correo)){
        const est = estadoProyecto(pr);
        const logs = (pr.historial||[]).map(h=>`<div class="hist-item">${h.fecha||""} ‚Äî ${h.responsable||""}: ${h.accion||""}</div>`).join("") || "<div class='note'>Sin registros</div>";
        const card = `<div class="cardx resp-card"><h4>${nombreEmp} / ${pid}</h4><div class="status ${cls(est)}">${est}</div><details><summary>Ver seguimiento</summary><div class="log">${logs}</div></details></div>`;
        cards.push(card);
      }
    });
  });
  cont.innerHTML = cards.join("") || "<div class='note'>Sin proyectos asignados</div>";
}
function toggleVista(){ const onCards = $("#cards").style.display!=="none"; $("#cards").style.display = onCards?"none":""; $("#tabla").style.display = onCards?"":"none"; }
$("#search").addEventListener("input", renderDashboard);
$("#filtro-tipo").addEventListener("change", renderDashboard);
$("#filtro-estado").addEventListener("change", renderDashboard);
$("#series-scale").addEventListener("change", drawAllCharts);

/* ================== Gr√°ficos Canvas (sin librer√≠as) ================== */
function drawDonut(canvas, aprob, parcial, observ){
  const ctx=canvas.getContext("2d"); const W=canvas.width, H=canvas.height; ctx.clearRect(0,0,W,H);
  const total=Math.max(1, aprob+parcial+observ);
  const data=[aprob,parcial,observ]; const colors=["#22c55e","#eab308","#ef4444"];
  let start=-Math.PI/2;
  const cx=W/2, cy=H/2, R=Math.min(W,H)/2-10, r=R*0.55;
  data.forEach((v,i)=>{ const ang= (v/total)*Math.PI*2; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,R,start,start+ang); ctx.closePath(); ctx.fillStyle=colors[i]; ctx.fill(); start+=ang; });
  // agujero
  ctx.globalCompositeOperation="destination-out";
  ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill(); ctx.globalCompositeOperation="source-over";
  ctx.fillStyle="#1e293b"; ctx.textAlign="center"; ctx.font="700 18px system-ui"; ctx.fillText(`A:${aprob} P:${parcial} O:${observ}`, cx, cy+6);
}
function drawRespChart(canvas, labels, values){

  const padTop=36, padBottom=36, padRight=40;
  const minRow=34;
  const desiredHeight=Math.max(padTop + padBottom + labels.length*minRow, 300);
  if(canvas.height !== desiredHeight){ canvas.height = desiredHeight; }
  const ctx=canvas.getContext("2d"); const W=canvas.width, H=canvas.height; ctx.clearRect(0,0,W,H);

  const padLeft=Math.max(120, Math.min(260, W*0.42));
  const rowBgX=Math.max(16, padLeft-180);
  const rowBgWidth=Math.max(0, W-rowBgX-padRight);
  const barMaxWidth=Math.max(0, W-padLeft-padRight);

  const bgGradient=ctx.createLinearGradient(0,0,0,H);
  bgGradient.addColorStop(0,"#f8fbff");
  bgGradient.addColorStop(1,"#eef4ff");
  ctx.fillStyle=bgGradient;
  ctx.fillRect(0,0,W,H);

  const max=Math.max(1, ...values);
  const rowCount=Math.max(1, labels.length);
  const rowH=(H-padTop-padBottom)/rowCount;
  const baseFont="600 13px 'Inter', system-ui";
  const valueFont="600 12px 'Inter', system-ui";

  ctx.textBaseline="middle";
  ctx.textAlign="left";
  ctx.font=baseFont;

  function fillRoundedRect(x,y,w,h,r,color){
    if(w<=0 || h<=0) return;
    const radius=Math.min(r, h/2, w/2);
    ctx.beginPath();
    ctx.moveTo(x+radius,y);
    ctx.lineTo(x+w-radius,y);
    ctx.quadraticCurveTo(x+w,y,x+w,y+radius);
    ctx.lineTo(x+w,y+h-radius);
    ctx.quadraticCurveTo(x+w,y+h,x+w-radius,y+h);
    ctx.lineTo(x+radius,y+h);
    ctx.quadraticCurveTo(x,y+h,x,y+h-radius);
    ctx.lineTo(x,y+radius);
    ctx.quadraticCurveTo(x,y,x+radius,y);
    ctx.closePath();
    ctx.fillStyle=color;
    ctx.fill();
  }

  function fitLabel(text, maxWidth){
    if(maxWidth<=0) return text;
    if(ctx.measureText(text).width<=maxWidth) return text;
    const ellipsis="‚Ä¶";
    let trimmed=text.trim();
    while(trimmed.length>1 && ctx.measureText(trimmed+ellipsis).width>maxWidth){
      trimmed=trimmed.slice(0,-1).trim();
    }
    return trimmed+ellipsis;
  }

  labels.forEach((label,i)=>{
    const rowTop=padTop + i*rowH;
    const centerY=rowTop + rowH/2;
    const bgH=rowH*0.84;
    const bgY=centerY - bgH/2;
    const bgColor=i%2===0 ? "rgba(0,85,165,0.12)" : "rgba(0,59,126,0.08)";
    fillRoundedRect(rowBgX, bgY, rowBgWidth, bgH, 16, bgColor);

    const iconX=rowBgX + 18;
    ctx.beginPath();
    ctx.fillStyle="rgba(0,85,165,0.28)";
    ctx.arc(iconX, centerY, 7, 0, Math.PI*2);
    ctx.fill();
    ctx.beginPath();
    ctx.fillStyle="#0055a5";
    ctx.arc(iconX, centerY, 4, 0, Math.PI*2);
    ctx.fill();

    const labelArea=Math.max(40, padLeft - (rowBgX + 46));
    const labelText=fitLabel(label, labelArea);
    ctx.fillStyle="rgba(6,42,99,0.88)";
    ctx.textAlign="left";
    ctx.font=baseFont;
    ctx.fillText(labelText, rowBgX + 36, centerY);

    const value=values[i]||0;
    const ratio=value/max;
    const hasValue=value>0;
    const rawWidth=barMaxWidth*ratio;
    const barWidth=hasValue ? Math.max(0, Math.min(barMaxWidth, Math.max(6, rawWidth))) : 0;
    const barHeight=Math.min(32, rowH*0.55);
    const barY=centerY - barHeight/2;

    if(hasValue){
      const gradient=ctx.createLinearGradient(padLeft, barY, padLeft + barWidth, barY + barHeight);
      gradient.addColorStop(0,"#2563eb");
      gradient.addColorStop(1,"#38bdf8");
      ctx.save();
      ctx.shadowColor="rgba(37,99,235,0.25)";
      ctx.shadowBlur=14;
      fillRoundedRect(padLeft, barY, barWidth, barHeight, barHeight/2, gradient);
      ctx.restore();
    }else{
      fillRoundedRect(padLeft, barY, 12, barHeight, barHeight/2, "rgba(148,163,184,0.35)");
    }

    const valText=String(value);
    ctx.font=valueFont;
    const metrics=ctx.measureText(valText);
    const pillPadding=9;
    const pillWidth=Math.round(metrics.width + pillPadding*2);
    const pillHeight=24;
    let pillX;

    if(hasValue && barWidth>pillWidth+28){
      pillX=padLeft + barWidth - pillWidth - 12;
      fillRoundedRect(pillX, centerY - pillHeight/2, pillWidth, pillHeight, pillHeight/2, "rgba(255,255,255,0.92)");
      ctx.fillStyle="#0f1f46";
    }else{
      pillX=padLeft + barWidth + 14;
      if(pillX + pillWidth > W - padRight){
        pillX=W - padRight - pillWidth;
      }
      fillRoundedRect(pillX, centerY - pillHeight/2, pillWidth, pillHeight, pillHeight/2, "rgba(0,85,165,0.15)");
      ctx.fillStyle="#0b2f66";
    }

    ctx.textAlign="center";
    ctx.fillText(valText, pillX + pillWidth/2, centerY);

  });

  ctx.textAlign="left";
  ctx.font=baseFont;
}

function getSeriesData(scale){
  const now=new Date();
  if(scale==="day"){
    const labels=[], createdArr=[], approvedArr=[];
    for(let i=6;i>=0;i--){
      const d=new Date(now.getFullYear(), now.getMonth(), now.getDate()-i);
      labels.push(d.toLocaleDateString(undefined,{day:"numeric",month:"short"}));
      createdArr.push(0); approvedArr.push(0);
    }
    empresaKeys().forEach(k=>{
      const emp=DBCACHE[k];
      Object.values(emp.proyectos||{}).forEach(pr=>{
        const d=pr.proyecto?.creadoEn?new Date(pr.proyecto.creadoEn):new Date();
        const diff=Math.floor((now-d)/(24*3600*1000));
        if(diff>=0 && diff<7){
          createdArr[6-diff]++;
          if(estadoProyecto(pr)==="APROBADO") approvedArr[6-diff]++;
        }
      });
    });
    return {labels, createdArr, approvedArr};
  }else{
    const labels=[]; for(let i=7;i>=0;i--){const d=new Date(now.getFullYear(), now.getMonth()-i,1); labels.push(d.toLocaleString(undefined,{month:"short"}));}
    const createdArr=new Array(8).fill(0), approvedArr=new Array(8).fill(0);
    empresaKeys().forEach(k=>{
      const emp=DBCACHE[k];
      Object.values(emp.proyectos||{}).forEach(pr=>{
        const d=pr.proyecto?.creadoEn?new Date(pr.proyecto.creadoEn):new Date();
        const idx=7-((now.getFullYear()*12+now.getMonth())-(d.getFullYear()*12+d.getMonth()));
        if(idx>=0 && idx<8){
          createdArr[idx]++;
          if(estadoProyecto(pr)==="APROBADO") approvedArr[idx]++;
        }
      });
    });
    return {labels, createdArr, approvedArr};
  }
}
function drawSeries(canvas, labels, createdArr, approvedArr){
  const ctx=canvas.getContext("2d"); const W=canvas.width, H=canvas.height; ctx.clearRect(0,0,W,H);
  const pad=40; const max = Math.max(1, ...createdArr, ...approvedArr);
  const stepX = (W-pad*2)/Math.max(1,(labels.length-1));
  // axes
  ctx.strokeStyle="#334155"; ctx.beginPath(); ctx.moveTo(pad, H-pad); ctx.lineTo(W-pad, H-pad); ctx.moveTo(pad, pad); ctx.lineTo(pad, H-pad); ctx.stroke();
  // Y ticks
  const stepY = Math.ceil(max/5);
  ctx.fillStyle="#1e293b"; ctx.font="12px system-ui"; ctx.textAlign="right"; ctx.textBaseline="middle";
  for(let yVal=0; yVal<=max; yVal+=stepY){
    const y=(H-pad) - ( (H-pad*2)*(yVal/max) );
    ctx.strokeStyle="#e2e8f0"; ctx.beginPath(); ctx.moveTo(pad-4,y); ctx.lineTo(W-pad,y); ctx.stroke();
    ctx.fillText(String(yVal), pad-8, y);
  }
  function drawLine(arr, color){
    ctx.beginPath();
    arr.forEach((v,i)=>{
      const x = pad + i*stepX; const y = (H-pad) - ( (H-pad*2)*(v/max) );
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.strokeStyle=color; ctx.stroke();
  }
  drawLine(createdArr, "#3b82f6");
  drawLine(approvedArr, "#22c55e");
  ctx.fillStyle="#1e293b"; ctx.font="14px system-ui"; ctx.textAlign="center";
  labels.forEach((m,i)=>{ const x=pad + i*stepX; ctx.fillText(m, x, H-pad+16); });
  // legend
  ctx.textAlign="left"; ctx.font="12px system-ui";
  ctx.fillStyle="#3b82f6"; ctx.fillRect(pad, pad-30, 12, 12);
  ctx.fillStyle="#1e293b"; ctx.fillText("Creados", pad+16, pad-20);
  ctx.fillStyle="#22c55e"; ctx.fillRect(pad+80, pad-30, 12, 12);
  ctx.fillStyle="#1e293b"; ctx.fillText("Aprobados", pad+96, pad-20);
  // Y axis label
  ctx.save(); ctx.rotate(-Math.PI/2); ctx.textAlign="center"; ctx.fillText("Proyectos", -H/2, pad-30); ctx.restore();
}
function drawTop5(canvas, labels, values){
  const ctx=canvas.getContext("2d"); const W=canvas.width, H=canvas.height; ctx.clearRect(0,0,W,H);
  const pad=40; const max=Math.max(1, ...values); const rowH=(H-pad*2)/Math.max(1,labels.length);
  labels.forEach((l,i)=>{
    const y = pad + i*rowH;
    const w = (W-pad*2)*(values[i]/max);
    ctx.fillStyle="#22c55e"; if(values[i]>0) ctx.fillRect(pad, y+6, w, rowH*0.5);
    ctx.fillStyle="#1e293b"; ctx.font="16px system-ui"; ctx.textAlign="left";
    ctx.fillText(`${l} ‚Äî ${values[i]}`, pad+4, y);
  });
}

function drawStateBar(canvas, aprob, parcial, observ){
  const ctx=canvas.getContext("2d"); const W=canvas.width, H=canvas.height; ctx.clearRect(0,0,W,H);
  const data=[aprob,parcial,observ]; const labels=["Aprobado","Parcial","Observado"];
  const colors=["#22c55e","#eab308","#ef4444"]; const pad=40; const max=Math.max(1,...data);
  const step=(W-pad*2)/data.length; const bw=step*0.6;
  data.forEach((v,i)=>{
    const x=pad + i*step + (step-bw)/2; const y=H-pad - (H-pad*2)*(v/max);
    ctx.fillStyle=colors[i]; ctx.fillRect(x,y,bw,(H-pad)-y);
    ctx.fillStyle="#1e293b"; ctx.font="14px system-ui"; ctx.textAlign="center";
    ctx.fillText(labels[i], x+bw/2, H-pad+16);
    ctx.fillText(v, x+bw/2, y-4);
  });
}

function drawTypeChart(canvas, labels, values){
  const ctx=canvas.getContext("2d"); const W=canvas.width, H=canvas.height; ctx.clearRect(0,0,W,H);
  const pad=40; const max=Math.max(1,...values); const step=(W-pad*2)/labels.length; const bw=step*0.6;
  values.forEach((v,i)=>{
    const x=pad + i*step + (step-bw)/2; const y=H-pad - (H-pad*2)*(v/max);
    ctx.fillStyle="#3b82f6"; ctx.fillRect(x,y,bw,(H-pad)-y);
    ctx.fillStyle="#1e293b"; ctx.font="14px system-ui"; ctx.textAlign="center";
    ctx.fillText(labels[i], x+bw/2, H-pad+16);
    ctx.fillText(v, x+bw/2, y-4);
  });
}

function drawTopEmp(canvas, labels, values){
  const ctx=canvas.getContext("2d"); const W=canvas.width, H=canvas.height; ctx.clearRect(0,0,W,H);
  const pad=40; const max=Math.max(1, ...values); const rowH=(H-pad*2)/Math.max(1,labels.length);
  labels.forEach((l,i)=>{
    const y = pad + i*rowH;
    const w = (W-pad*2)*(values[i]/max);
    ctx.fillStyle="#0ea5e9"; if(values[i]>0) ctx.fillRect(pad, y+6, w, rowH*0.5);
    ctx.fillStyle="#1e293b"; ctx.font="16px system-ui"; ctx.textAlign="left";
    ctx.fillText(`${l} ‚Äî ${values[i]}`, pad+4, y);
  });
}
function drawAllCharts(){
  // Donut
  let aprob=0, parcial=0, observ=0;
  empresaKeys().forEach(k=>{
    const emp=DBCACHE[k];
    Object.values(emp.proyectos||{}).forEach(pr=>{
      const e = estadoProyecto(pr);
      if(e==="APROBADO") aprob++; else if(e==="PARCIAL") parcial++; else if(e==="OBSERVADO") observ++;
    });
  });
  const c1=$("#cv-donut"); if(c1) drawDonut(c1, aprob, parcial, observ);
  const c5=$("#cv-estados"); if(c5) drawStateBar(c5, aprob, parcial, observ);

  // Proyectos revisados por responsable (SST/MA/RSE) y asignaciones de responsable de proyecto
  const sstMap=new Map(), maMap=new Map(), rseMap=new Map(), projMap=new Map();
  empresaKeys().forEach(k=>{
    const emp=DBCACHE[k];
    Object.values(emp.proyectos||{}).forEach(pr=>{
      const resp=pr.proyecto?.responsables||{};
      if(resp.proyecto?.nombre){
        const n=resp.proyecto.nombre;
        projMap.set(n,(projMap.get(n)||0)+1);
      }
      const roleByCorreo={};
      if(resp.sst?.correo) roleByCorreo[resp.sst.correo]={map:sstMap,name:resp.sst.nombre||resp.sst.correo};
      if(resp.ma?.correo)  roleByCorreo[resp.ma.correo]={map:maMap,name:resp.ma.nombre||resp.ma.correo};
      if(resp.rse?.correo) roleByCorreo[resp.rse.correo]={map:rseMap,name:resp.rse.nombre||resp.rse.correo};
      const seen=new Set();
      (pr.historial||[]).forEach(h=>{
        const info=roleByCorreo[h.correo];
        if(info && !seen.has(h.correo)){
          info.map.set(info.name,(info.map.get(info.name)||0)+1);
          seen.add(h.correo);
        }
      });
    });
  });
  const cS=$("#cv-resp-sst"); if(cS) drawRespChart(cS, Array.from(sstMap.keys()), Array.from(sstMap.values()));
  const cM=$("#cv-resp-ma"); if(cM) drawRespChart(cM, Array.from(maMap.keys()), Array.from(maMap.values()));
  const cR=$("#cv-resp-rse"); if(cR) drawRespChart(cR, Array.from(rseMap.keys()), Array.from(rseMap.values()));
  const cP=$("#cv-resp-proy"); if(cP) drawRespChart(cP, Array.from(projMap.keys()), Array.from(projMap.values()));

  // Series creados vs aprobados
  const scale=$("#series-scale")?$("#series-scale").value:"month";
  const {labels, createdArr, approvedArr}=getSeriesData(scale);
  const c3=$("#cv-series"); if(c3) drawSeries(c3, labels, createdArr, approvedArr);
  const title=$("#cv-series-title"); if(title) title.textContent = scale==="day"?"Proyectos / d√≠a (creados vs. aprobados)":"Proyectos / mes (creados vs. aprobados)";

  // Top 5 empresas con m√°s ‚ÄúN‚Äù
  const counts=[];
  empresaKeys().forEach(clave=>{
    let n=0;
    const emp=DBCACHE[clave];
    Object.values(emp.proyectos||{}).forEach(pr=>{
      (pr.ls025?.respuestas||[]).forEach(r=>{ if(r.valor==="N") n++; });
      (pr.personal||[]).filter(p=>p.visible!==false).forEach(p=>{
        Object.values(p.requisitos||{}).forEach(v=>{ if(v==="N") n++; });
        (p.guiasMedicas||[]).forEach(g=>Object.values(g.items||{}).forEach(v=>{ if(v==="N") n++; }));
      });
      (pr.vehiculos||[]).filter(v=>v.visible!==false).forEach(v=> Object.values(v.requisitos||{}).forEach(x=>{ if(x==="N") n++; }));
    });
    const name = emp.empresa?.datos?.empresa || emp.empresa?.nombre || clave;
    counts.push({name, n});
  });
  counts.sort((a,b)=>b.n-a.n);
  const top = counts.slice(0,5);
  const c4=$("#cv-top5"); if(c4) drawTop5(c4, top.map(x=>x.name), top.map(x=>x.n));

  // Proyectos por tipo
  const typeCounts={CI:0,HP:0,DB:0,HV:0};
  empresaKeys().forEach(k=>{
    const emp=DBCACHE[k];
    Object.values(emp.proyectos||{}).forEach(pr=>{
      (pr.proyecto?.tipos||[]).forEach(t=>{ if(typeCounts[t]!=null) typeCounts[t]++; });
    });
  });
  const c6=$("#cv-tipos"); if(c6) drawTypeChart(c6, Object.keys(typeCounts), Object.values(typeCounts));

  // Top 5 empresas con m√°s proyectos
  const projCounts=empresaKeys().map(clave=>{
    const count=Object.keys(DBCACHE[clave].proyectos||{}).length;
    const name=DBCACHE[clave].empresa?.datos?.empresa || DBCACHE[clave].empresa?.nombre || clave;
    return {name,count};
  });
  projCounts.sort((a,b)=>b.count-a.count);
  const topProj=projCounts.slice(0,5);
  const c7=$("#cv-topproj"); if(c7) drawTopEmp(c7, topProj.map(x=>x.name), topProj.map(x=>x.count));
}

function parseFiles(files){
  const arr = Array.from(files||[]);
  if(!arr.length) return;
  const readers = arr.map(f => new Promise(res=>{ const r=new FileReader(); r.onload=()=>res({name:f.name,json:tryJson(r.result)}); r.readAsText(f); }));
  Promise.all(readers).then(list=>{
    list.forEach(({json})=>{ if(json) ingest(json); });
    persistDB();
    renderDashboard(); refreshSelectorsAll(); renderYPFB();
  });
}
function tryJson(txt){ try{ return JSON.parse(txt); }catch(e){ console.warn("JSON inv√°lido", e); return null; } }

/* ================== Empresa / Proyectos ================== */
function abrirEmpresa(clave){
  CURRENT.empresaClave = clave; localStorage.setItem("currentV4", JSON.stringify(CURRENT));
  const emp = DBCACHE[clave];
  $("#emp-clave").value = emp.empresa?.empresaClave || clave;
  $("#emp-nombre").value = emp.empresa?.datos?.empresa || emp.empresa?.nombre || "";
  $("#emp-tel").value = emp.empresa?.datos?.telefono || "";
  $("#emp-mail").value = emp.empresa?.datos?.correo || "";
  renderListaProyectos();
  switchTab("empresa");
}
function renderListaProyectos(){
  const clave = $("#emp-clave").value.trim(); const emp = DBCACHE[clave]||{proyectos:{}};
  const tb=$("#tb-proyectos"); tb.innerHTML="";
  Object.keys(emp.proyectos||{}).forEach(pid=>{
    const pr = emp.proyectos[pid];
    const estado = estadoProyecto(pr);
    const tr = document.createElement("tr");
    const lastHist = pr.historial?.slice(-1)[0];
    const hist = lastHist
      ? `<div class="small hist-item">${lastHist.accion || ''} ¬∑ Rev ${lastHist.rev || ''}</div>`
      : "";
    const resp = pr.proyecto?.responsables || {};
    tr.innerHTML = `
      <td>${pid}</td>
      <td><input class="inp proj-name" data-pid="${pid}" value="${pr.proyecto?.nombre||""}"/></td>
      <td>
        <input class="inp proj-resp" data-pid="${pid}" data-role="sst" list="personal-list" value="${resp.sst?.nombre||""}"/>
        <div class="small">${resp.sst?.correo||""}</div>
      </td>
      <td>
        <input class="inp proj-resp" data-pid="${pid}" data-role="ma" list="personal-list" value="${resp.ma?.nombre||""}"/>
        <div class="small">${resp.ma?.correo||""}</div>
      </td>
      <td>
        <input class="inp proj-resp" data-pid="${pid}" data-role="rse" list="personal-list" value="${resp.rse?.nombre||""}"/>
        <div class="small">${resp.rse?.correo||""}</div>
      </td>
      <td>
        <input class="inp proj-resp" data-pid="${pid}" data-role="proyecto" list="personal-list" value="${resp.proyecto?.nombre||""}"/>
        <div class="small">${resp.proyecto?.correo||""}</div>
      </td>
      <td>
        <div class="chips proj-tipos" data-pid="${pid}">
          ${['CI','HP','DB','HV'].map(t=>`<label class="chip"><input type="checkbox" value="${t}" ${pr.proyecto?.tipos?.includes(t)?'checked':''}/> ${t}</label>`).join('')}
        </div>
      </td>
      <td>${pr.proyecto?.creadoEn ? new Date(pr.proyecto.creadoEn).toLocaleDateString() : ""}</td>
      <td><span class="status ${cls(estado)}">${estado}</span></td>
      <td>${hist}</td>
      <td>
        <div class="proj-actions">
          <button class="btn secondary small" onclick="crearCarpetaSharePoint('${clave}','${pid}')" style="display:none">Enviar enlace</button>
          <button class="btn small" onclick="abrirProyecto('${clave}','${pid}')">Abrir</button>
          <button class="btn ghost small" onclick="eliminarProyecto('${clave}','${pid}')">Eliminar</button>
          <button class="btn small" onclick="iniciarChatTeams('${clave}','${pid}')">Teams</button>
        </div>
      </td>
    `;
    tb.appendChild(tr);
    const inp = tr.querySelector(".proj-name");
    inp.addEventListener("change", e=>{
      emp.proyectos[pid].proyecto.nombre = e.target.value.trim();
      persistDB(); renderDashboard(); renderYPFB();
    });
    tr.querySelectorAll(".proj-resp").forEach(inp=>{
      inp.addEventListener("change", e=>{
        const role = e.target.dataset.role; const name = e.target.value.trim();
        const per = PERSONAL_LIST.find(x=>x.nombre===name);
        if(!pr.proyecto.responsables) pr.proyecto.responsables={};
        pr.proyecto.responsables[role] = {nombre:name, correo:per?.correo||""};
        persistDB(); renderYPFB(); renderListaProyectos();
      });
    });
    const tipoSel = `.proj-tipos[data-pid='${pid}']`;
    chipsInit(tipoSel);
    tr.querySelectorAll(`${tipoSel} .chip input`).forEach(ch=>{
      ch.addEventListener("change", ()=>{
        pr.proyecto.tipos = getTiposFromChips(tipoSel);
        persistDB(); renderListaProyectos(); renderDashboard(); renderYPFB();
      });
    });
  });
  updateNuevoProyectoBtn();
}
async function crearProyecto(){
  const clave = $("#emp-clave").value.trim();
  if(!clave){ alert("Primero complete y guarde la Empresa."); return; }
  const emp = ensureEmpresa(clave);
  const ids = Object.keys(emp.proyectos||{}).map(p=>parseInt(p.replace(/\D/g,"")||"0",10)).sort((a,b)=>a-b);
  const next = (ids.pop()||0)+1; const pid = "P"+String(next).padStart(3,"0");
  emp.proyectos[pid] = {
    proyecto:{schema:"ypfb.crm.v4.proyecto",version:1,empresaClave:clave,proyectoId:pid,nombre:`Proyecto ${pid}`,tipos:[],creadoEn:nowIso(),capturadoPor:($("#userEmail").value||""),responsables:{}},
    ls025:null, personal:[], vehiculos:[], updatedAt: nowIso(), conflicts:[], historial:[]
  };
  DBCACHE[clave] = emp;
  persistDB();
  renderListaProyectos();
  renderDashboard();
  refreshSelectorsAll();
  renderYPFB();

  const pr = emp.proyectos[pid];
  const sst = pr.proyecto?.responsables?.sst?.correo || "";
  const ma  = pr.proyecto?.responsables?.ma?.correo || "";
  const rse = pr.proyecto?.responsables?.rse?.correo || "";
  const correoEmp = emp?.empresa?.datos?.correo || "";
  const correoResp = pr.proyecto?.responsables?.proyecto?.correo || "";
  const carpeta = emp?.empresa?.datos?.carpeta || CARPETA_BASE;
  const payload = {empresaClave:clave, proyectoId:pid, correoSST:sst, correoMA:ma, correoRSE:rse, correoEmp, correoResp, carpeta};
  const correos = [sst,ma,rse,correoResp,correoEmp].filter(Boolean).join(",");
  try{
    await enviarASheet(payload);
    // ... (el resto de la l√≥gica de correo se mantiene igual)
  }catch(err){
    console.error("Error en notificaci√≥n inicial", err);
  }
}
function eliminarProyecto(clave, pid){
  if(!confirm("¬øEliminar este proyecto de la base de datos?")) return;
  const emp = DBCACHE[clave]; if(!emp) return;
  delete emp.proyectos[pid];
  persistDB();
  if(CURRENT.proyectoId===pid){ delete CURRENT.proyectoId; localStorage.setItem("currentV4", JSON.stringify(CURRENT)); }
  renderListaProyectos();
  renderDashboard();
  refreshSelectorsAll();
  renderYPFB();
}
function eliminarEmpresa(){
  const clave = $("#emp-clave").value.trim();
  if(!clave) return;
  if(!confirm(`¬øEliminar la empresa ${clave}?`)) return;

  delete DBCACHE[clave];

  if(database){
    database.ref(clave).remove()
      .catch(error=>{
        console.error("Error al eliminar empresa en Firebase:", error);
        alert("Error: No se pudo eliminar la empresa de la nube.");
      });
  }

  ["#emp-clave","#emp-nombre","#emp-tel","#emp-mail"].forEach(s=>{const el=$(s); if(el) el.value="";});
  $("#tb-proyectos").innerHTML="";
  persistDB();
}
function guardarEmpresa(){
  const nombre = $("#emp-nombre").value.trim();
  if(!nombre){ alert("Nombre requerido"); return; }
  const clave = slugify(nombre);
  $("#emp-clave").value = clave;
  const payload = { schema:"ypfb.crm.v4.empresa", version:1, empresaClave: clave,
    datos:{
      empresa: nombre, telefono: $("#emp-tel").value.trim(), correo: $("#emp-mail").value.trim()
    },
    capturadoEn: nowIso(), capturadoPor: $("#userEmail").value||null
  };
  ensureEmpresa(clave).empresa = payload;
  persistDB();
  renderListaProyectos();
  refreshEmpresaList();
  refreshSelectorsAll();
  renderDashboard();
  renderYPFB();
}
function abrirProyecto(clave, pid, ro=false){
  CURRENT.empresaClave = clave; CURRENT.proyectoId = pid; localStorage.setItem("currentV4", JSON.stringify(CURRENT));
  READONLY = !!ro;
  refreshSelectorsAll();
  switchTab("ls025");
}

/* ================== LS.025 UI ================== */
function lsRoleMatches(bloque, rol){
  if(!rol) return true;
  if(rol==="MA") return bloque.startsWith("Medio Ambiente");
  if(rol==="RSE") return bloque.startsWith("Social");
  if(rol==="SEG") return !(bloque.startsWith("Medio Ambiente") || bloque.startsWith("Social"));
  return true;
}
function buildLs025(){
  const cont = $("#ls025-container"); cont.innerHTML="";
  const clave = $("#ls-empresaSel").value; const pid = $("#ls-proyectoSel").value;
  const pr = (DBCACHE[clave]?.proyectos||{})[pid] || null;
  const role = $("#ls-rol").value;
  const dis = READONLY?"disabled":"";
  const vals = {};
  (pr?.ls025?.respuestas||[]).forEach(r=>{vals[r.reqId]=r;});

  // --- L√ìGICA DE FILTRADO DE IA ---
  // Filtra el cat√°logo si ls025FilteredIds tiene valores
  const catalogoAMostrar = ls025FilteredIds 
    ? CATALOG_LS025.filter(item => ls025FilteredIds.has(item.id)) 
    : CATALOG_LS025;
  
  if (ls025FilteredIds) {
      const infoBanner = document.createElement('div');
      infoBanner.className = 'banner';
      infoBanner.style.display = 'block';
      infoBanner.innerHTML = `<b>Asistente iDavid:</b> Mostrando ${catalogoAMostrar.length} de ${CATALOG_LS025.length} √≠tems aplicables para este proyecto. <a href="#" onclick="limpiarFiltroIA()">Mostrar todos</a> <button class="btn secondary no-print" style="margin-left:8px" onclick="guardarFiltroPDF()">Guardar PDF</button>`;
      cont.appendChild(infoBanner);
  }
  // --- FIN DE L√ìGICA DE FILTRADO ---

  const grupos = [...new Set(catalogoAMostrar.filter(x=>lsRoleMatches(x.bloque, role)).map(i=>i.bloque))];
  grupos.forEach(g=>{
    const wrap=document.createElement("details"); wrap.open=true; wrap.innerHTML = `<summary>${g}</summary>`;
    const tbl = document.createElement("table"); tbl.className="table"; tbl.innerHTML = `<thead><tr><th style="width:90px">ID</th><th>Requisito</th><th style="width:140px">S/N/NA</th><th>Comentario</th></tr></thead>`;
    const tbody = document.createElement("tbody");
    catalogoAMostrar.filter(x=>x.bloque===g).forEach(it=>{ // Usar catalogoAMostrar
      const r = vals[it.id]||{};
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td>${it.id}${it.req?` <span class="badge warn">Oblig.</span>`:""}</td>
        <td>${it.txt}</td>
        <td>
          <select class="ls-val" data-reqid="${it.id}" ${dis}>
            <option value="">‚Äî</option>
            <option value="S" ${r.valor==="S"?"selected":""}>S</option>
            <option value="N" ${r.valor==="N"?"selected":""}>N</option>
            <option value="NA" ${r.valor==="NA"?"selected":""}>NA</option>
          </select>
        </td>
        <td><input class="ls-com" data-reqid="${it.id}" type="text" placeholder="Comentario" value="${r.comentario||""}" ${dis}/></td>
      `;
      tbody.appendChild(tr);
    });
    tbl.appendChild(tbody); wrap.appendChild(tbl); cont.appendChild(wrap);
  });
  cont.onchange = e=>{
    if(e.target.classList.contains("ls-val") || e.target.classList.contains("ls-com")) guardarLS025();
  };
  refrescarKpiLS();
  $("#ls-conflict").style.display = (pr?.conflicts?.length) ? "block" : "none";
  if(pr?.conflicts?.length){
    $("#ls-conflict").innerHTML = `<b>Posibles conflictos:</b> ${pr.conflicts.map(c=>`${c.reqId} (${c.a} vs ${c.b})`).join("; ")}`;
  }
}

// Funci√≥n para limpiar el filtro de la IA y mostrar todos los √≠tems
function limpiarFiltroIA() {
    ls025FilteredIds = null;
    buildLs025();
}

function guardarFiltroPDF() {
    window.print();
}
function refrescarKpiLS(){
  const datos = getLS025Payload();
  let s=0,n=0,na=0;
  datos.respuestas.forEach(r=>{ if(r.valor==="S") s++; else if(r.valor==="N") n++; else if(r.valor==="NA") na++; });
  $("#k-ls-s").textContent = s; $("#k-ls-n").textContent = n; $("#k-ls-na").textContent = na;
  const est = computeEstadoRapido_SPN(datos.respuestas.map(r=>r.valor||""));
  $("#k-ls-est").textContent = est; $("#k-ls-est").className = "status "+cls(est);
}
function getLS025Payload(){
  const clave=$("#ls-empresaSel").value, pid=$("#ls-proyectoSel").value;
  const respuestas = CATALOG_LS025.map(it=>{
    const v = document.querySelector(`select.ls-val[data-reqid="${it.id}"]`)?.value || "";
    const c = document.querySelector(`input.ls-com[data-reqid="${it.id}"]`)?.value || "";
    const r = {reqId:it.id}; if(v) r.valor=v; if(c) r.comentario=c;
    if(v || c){ r.autor = $("#userEmail").value||""; r.modificadoEn = nowIso(); }
    return r;
  }).filter(r=>r.valor || r.comentario);
  return { schema:"ypfb.crm.v4.ls025", version:1, empresaClave:clave, proyectoId:pid, respuestas, capturadoEn:nowIso(), capturadoPor:$("#userEmail").value||"" };
}
function guardarLS025(){
  const p = getLS025Payload();
  if(!p.empresaClave || !p.proyectoId) return;
  ingest(p);
  logProyecto(p.empresaClave,p.proyectoId);
  persistDB();
}

function actualizarLS025(reqId, valor, comentario, clave, pid){
  const pr = ensureProyecto(clave,pid);
  if(!pr.ls025) pr.ls025 = {respuestas:[]};
  const arr = pr.ls025.respuestas;
  // remove any previous entries for the same requirement
  for(let i=arr.length-1;i>=0;i--){
    if(arr[i].reqId===reqId) arr.splice(i,1);
  }

  const txt = comentario.trim();
  if(valor==="N" || valor==="S"){
    arr.push({
      reqId,
      valor,
      comentario:txt,
      autor:"",
      modificadoEn:nowIso()
    });
  }
}

function autoLs025FromPersonal(code){
  const reqId = MAP_PERSONAL_TO_LS025[code];
  if(!reqId) return;
  const clave=$("#per-empresaSel").value;
  const pid=$("#per-proyectoSel").value;
  const pr = proyectoActualPersonal();
  const personas = (pr.personal || []).filter(p=>p.visible!==false);
  let allS = personas.length>0;
  let anyN = false;
  const comentarios=[];
  personas.forEach(p=>{
    const val = (p.requisitos||{})[code] || "";
    const obs = (p.requisitosObs||{})[code] || "";
    if(val==="N"){
      anyN = true;
      const com = obs ? `${p.nombre}: ${obs}` : `${p.nombre||""}`;
      comentarios.push(com.trim());
    }
    if(val!=="S") allS=false;
  });

  if(anyN){
    actualizarLS025(reqId, "N", comentarios.join("; "), clave, pid);
  }else if(allS){
    actualizarLS025(reqId, "S", "", clave, pid);
  }else{
    actualizarLS025(reqId, "", "", clave, pid);
  }
}

function autoLs025FromVeh(code){
  const reqId = MAP_VEH_TO_LS025[code];
  if(!reqId) return;
  const clave=$("#veh-empresaSel").value;
  const pid=$("#veh-proyectoSel").value;
  const pr = proyectoActualVeh();
  const vehiculos = (pr.vehiculos || []).filter(v=>v.visible!==false);
  let allS = vehiculos.length>0;
  let anyN = false;
  const comentarios=[];
  vehiculos.forEach(v=>{
    const val = (v.requisitos||{})[code] || "";
    const obs = (v.reqComentarios||{})[code] || "";
    if(val==="N"){
      anyN = true;
      const com = obs ? `${v.vehiculoId}: ${obs}` : `${v.vehiculoId||""}`;
      comentarios.push(com.trim());
    }
    if(val!=="S") allS=false;
  });

  if(anyN){
    actualizarLS025(reqId, "N", comentarios.join("; "), clave, pid);
  }else if(allS){
    actualizarLS025(reqId, "S", "", clave, pid);
  }else{
    actualizarLS025(reqId, "", "", clave, pid);
  }
}

function syncLs025FromPersona(){
  Object.keys(MAP_PERSONAL_TO_LS025).forEach(code=>autoLs025FromPersonal(code));
}

function syncLs025FromVehiculo(){
  Object.keys(MAP_VEH_TO_LS025).forEach(code=>autoLs025FromVeh(code));
}

/* ================== Personal ================== */
let editingPersonaIndex=-1;
function proyectoActualPersonal(){
  const clave=$("#per-empresaSel").value, pid=$("#per-proyectoSel").value;
  if(!clave || !pid) return {personal:[]};
  return ensureProyecto(clave,pid);
}
function agregarPersona(){
  if(READONLY) return;
  const pr = proyectoActualPersonal();
  if(!pr.personal) pr.personal=[];
  const nombre=$("#per-nombre").value.trim(); const cargo=$("#per-cargo").value.trim();
  const personaId=$("#per-id").value.trim()||("PER-"+Math.floor(Math.random()*9000+1000));
  if(!nombre){ alert("Ingrese el nombre"); return; }
  pr.personal.push({personaId,nombre,cargo,requisitos:{},guiasMedicas:[],comentarios:"",visible:true});

  const clave=$("#per-empresaSel").value, pid=$("#per-proyectoSel").value;
  logProyecto(clave,pid);

  $("#per-nombre").value=$("#per-cargo").value=$("#per-id").value="";
  persistPersonal();
  renderTablaPersonal();
  renderDashboard();
}
function renderTablaPersonal(){
  const pr = proyectoActualPersonal();
  $("#per-nombre").disabled=READONLY; $("#per-cargo").disabled=READONLY; $("#per-id").disabled=READONLY;
  const addBtn=$("#panel-personal .section .row button"); if(addBtn) addBtn.disabled=READONLY;
  const tb=$("#tabla-personal tbody"); tb.innerHTML="";
  (pr.personal||[]).forEach((p,idx)=>{
    const isVisible = p.visible !== false;
    const reqVals = Object.values(p.requisitos||{}).filter(v=>v && v!=='NA');
    const guiaVals = [];
    (p.guiasMedicas||[]).forEach(g=> Object.values(g.items||{}).forEach(v=>{ if(v && v!=='NA') guiaVals.push(v); }));
    const total = reqVals.length + guiaVals.length;
    const done = reqVals.filter(v=>v==='S').length + guiaVals.filter(v=>v==='S').length;
    const perc = Math.round( (done/Math.max(1,total))*100 );
    const fs = (p.requisitos||{}).P_RIESGO_FS100==="S"?"S":"";
    const apto = (p.guiasMedicas||[])
      .filter(g=>{
        const vals = Object.values(g.items||{}).filter(v=>v && v!=='NA');
        return vals.length && vals.every(v=>v==='S');
      })
      .map(g=>g.perfil.replaceAll('_',' ')).join(", ");
    const tr = document.createElement("tr");
    if(!isVisible) tr.classList.add("row-hidden");
    const estado = isVisible ? "" : ` <span class="badge muted">Oculto</span>`;
    const toggleTitle = isVisible ? "Ocultar de la validaci√≥n" : "Mostrar y considerar";
    const toggleIcon = isVisible ? "üëÅÔ∏è" : "üôà";
    const toggleBtn = `<button class="btn ghost small icon" ${READONLY?'disabled':''} onclick="togglePersonaVisible(${idx})" title="${toggleTitle}">${toggleIcon}</button>`;
    const acciones = READONLY?toggleBtn:`${toggleBtn} <button class="btn small" onclick="editarPersona(${idx})">Editar</button> <button class="btn secondary small" onclick="eliminarPersona(${idx})">Eliminar</button>`;
    tr.innerHTML = `
      <td>${p.personaId}</td><td>${p.nombre}${estado}</td><td>${p.cargo||""}</td><td>${fs}</td><td>${apto||"-"}</td>
      <td><span class="badge ${perc===100?'ok':(perc>=60?'warn':'err')}">${perc}%</span></td>
      <td>${acciones}</td>`;
    tb.appendChild(tr);
  });
}

function updateNuevoProyectoBtn(){
  const btn = document.getElementById('btn-nuevo-proyecto');
  if(!btn) return;
  const clave = $("#emp-clave").value.trim();
  const emp = DBCACHE[clave];
  const ids = emp ? Object.keys(emp.proyectos||{}).map(p=>parseInt(p.replace(/\D/g, '')||'0',10)).sort((a,b)=>a-b) : [];
  const next = (ids.pop()||0)+1;
  btn.textContent = `Nuevo Proyecto (P${String(next).padStart(3,'0')})`;
}
function eliminarPersona(idx){
  if(READONLY) return;
  const pr = proyectoActualPersonal();
  pr.personal.splice(idx,1);

  const clave=$("#per-empresaSel").value, pid=$("#per-proyectoSel").value;
  logProyecto(clave,pid);

  persistPersonal();
}
function togglePersonaVisible(idx){
  const pr = proyectoActualPersonal();
  const persona = pr.personal?.[idx];
  if(!persona || READONLY) return;
  persona.visible = persona.visible===false ? true : false;

  const clave=$("#per-empresaSel").value, pid=$("#per-proyectoSel").value;
  logProyecto(clave,pid);

  syncLs025FromPersona();
  persistPersonal();
  renderTablaPersonal();
  renderDashboard();
  renderResumen();
  buildLs025();
}
function editarPersona(idx){
  if(READONLY) return;
  editingPersonaIndex=idx;
  const pr = proyectoActualPersonal(); const p=pr.personal[idx];
  const box=$("#persona-form");
  box.innerHTML = `
    <div class="grid">
      <div class="col-4"><label>PersonaID</label><input id="pf-id" value="${p.personaId}"/></div>
      <div class="col-4"><label>Nombre</label><input id="pf-nombre" value="${p.nombre}"/></div>
      <div class="col-4"><label>Cargo</label><input id="pf-cargo" value="${p.cargo||""}"/></div>
    </div>
    <div class="section"><b>Requisitos (S/N/NA)</b></div>
  `;
  Object.entries(CAT_PERSONAL).forEach(([grupo,items])=>{
    const det=document.createElement("details"); det.open=true; det.innerHTML=`<summary>${grupo}</summary>`;
    const tbl=document.createElement("table"); tbl.className="table";
    const tbody=document.createElement("tbody");
    Object.entries(items).forEach(([code,label])=>{
      const val=(p.requisitos||{})[code]||"";
      const obs=(p.requisitosObs||{})[code]||"";
      const tr=document.createElement("tr");
      tr.innerHTML = `<td style="width:300px">${label}<div class=\"note\">${code}</div></td>
      <td style=\"width:160px\"><select class=\"pf-req\" data-code=\"${code}\">
        <option value=\"\">‚Äî</option><option value=\"S\" ${val==="S"?"selected":""}>S</option><option value=\"N\" ${val==="N"?"selected":""}>N</option><option value=\"NA\" ${val==="NA"?"selected":""}>NA</option></select>
        <input class=\"pf-req-com\" data-code=\"${code}\" type=\"text\" placeholder=\"Comentario\" value=\"${obs}\" style=\"display:${val==="N"?"block":"none"};margin-top:4px\"/>
      </td>`;
      tbody.appendChild(tr);
    });
    tbl.appendChild(tbody); det.appendChild(tbl); box.appendChild(det);
  });
  const gui = document.createElement("div");
  gui.innerHTML = `
    <div class="section"><b>Gu√≠as M√©dicas (FS.100)</b>
      <div id="toggle-guias" class="note"></div>
      <div class="row" style="margin-top:6px">
        <select id="perfil-nuevo" class="inp" style="max-width:320px">
          <option value="">‚Äî Seleccionar perfil ‚Äî</option>
          ${Object.keys(GUIAS_PERFILES).map(k=>`<option value="${k}">${k.replaceAll("_"," ")}</option>`).join("")}
        </select>
        <button class="btn small" onclick="agregarPerfilGuia()">Agregar Perfil</button>
      </div>
      <div id="guias-list" style="margin-top:8px"></div>
    </div>
    <div class="section"><label>Comentarios</label><textarea id="pf-com">${p.comentarios||""}</textarea></div>
  `;
  box.appendChild(gui);
  renderGuiasPersonales();
  updateGuiasVisibility();
  $("#modal-persona").style.display="flex";
  box.addEventListener("input", e=>{
    const pr = proyectoActualPersonal();
    const p = pr.personal[editingPersonaIndex];
    if(e.target.classList.contains("pf-req-com")){
      if(!p.requisitosObs) p.requisitosObs={};
      p.requisitosObs[e.target.dataset.code]=e.target.value.trim();
      persistPersonal();
      syncLs025FromPersona();
      return;
    }
    if(e.target.id==="pf-id") p.personaId=e.target.value.trim();
    else if(e.target.id==="pf-nombre") p.nombre=e.target.value.trim();
    else if(e.target.id==="pf-cargo") p.cargo=e.target.value.trim();
    else if(e.target.id==="pf-com") p.comentarios=e.target.value.trim();
    persistPersonal(); syncLs025FromPersona(); renderTablaPersonal(); renderDashboard();
  });
  box.addEventListener("change", e=>{
    const pr = proyectoActualPersonal();
    const p = pr.personal[editingPersonaIndex];
    if(e.target.classList.contains("pf-req-com")){
      if(!p.requisitosObs) p.requisitosObs={};
      p.requisitosObs[e.target.dataset.code]=e.target.value.trim();
    }else if(e.target.classList.contains("pf-req")){
      if(!p.requisitos) p.requisitos={};
      const code=e.target.dataset.code;
      p.requisitos[code]=e.target.value;
      const com=box.querySelector(`input.pf-req-com[data-code="${code}"]`);
      if(e.target.value==="N"){
        com.style.display='block';
      }else{
        com.style.display='none';
        if(p.requisitosObs) delete p.requisitosObs[code];
      }
      updateGuiasVisibility();
    }
    persistPersonal();
    syncLs025FromPersona();
    renderTablaPersonal();
    renderDashboard();
  });
}
function updateGuiasVisibility(){
  const pr = proyectoActualPersonal(); const p = pr.personal[editingPersonaIndex];
  const reqVal = $("#persona-form select.pf-req[data-code='P_RIESGO_EXAMENES']")?.value || "";
  const show = (reqVal==="S");
  $("#toggle-guias").innerHTML = show ? "Ex√°menes de Riesgo = S ‚Üí puede asignar perfiles FS.100." : "Marque 'Ex√°menes de Riesgo = S' para habilitar FS.100.";
  $("#perfil-nuevo").disabled = !show;
}
function agregarPerfilGuia(){
  const perfil = $("#perfil-nuevo").value; if(!perfil) return;
  const pr = proyectoActualPersonal(); const p = pr.personal[editingPersonaIndex];
  if(!p.guiasMedicas) p.guiasMedicas=[];
  if(p.guiasMedicas.find(g=>g.perfil===perfil)){ alert("Ese perfil ya existe"); return; }
  const items = Object.fromEntries(GUIAS_PERFILES[perfil].map(k=>[k,""]));
  p.guiasMedicas.push({perfil, items});
  persistPersonal(); renderGuiasPersonales(); renderTablaPersonal(); renderDashboard();
}
function renderGuiasPersonales(){
  const pr = proyectoActualPersonal(); const p = pr.personal[editingPersonaIndex];
  const cont=$("#guias-list"); cont.innerHTML="";
  (p.guiasMedicas||[]).forEach((g,idx)=>{
    const det=document.createElement("details"); det.open=true;
    det.innerHTML = `<summary>${g.perfil.replaceAll("_"," ")} 
      <button class="btn secondary small" style="margin-left:10px" onclick="borrarGuia(${idx})">Quitar</button></summary>`;
    const tbl=document.createElement("table"); tbl.className="table"; const tbody=document.createElement("tbody");
    GUIAS_PERFILES[g.perfil].forEach(code=>{
      const val=(g.items||{})[code]||"";
      const tr=document.createElement("tr");
      tr.innerHTML = `<td style="width:300px">${GUIAS_LABELS[code]}<div class="note">${code}</div></td>
        <td style="width:160px"><select data-gix="${idx}" data-code="${code}">
          <option value="">‚Äî</option><option value="S" ${val==="S"?"selected":""}>S</option><option value="N" ${val==="N"?"selected":""}>N</option><option value="NA" ${val==="NA"?"selected":""}>NA</option>
        </select></td>`;
      tbody.appendChild(tr);
    });
    tbl.appendChild(tbody); det.appendChild(tbl); cont.appendChild(det);
  });
  cont.addEventListener("change", e=>{
    if(e.target.tagName==="SELECT" && e.target.dataset.gix!==undefined){
      const gix=+e.target.dataset.gix, code=e.target.dataset.code, v=e.target.value;
      const pr = proyectoActualPersonal(); pr.personal[editingPersonaIndex].guiasMedicas[gix].items[code]=v;
      persistPersonal(); renderTablaPersonal(); renderDashboard();
    }
  });
}
function borrarGuia(idx){
  const pr = proyectoActualPersonal(); pr.personal[editingPersonaIndex].guiasMedicas.splice(idx,1); persistPersonal(); renderGuiasPersonales(); renderTablaPersonal(); renderDashboard();
}
function cerrarModal(id){
  $("#"+id).style.display="none";
  if(id==='modal-persona'){
    syncLs025FromPersona();
    const clave=$("#per-empresaSel").value;
    const pid=$("#per-proyectoSel").value;
    logProyecto(clave,pid);
    persistDB();
    editingPersonaIndex=-1;
    renderTablaPersonal();
    renderDashboard();
    buildLs025();
  }else if(id==='modal-vehiculo'){
    syncLs025FromVehiculo();
    const clave=$("#veh-empresaSel").value;
    const pid=$("#veh-proyectoSel").value;
    logProyecto(clave,pid);
    persistDB();
    editingVehIndex=-1;
    renderTablaVehiculos();
    renderDashboard();
    buildLs025();
  }
}

/* ================== Veh√≠culos ================== */
let editingVehIndex=-1;
function proyectoActualVeh(){
  const clave=$("#veh-empresaSel").value, pid=$("#veh-proyectoSel").value;
  if(!clave || !pid) return {vehiculos:[]};
  return ensureProyecto(clave,pid);
}
function agregarVehiculo(){
  if(READONLY) return;
  const pr=proyectoActualVeh(); if(!pr.vehiculos) pr.vehiculos=[];
  const placa=$("#veh-placa").value.trim(); if(!placa){ alert("Ingrese la placa"); return; }
  const vehiculoId=$("#veh-id").value.trim()||("VEH-"+placa.replace(/[^A-Za-z0-9]/g,"").toUpperCase());
  const marca=$("#veh-marca").value.trim(); const tipo=$("#veh-tipo").value.trim();
  pr.vehiculos.push({vehiculoId, placa, marca, tipo, requisitos:{}, comentarios:"", visible:true});

  const clave=$("#veh-empresaSel").value, pid=$("#veh-proyectoSel").value;
  logProyecto(clave,pid);

  $("#veh-placa").value=$("#veh-marca").value=$("#veh-tipo").value=$("#veh-id").value="";
  persistVehiculos();
  renderTablaVehiculos();
  renderDashboard();
}
function renderTablaVehiculos(){
  const pr = proyectoActualVeh();
  $("#veh-placa").disabled=READONLY; $("#veh-marca").disabled=READONLY; $("#veh-tipo").disabled=READONLY; $("#veh-id").disabled=READONLY;
  const addBtn=$("#panel-vehiculos .section .row button"); if(addBtn) addBtn.disabled=READONLY;
  const tb=$("#tabla-vehiculos tbody"); tb.innerHTML="";
  (pr.vehiculos||[]).forEach((v,idx)=>{
    const isVisible = v.visible !== false;
    const vals=Object.values(v.requisitos||{}).filter(x=>x && x!=='NA');
    const done=vals.filter(x=>x==="S").length;
    const perc=Math.round((done/Math.max(1,vals.length))*100);
    const tr=document.createElement("tr");
    if(!isVisible) tr.classList.add("row-hidden");
    const estado = isVisible ? "" : ` <span class="badge muted">Oculto</span>`;
    const toggleTitle = isVisible ? "Ocultar de la validaci√≥n" : "Mostrar y considerar";
    const toggleIcon = isVisible ? "üëÅÔ∏è" : "üôà";
    const toggleBtn = `<button class="btn ghost small icon" ${READONLY?'disabled':''} onclick="toggleVehiculoVisible(${idx})" title="${toggleTitle}">${toggleIcon}</button>`;
    const acciones = READONLY?toggleBtn:`${toggleBtn} <button class="btn small" onclick="editarVehiculo(${idx})">Editar</button> <button class="btn secondary small" onclick="eliminarVehiculo(${idx})">Eliminar</button>`;
    tr.innerHTML = `
      <td>${v.vehiculoId}</td><td>${v.placa}${estado}</td><td>${v.marca||""}</td><td>${v.tipo||""}</td>
      <td><span class="badge ${perc===100?'ok':(perc>=60?'warn':'err')}">${perc}%</span></td>
      <td>${acciones}</td>`;
    tb.appendChild(tr);
  });
}
function eliminarVehiculo(idx){
  if(READONLY) return;
  const pr = proyectoActualVeh();
  pr.vehiculos.splice(idx,1);

  const clave=$("#veh-empresaSel").value, pid=$("#veh-proyectoSel").value;
  logProyecto(clave,pid);

  persistVehiculos();
}
function toggleVehiculoVisible(idx){
  const pr = proyectoActualVeh();
  const vehiculo = pr.vehiculos?.[idx];
  if(!vehiculo || READONLY) return;
  vehiculo.visible = vehiculo.visible===false ? true : false;

  const clave=$("#veh-empresaSel").value, pid=$("#veh-proyectoSel").value;
  logProyecto(clave,pid);

  syncLs025FromVehiculo();
  persistVehiculos();
  renderTablaVehiculos();
  renderDashboard();
  renderResumen();
  buildLs025();
}
function editarVehiculo(idx){
  if(READONLY) return;
  editingVehIndex=idx; const pr=proyectoActualVeh(); const v=pr.vehiculos[idx];
  const box=$("#vehiculo-form");
  box.innerHTML = `
    <div class="grid">
      <div class="col-4"><label>VehiculoID</label><input id="vf-id" value="${v.vehiculoId}"/></div>
      <div class="col-3"><label>Placa</label><input id="vf-placa" value="${v.placa}"/></div>
      <div class="col-3"><label>Marca</label><input id="vf-marca" value="${v.marca||""}"/></div>
      <div class="col-4"><label>Tipo/Modelo</label><input id="vf-tipo" value="${v.tipo||""}"/></div>
    </div>
    <div class="section"><b>Requisitos (S/N/NA)</b></div>
  `;
  const reqs = {
    V_LISTADO:"Listado de Veh√≠culos", V_CHECKLIST:"Checklist asignados", V_RUAT_CRPVA:"CRPVA / RUAT",
    V_ITV:"Inspecci√≥n T√©cnica Vehicular", V_EMISIONES:"Emisiones de Gases", V_SOAT:"SOAT",
    V_POLIZA_RC:"P√≥liza RC ‚â• 30.000 USD", V_SATELITAL:"Monitoreo Satelital"
  };
  const det=document.createElement("details"); det.open=true; det.innerHTML = `<summary>Requisitos Vehiculares</summary>`;
  const tbl=document.createElement("table"); tbl.className="table"; const tbody=document.createElement("tbody");
  Object.entries(reqs).forEach(([code,label])=>{
    const val=(v.requisitos||{})[code]||"";
    const obs=(v.reqComentarios||{})[code]||"";
    const tr=document.createElement("tr");
    tr.innerHTML = `<td style="width:320px">${label}<div class=\"note\">${code}</div></td>
      <td style=\"width:160px\"><select class=\"vf-req\" data-code=\"${code}\">
        <option value=\"\">‚Äî</option><option value=\"S\" ${val==="S"?"selected":""}>S</option>
        <option value=\"N\" ${val==="N"?"selected":""}>N</option>
        <option value=\"NA\" ${val==="NA"?"selected":""}>NA</option></select>
        <input class=\"vf-req-com\" data-code=\"${code}\" type=\"text\" placeholder=\"Comentario\" value=\"${obs}\" style=\"display:${val==="N"?"block":"none"};margin-top:4px\"/>
      </td>`;
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody); det.appendChild(tbl); box.appendChild(det);
  box.appendChild(Object.assign(document.createElement("div"),{className:"section",innerHTML:`<label>Comentarios</label><textarea id="vf-com">${v.comentarios||""}</textarea>`}));
  $("#modal-vehiculo").style.display="flex";
  box.addEventListener("input", e=>{
    const pr = proyectoActualVeh();
    const v = pr.vehiculos[editingVehIndex];
    if(e.target.classList.contains("vf-req-com")){
      if(!v.reqComentarios) v.reqComentarios={};
      v.reqComentarios[e.target.dataset.code]=e.target.value.trim();
      persistVehiculos();
      syncLs025FromVehiculo();
      return;
    }
    if(e.target.id==="vf-id") v.vehiculoId=e.target.value.trim();
    else if(e.target.id==="vf-placa") v.placa=e.target.value.trim();
    else if(e.target.id==="vf-marca") v.marca=e.target.value.trim();
    else if(e.target.id==="vf-tipo") v.tipo=e.target.value.trim();
    else if(e.target.id==="vf-com") v.comentarios=e.target.value.trim();
    persistVehiculos(); syncLs025FromVehiculo(); renderTablaVehiculos(); renderDashboard();
  });
  box.addEventListener("change", e=>{
    const pr = proyectoActualVeh();
    const v = pr.vehiculos[editingVehIndex];
    if(e.target.classList.contains("vf-req-com")){
      if(!v.reqComentarios) v.reqComentarios={};
      v.reqComentarios[e.target.dataset.code]=e.target.value.trim();
    }else if(e.target.classList.contains("vf-req")){
      if(!v.requisitos) v.requisitos={};
      const code=e.target.dataset.code;
      v.requisitos[code] = e.target.value;
      const com=box.querySelector(`input.vf-req-com[data-code="${code}"]`);
      if(e.target.value==="N"){
        com.style.display='block';
      }else{
        com.style.display='none';
        if(v.reqComentarios) delete v.reqComentarios[code];
      }
    }
    persistVehiculos();
    syncLs025FromVehiculo();
    renderTablaVehiculos();
    renderDashboard();
  });
}

/* ================== Snapshot / PDF + Correo ================== */
function buildSnapshot(clave,pid){
  const emp = DBCACHE[clave] || {};
  const pr = (emp.proyectos||{})[pid] || {};
  return {
    schema:"ypfb.crm.v4.snapshot", version:1, generadoEn: nowIso(),
    empresa: emp.empresa || {schema:"ypfb.crm.v4.empresa",version:1,empresaClave:clave,datos:{}},
    proyecto: pr.proyecto || {schema:"ypfb.crm.v4.proyecto",version:1,empresaClave:clave,proyectoId:pid},
    ls025: pr.ls025 || {schema:"ypfb.crm.v4.ls025",version:1,empresaClave:clave,proyectoId:pid,respuestas:[]},
    personal: pr.personal || [],
    vehiculos: pr.vehiculos || [],
    historial: pr.historial || []
  };
}

function buildPdfHtml(clave,pid){
  const emp = DBCACHE[clave] || {};
  const pr = (emp.proyectos||{})[pid] || {};
  const {estSST, estMA, estRSE, estPer, estVeh} = calcularEstados(pr);
  const snap = buildSnapshot(clave,pid);
  const empName = snap.empresa?.datos?.empresa || snap.empresa?.nombre || clave;
  const histVer = (snap.historial||[]).filter(h=>h.accion!=="Recibido" && h.accion!=="Devoluci√≥n" && h.estados);
  const sstCorreo = pr.proyecto?.responsables?.sst?.correo || "";
  const maCorreo  = pr.proyecto?.responsables?.ma?.correo || "";
  const rseCorreo = pr.proyecto?.responsables?.rse?.correo || "";
  const revs = [...histVer].reverse();
  const revSST = revs.find(h=>h.correo===sstCorreo);
  const revMA  = revs.find(h=>h.correo===maCorreo);
  const revRSE = revs.find(h=>h.correo===rseCorreo);
  const banner = (area,status,resp,fecha)=>
    `<div class="aprob-banner ${status==="APROBADO"?"ok":"err"}">${status} ${area} ‚Äî ${resp} (${fecha})</div>`;
  let bannerSST="",bannerMA="",bannerRSE="";
  if(revSST && revSST.estados){
    const vals=[revSST.estados.sst,revSST.estados.personal,revSST.estados.vehiculos];
    const allOk=vals.every(v=>BANNER_OK_STATES.has(v));
    const anyObs=vals.includes("OBSERVADO");
    if(allOk) bannerSST = banner("SST","APROBADO",revSST.responsable,revSST.fecha);
    else if(anyObs) bannerSST = banner("SST","OBSERVADO",revSST.responsable,revSST.fecha);
  }
  if(revMA && revMA.estados?.ma){
    if(revMA.estados.ma==="APROBADO") bannerMA = banner("MA","APROBADO",revMA.responsable,revMA.fecha);
    else if(revMA.estados.ma==="OBSERVADO") bannerMA = banner("MA","OBSERVADO",revMA.responsable,revMA.fecha);
  }
  if(revRSE && revRSE.estados?.rse){
    if(revRSE.estados.rse==="APROBADO") bannerRSE = banner("RSE","APROBADO",revRSE.responsable,revRSE.fecha);
    else if(revRSE.estados.rse==="OBSERVADO") bannerRSE = banner("RSE","OBSERVADO",revRSE.responsable,revRSE.fecha);
  }
  const tableLS = ()=>{
    const rows = CATALOG_LS025.map(it=>{
      const r = (snap.ls025?.respuestas||[]).find(x=>x.reqId===it.id) || {};
      return `<tr><td>${it.id}</td><td>${it.txt}${it.req?' (Oblig.)':''}</td><td>${r.valor||''}</td><td>${r.comentario||''}</td></tr>`;
    }).join("");
    return `<table><thead><tr><th>ID</th><th>Requisito</th><th>S/N/NA</th><th>Comentario</th></tr></thead><tbody>${rows}</tbody></table>`;
  };
  const tablePer = ()=>{
    const personalVis = (snap.personal||[]).filter(p=>p.visible!==false);
    const hidden = (snap.personal||[]).length - personalVis.length;
    const rows = personalVis.map(p=>{
      let bad=[]; Object.entries(p.requisitos||{}).forEach(([k,v])=>{ if(v==="N") bad.push(k); });
      (p.guiasMedicas||[]).forEach(g=> Object.entries(g.items||{}).forEach(([k,v])=>{ if(v==="N") bad.push(k); }));
      const fs = (p.requisitos||{}).P_RIESGO_FS100 || '';
      const apto = (p.guiasMedicas||[])
        .filter(g=>{
          const vals = Object.values(g.items||{}).filter(v=>v && v!=='NA');
          return vals.length && vals.every(v=>v==='S');
        })
        .map(g=>g.perfil.replaceAll('_',' ')).join(", ");
      return `<tr><td>${p.nombre}</td><td>${p.cargo||''}</td><td>${fs}</td><td>${apto}</td><td>${bad.join(", ")}</td></tr>`;
    }).join("") || "<tr><td colspan='5'>Sin personal</td></tr>";
    const note = hidden>0 ? `<div style="font-size:12px;color:#555;margin:6px 0;">${hidden} persona(s) ocultas.</div>` : "";
    return `${note}<table><thead><tr><th>Persona</th><th>Cargo</th><th>FS100</th><th>Apto</th><th>Observaciones (NO)</th></tr></thead><tbody>${rows}</tbody></table>`;
  };
  const tableVeh = ()=>{
    const vehVis = (snap.vehiculos||[]).filter(v=>v.visible!==false);
    const hidden = (snap.vehiculos||[]).length - vehVis.length;
    const rows = vehVis.map(v=>{
      const vals = Object.values(v.requisitos||{}).filter(x=>x && x!=='NA');
      const bad = Object.entries(v.requisitos||{}).filter(([k,val])=>val==="N").map(([k])=>k).join(", ");
      const est = computeEstadoRapido_SPN(vals);
      return `<tr><td>${v.placa}</td><td>${(v.marca||'')+' '+(v.tipo||'')}</td><td>${est}</td><td>${bad}</td></tr>`;
    }).join("") || "<tr><td colspan='4'>Sin veh√≠culos</td></tr>";
    const note = hidden>0 ? `<div style="font-size:12px;color:#555;margin:6px 0;">${hidden} veh√≠culo(s) ocultos.</div>` : "";
    return `${note}<table><thead><tr><th>Placa</th><th>Marca/Tipo</th><th>Estado</th><th>Observaciones (NO)</th></tr></thead><tbody>${rows}</tbody></table>`;
  };
  const tableEnt = ()=>{
    const hist = (snap.historial||[])
      .filter(h=>h.accion==="Recibido" || h.accion==="Devoluci√≥n");
    let rev=0,last=0;
    const rows = hist.map(h=>{
      if(h.accion==="Recibido"){ rev++; last=rev; }
      const num = h.accion==="Devoluci√≥n"? last : rev;
      return `<tr><td>${num}</td><td>${h.fecha||''}</td><td>${h.responsable||''}</td><td>${h.accion||''}</td></tr>`;
    }).join("") || `<tr><td colspan="4">Sin registros</td></tr>`;
    return `<table><thead><tr><th>Rev</th><th>Fecha</th><th>Responsable</th><th>Acci√≥n</th></tr></thead><tbody>${rows}</tbody></table>`;
  };
  const clsTag = s => (s==="APROBADO"||s==="NO APLICA")?"aprob":(s==="OBSERVADO"?"observ":"parcial");
  const html = `
  <!doctype html><html><head><meta charset="utf-8"><title>Reporte ${clave}/${pid}</title>
    <style>
    body{font-family:Arial,Helvetica,sans-serif}
    .status.aprob{color:#0a0}.status.observ{color:#a00}.status.parcial{color:#a60}
    .aprob-banner{padding:6px;margin-top:10px;text-align:center;font-weight:bold;border:2px solid}
    .aprob-banner.ok{border-color:#0a0;color:#0a0}
    .aprob-banner.err{border-color:#a00;color:#a00}
    @media print { .no-print{display:none} table{width:100%;border-collapse:collapse} th,td{border:1px solid #000;padding:4px 6px} }
@media (max-width:768px){
  .sidebar{position:static;width:100%;height:auto;flex-direction:row;border-right:none;border-bottom:1px solid var(--border);}
  .sidebar .tab span{display:none;}
  .sidebar:hover{width:100%;}
  .sidebar:hover .tab span{display:none;}
  .main{margin-left:0;width:100%;}
  .grid{grid-template-columns:1fr;}
  .col-12,.col-8,.col-6,.col-4,.col-3{grid-column:span 1;}
}
@media (min-width:769px) and (max-width:1024px){
  .grid{grid-template-columns:repeat(8,1fr);}
  .col-12{grid-column:span 8;}
  .col-8{grid-column:span 8;}
  .col-6{grid-column:span 4;}
  .col-4{grid-column:span 4;}
  .col-3{grid-column:span 2;}
}

    </style></head>
  <body>
    <h2>YPFB Transporte ‚Äî Reporte de Habilitaci√≥n</h2>
    <div><b>Empresa:</b> ${empName} &nbsp; <b>Clave:</b> ${clave} &nbsp; <b>Proyecto:</b> ${pid}</div>
      <div class="section"><h3>LS.025 ‚Äî <span class="status ${clsTag(estSST)}">SST: ${estSST}</span> <span class="status ${clsTag(estMA)}">MA: ${estMA}</span> <span class="status ${clsTag(estRSE)}">RSE: ${estRSE}</span></h3>${tableLS()}</div>
    <div class="section"><h3>Personal ‚Äî <span class="status ${clsTag(estPer)}">${estPer}</span></h3>${tablePer()}</div>
    <div class="section"><h3>Veh√≠culos ‚Äî <span class="status ${clsTag(estVeh)}">${estVeh}</span></h3>${tableVeh()}</div>
      <div class="section"><h3>Recepci√≥n y Devoluci√≥n</h3>${tableEnt()}</div>
      ${bannerSST}${bannerMA}${bannerRSE}
      <div class="no-print" style="margin-top:12px"><button onclick="window.print()">Imprimir / Guardar PDF</button></div>
    </body></html>`;
  return {html, snap, estSST, estMA, estRSE, estPer, estVeh, empName};
}

function verPDF(clave,pid){
  const {html} = buildPdfHtml(clave,pid);
  const w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
}
async function pdfYCorreo(clave,pid,opts={}){
  const {html, snap, estSST, estMA, estRSE, estPer, estVeh, empName} = buildPdfHtml(clave,pid);
  if(!opts.skipRevision)
    registrarRevision(clave,pid,estSST,estMA,estRSE,estPer,estVeh,USUARIO.nombre,opts.accion||"Revisi√≥n",USUARIO.correo);
  const asuntoDef = `[${clave}/${pid}] Habilitaci√≥n ‚Äî SST: ${estSST} ¬∑ MA: ${estMA} ¬∑ RSE: ${estRSE} ¬∑ Personal: ${estPer} ¬∑ Veh√≠culos: ${estVeh}`;
  const cuerpoDef = `Estimados,\n\nSe adjuntan los reportes de habilitaci√≥n para ${empName} (${clave}, ${pid}).\n\nEstados:\n- SST: ${estSST}\n- MA: ${estMA}\n- RSE: ${estRSE}\n- Personal: ${estPer}\n- Veh√≠culos: ${estVeh}\n\nAtentamente,\n${$("#userEmail").value||""}`;
  const asunto = opts.asunto || asuntoDef;
  const cuerpo = opts.cuerpo || cuerpoDef;
  const destinatarios = opts.destinatarios
    ? (Array.isArray(opts.destinatarios) ? opts.destinatarios.join(',') : opts.destinatarios)
    : [snap.empresa?.datos?.correo, snap.proyecto?.responsables?.proyecto?.correo]
        .filter(Boolean)
        .join(',');
  const payload = {
    action: 'sendActionEmail',
    data: {
      accion: opts.accion || 'Revisi√≥n',
      empresaClave: clave,
      proyectoId: pid,
      destinatarios,
      correoEmp: snap.empresa?.datos?.correo || '',
      correoResp: snap.proyecto?.responsables?.proyecto?.correo || '',
      asunto,
      cuerpo,
      pdfHtml: html,
    }
  };
  try {
    await enviarASheet(payload);
    alert('Correo enviado');
  } catch(err) {
    alert('Error al enviar correo: '+err.message);
  }
}

/* ================== Resumen / Export ================== */
function renderResumen(){
  const clave=$("#res-empresaSel").value, pid=$("#res-proyectoSel").value;
  const snap = buildSnapshot(clave,pid);
  const totalLS=CATALOG_LS025.length; let s=0;
  (snap.ls025?.respuestas||[]).forEach(r=>{ if(r.valor==="S") s++; });
  const personalVisible = (snap.personal||[]).filter(p=>p.visible!==false);
  const vehiculosVisibles = (snap.vehiculos||[]).filter(v=>v.visible!==false);
  const perOcultos = (snap.personal||[]).length - personalVisible.length;
  const vehOcultos = (snap.vehiculos||[]).length - vehiculosVisibles.length;
  const histEnt = (snap.historial||[]).filter(h=>h.accion==="Recibido" || h.accion==="Devoluci√≥n");
  const histVer = (snap.historial||[]).filter(h=>h.accion!=="Recibido" && h.accion!=="Devoluci√≥n");
  let revEnt=0,lastEnt=0;
  const histEntRows = histEnt.map(h=>{
      if(h.accion==="Recibido"){ revEnt++; lastEnt=revEnt; }
      const num = h.accion==="Devoluci√≥n"? lastEnt : revEnt;
      return `<tr><td>${num}</td><td>${h.fecha||""}</td><td>${h.responsable||""}</td><td>${h.accion||""}</td></tr>`;
    }).join("") || `<tr><td colspan="4">Sin registros</td></tr>`;
 const histVerEst = histVer.filter(h=>h.estados);
 const histVerRows = histVerEst
   .map((h,i)=>`
     <tr><td>${i+1}</td><td>${h.fecha||""}</td><td>${h.responsable||""}</td><td>${h.accion||""}</td>
     <td class="status ${cls(h.estados?.sst)}">${h.estados?.sst||""}</td>
     <td class="status ${cls(h.estados?.ma)}">${h.estados?.ma||""}</td>
     <td class="status ${cls(h.estados?.rse)}">${h.estados?.rse||""}</td>
     <td class="status ${cls(h.estados?.personal)}">${h.estados?.personal||""}</td>
     <td class="status ${cls(h.estados?.vehiculos)}">${h.estados?.vehiculos||""}</td></tr>`)
   .join("") || `<tr><td colspan="9">Sin revisiones</td></tr>`;
 const sstCorreo = snap.proyecto?.responsables?.sst?.correo || "";
 const maCorreo  = snap.proyecto?.responsables?.ma?.correo || "";
 const rseCorreo = snap.proyecto?.responsables?.rse?.correo || "";
 const revs = [...histVerEst].reverse();
 const revSST = revs.find(h=>h.correo===sstCorreo);
 const revMA  = revs.find(h=>h.correo===maCorreo);
 const revRSE = revs.find(h=>h.correo===rseCorreo);
 let bannerSST="",bannerMA="",bannerRSE="";
 if(revSST && revSST.estados){
   const vals=[revSST.estados.sst,revSST.estados.personal,revSST.estados.vehiculos];
   const allOk=vals.every(v=>BANNER_OK_STATES.has(v));
   const anyObs=vals.includes("OBSERVADO");
   if(allOk)
     bannerSST = `<div class="aprob-banner ok">APROBADO SST ‚Äî ${revSST.responsable} (${revSST.fecha})</div>`;
   else if(anyObs)
     bannerSST = `<div class="aprob-banner err">OBSERVADO SST ‚Äî ${revSST.responsable} (${revSST.fecha})</div>`;
 }
 if(revMA && revMA.estados?.ma){
   if(revMA.estados.ma==="APROBADO")
     bannerMA = `<div class="aprob-banner ok">APROBADO MA ‚Äî ${revMA.responsable} (${revMA.fecha})</div>`;
   else if(revMA.estados.ma==="OBSERVADO")
     bannerMA = `<div class="aprob-banner err">OBSERVADO MA ‚Äî ${revMA.responsable} (${revMA.fecha})</div>`;
 }
 if(revRSE && revRSE.estados?.rse){
   if(revRSE.estados.rse==="APROBADO")
     bannerRSE = `<div class="aprob-banner ok">APROBADO RSE ‚Äî ${revRSE.responsable} (${revRSE.fecha})</div>`;
   else if(revRSE.estados.rse==="OBSERVADO")
     bannerRSE = `<div class="aprob-banner err">OBSERVADO RSE ‚Äî ${revRSE.responsable} (${revRSE.fecha})</div>`;
 }
  $("#resumen-content").innerHTML = `
    <div class="kpi">
      <div>Empresa: <b>${snap.empresa?.datos?.empresa || snap.empresa?.nombre || clave}</b></div>
      <div>Proyecto: <b>${snap.proyecto?.proyectoId||pid}</b></div>
      <div>LS.025 (S): <b>${s}/${totalLS}</b></div>
      <div>Personal: <b>${personalVisible.length}</b>${perOcultos>0?` <span class="note">(${perOcultos} ocultos)</span>`:""}</div>
      <div>Veh√≠culos: <b>${vehiculosVisibles.length}</b>${vehOcultos>0?` <span class="note">(${vehOcultos} ocultos)</span>`:""}</div>
    </div>
      <div class="section" style="margin-top:10px">
        <h4>Recepci√≥n / Devoluci√≥n</h4>
        <table class="table"><thead><tr><th>Rev</th><th>Fecha</th><th>Responsable</th><th>Acci√≥n</th></tr></thead>
        <tbody>${histEntRows}</tbody></table>
      </div>
      <div class="section" style="margin-top:10px">
        <h4>Verificaci√≥n</h4>
        <table class="table"><thead><tr><th>Rev</th><th>Fecha</th><th>Responsable</th><th>Acci√≥n</th><th>SST</th><th>MA</th><th>RSE</th><th>Personal</th><th>Veh√≠culos</th></tr></thead>
        <tbody>${histVerRows}</tbody></table>
      </div>
      ${bannerSST}${bannerMA}${bannerRSE}`;
  function cls(est){
    if(est==="APROBADO" || est==="NO APLICA") return "aprob";
    if(est==="OBSERVADO") return "observ";
    if(est==="PARCIAL" || (est && est.startsWith("SIN"))) return "parcial";
    return "";
  }
}
function registrarAccion(){
  const clave=$("#res-empresaSel").value, pid=$("#res-proyectoSel").value;
  if(!clave || !pid) return;
  const pr = ensureProyecto(clave,pid);
  const {estSST, estMA, estRSE, estPer, estVeh} = calcularEstados(pr);
  const accion=$("#rev-accion").value;
  registrarRevision(clave,pid,estSST,estMA,estRSE,estPer,estVeh,USUARIO.nombre,accion,USUARIO.correo);
  if(accion==="Recibido"){
    const emp=DBCACHE[clave];
    const sstObj=pr.proyecto?.responsables?.sst||{};
    const maObj=pr.proyecto?.responsables?.ma||{};
    const rseObj=pr.proyecto?.responsables?.rse||{};
    const respObj=pr.proyecto?.responsables?.proyecto||{};
    const correoEmp=emp?.empresa?.datos?.correo||"";
    const payload={
      action:'sendActionEmail',
      data:{
        accion:'Recibido',
        empresaClave:clave,
        proyectoId:pid,
        carpeta:emp?.empresa?.datos?.carpeta||CARPETA_BASE,
        correoSST:sstObj.correo||'',
        correoMA:maObj.correo||'',
        correoRSE:rseObj.correo||'',
        correoResp:respObj.correo||'',
        correoEmp,
        nomSST:sstObj.nombre||'',
        nomMA:maObj.nombre||'',
        nomRSE:rseObj.nombre||'',
        nomResp:respObj.nombre||''
      }
    };
    enviarASheet(payload);
  } else if(accion==="Devoluci√≥n"){
    const emp=DBCACHE[clave];
    const empName=emp?.empresa?.datos?.empresa || emp?.empresa?.nombre || clave;
    const correoEmp=emp?.empresa?.datos?.correo||"";
    const correoResp=pr.proyecto?.responsables?.proyecto?.correo||"";
    const destinatarios=[correoEmp,correoResp].filter(Boolean).join(",");
    if(destinatarios && confirm('¬øEnviar correo de devoluci√≥n?')){
      const allOk=[estSST,estMA,estRSE,estPer,estVeh].every(s=>s==="APROBADO"||s==="NO APLICA");
      const link='https://dmachacap33.github.io/Habilitaci-n-para-Proyectos/';
      const asunto=allOk?`Carpeta aprobada ${empName} ${pid}`:`Carpeta revisada ${empName} ${pid}`;
      const cuerpo=allOk?
        `Su carpeta ha sido aprobada y puede pasar a recogerla en la oficina.\n\nPuede ingresar a ${link} para descargar las observaciones realizadas.`:
        `Su carpeta fue revisada. Puede ingresar a ${link} para descargar las observaciones realizadas y pasar a recoger su carpeta f√≠sica.`;
      pdfYCorreo(clave,pid,{destinatarios,asunto,cuerpo,skipRevision:true,accion:'Devoluci√≥n'});
    }
  }
  renderResumen();
  renderDashboard();
  renderYPFB();
}

/* ================== Tour interactivo ================== */
function buildTourSteps(){
  const $=s=>document.querySelector(s);
  const steps=[{intro:"Bienvenido al CRM de Habilitaci√≥n. Este tour le mostrar√° las funciones principales."}];
  const dashTab=$(".tab[data-tab='dashboard']"), dashPanel=$("#panel-dashboard");
  const cardsTab=$(".tab[data-tab='cards']"), search=$("#search");
  const ypfbTab=$(".tab[data-tab='ypfb']"), ypfbPanel=$("#panel-ypfb");
  const empPanel=$("#panel-empresa");
  const lsPanel=$("#panel-ls025");
  const perRow=$("#panel-personal .section .row");
  const vehRow=$("#panel-vehiculos .section .row");
  const resAccion=$("#rev-accion");
  const userTab=$(".tab[data-tab='usuarios']");

  if(dashTab) steps.push({element:dashTab,intro:"Ingresa al Dashboard para ver m√©tricas generales."});
  if(dashPanel) steps.push({element:dashPanel,intro:"El Dashboard resume el estado de tus proyectos."});
  if(cardsTab) steps.push({element:cardsTab,intro:"Desde Cards Empresa puedes gestionar todas las carpetas."});
  if(search) steps.push({element:search,intro:"Busca y filtra empresas o proyectos."});
  if(ypfbTab) steps.push({element:ypfbTab,intro:"La secci√≥n YPFB muestra asignaciones pendientes y revisadas."});
  if(ypfbPanel) steps.push({element:ypfbPanel,intro:"Aqu√≠ se listan las carpetas asignadas a YPFB."});
  if(empPanel) steps.push({element:empPanel,intro:"En Empresa edita datos y crea nuevos proyectos."});
  if(lsPanel) steps.push({element:lsPanel,intro:"En LS.025 selecciona S/N/NA y escribe comentarios por requisito."});
  if(perRow) steps.push({element:perRow,intro:"A√±ade Personal indicando nombre, cargo e ID."});
  if(vehRow) steps.push({element:vehRow,intro:"Registra Veh√≠culos con su placa y caracter√≠sticas."});
  if(resAccion) steps.push({element:resAccion,intro:"En Resumen registra acciones y genera reportes."});
  if(USUARIO.admin && userTab) steps.push({element:userTab,intro:"Los administradores gestionan usuarios y roles aqu√≠."});
  return steps;
}

function startTour(){
  const steps=buildTourSteps();
  introJs().setOptions({
    steps,
    nextLabel:"Siguiente",
    prevLabel:"Anterior",
    doneLabel:"Finalizar"
  }).onbeforechange(function(target){
      if(target.classList.contains('tab')){
        switchTab(target.dataset.tab);
      }else{
        const panel=target.closest('.panel');
        if(panel) switchTab(panel.id.replace('panel-',''));
      }
  }).oncomplete(()=>{localStorage.setItem('tour-'+(USUARIO.correo||'anon'),'1');})
    .onexit(()=>{localStorage.setItem('tour-'+(USUARIO.correo||'anon'),'1');})
    .start();
}
function startTourOnce(){
  const key='tour-'+(USUARIO.correo||'anon');
  if(!localStorage.getItem(key)){
    setTimeout(startTour,500);
  }
}

async function notificarSiguiente(){
  const clave=$("#res-empresaSel").value, pid=$("#res-proyectoSel").value;
  if(!clave || !pid) return;
  const emp=DBCACHE[clave];
  const pr=ensureProyecto(clave,pid);
  const {estSST, estMA, estRSE, estPer, estVeh} = calcularEstados(pr);
  const sstObj=pr.proyecto?.responsables?.sst||{};
  const maObj=pr.proyecto?.responsables?.ma||{};
  const rseObj=pr.proyecto?.responsables?.rse||{};
  const respObj=pr.proyecto?.responsables?.proyecto||{};
  const correoEmp=emp?.empresa?.datos?.correo||"";
  const payload={
    action:'sendActionEmail',
    data:{
      accion:'Notificaci√≥n',
      empresaClave:clave,
      proyectoId:pid,
      carpeta:emp?.empresa?.datos?.carpeta||'',
      correoSST:sstObj.correo||'',
      correoMA:maObj.correo||'',
      correoRSE:rseObj.correo||'',
      correoResp:respObj.correo||'',
      correoEmp,
      nomSST:sstObj.nombre||'',
      nomMA:maObj.nombre||'',
      nomRSE:rseObj.nombre||'',
      nomResp:respObj.nombre||''
    }
  };
  if(!confirm("¬øNotificar a SST/MA/RSE y registrar en la hoja?")) return;
  try{
    await enviarASheet(payload);
    registrarRevision(clave,pid,estSST,estMA,estRSE,estPer,estVeh,USUARIO.nombre,"Notificaci√≥n a SST/MA/RSE",USUARIO.correo);
    alert("Registro enviado");
  }catch(err){
    alert("Error al enviar: "+err.message);
  }
}

/* ================== Selectores de empresa/proyecto en paneles ================== */
function refreshSelectors(selEmpresaId, selProyectoId){
  const selEmp = $(selEmpresaId), selProy = $(selProyectoId);
  const empresas = empresaKeys().filter(clave=>{
    const emp=DBCACHE[clave];
    if(ES_RESPONSABLE && !USUARIO.admin){
      return Object.values(emp.proyectos||{}).some(pr=> esResponsableEnProyecto(pr, USUARIO.correo));
    }
    return true;
  });
  selEmp.innerHTML = empresas.map(clave=>`<option value="${clave}" ${CURRENT.empresaClave===clave?"selected":""}>${DBCACHE[clave]?.empresa?.datos?.empresa || DBCACHE[clave]?.empresa?.nombre || clave}</option>`).join("") || "<option value=''>‚Äî</option>";
  const clave = selEmp.value || CURRENT.empresaClave || empresas[0] || "";
  const proys = Object.keys(DBCACHE[clave]?.proyectos||{}).filter(pid=>{
    if(ES_RESPONSABLE && !USUARIO.admin){
      const pr=DBCACHE[clave]?.proyectos?.[pid];
      return esResponsableEnProyecto(pr, USUARIO.correo);
    }
    return true;
  });
  selProy.innerHTML = proys.map(pid=>`<option value="${pid}" ${CURRENT.proyectoId===pid?"selected":""}>${pid}</option>`).join("") || "<option value=''>‚Äî</option>";
}
function refreshSelectorsAll(){
  refreshSelectors("#ls-empresaSel","#ls-proyectoSel");
  refreshSelectors("#per-empresaSel","#per-proyectoSel");
  refreshSelectors("#veh-empresaSel","#veh-proyectoSel");
  refreshSelectors("#res-empresaSel","#res-proyectoSel");
  buildLs025(); renderTablaPersonal(); renderTablaVehiculos(); renderResumen();
}

/* ================== Pesta√±as ================== */
function switchTab(id){
  $$(".tab").forEach(x=>x.classList.remove("active"));
  document.querySelector(`.tab[data-tab="${id}"]`).classList.add("active");
  $$(".panel").forEach(p=>p.classList.remove("active"));
  document.getElementById("panel-"+id).classList.add("active");
  if(id==="dashboard" || id==="cards") renderDashboard();
  if(id==="ypfb") renderYPFB();
  if(id==="resp") renderResponsable();
  if(id==="ls025") buildLs025();
  if(id==="personal") renderTablaPersonal();
  if(id==="vehiculos") renderTablaVehiculos();
  if(id==="resumen") renderResumen();
}
$$(".tab").forEach(t=> t.addEventListener("click", ()=> switchTab(t.dataset.tab)));

/* ================== Limpieza de cache ================== */
function limpiarCache(){
  if(!confirm("¬øLimpiar cache local?")) return;

  DBCACHE={}; CURRENT={}; localStorage.removeItem(LOCAL_CACHE_KEY); localStorage.removeItem(LOCAL_CACHE_BACKUP_KEY); localStorage.removeItem(REMOTE_CACHE_KEY); localStorage.removeItem(CACHE_META_KEY); localStorage.removeItem(LAST_PAYLOAD_KEY); localStorage.removeItem("currentV4");

  const tag=document.getElementById("db-json"); if(tag) tag.textContent="{}";
  renderDashboard(); refreshSelectorsAll(); renderYPFB();
}

/* ================== L√≥gica del Chatbot de IA ================== */
let GEMINI_API_KEY = '';
const chatContainer = document.getElementById('chat-ai-container');
const chatBtn = document.getElementById('chat-ai-btn');
const closeBtn = document.getElementById('chat-ai-close-btn');
const sendBtn = document.getElementById('chat-send-btn');
const chatInput = document.getElementById('chat-input');
const chatMessages = document.getElementById('chat-messages');

function setChatVisibility(show){
  if(chatBtn) chatBtn.style.display = show ? 'flex' : 'none';
  if(!show && chatContainer) chatContainer.classList.remove('visible');
}

async function checkAiAccess(){
  if(!USUARIO || !USUARIO.correo){ setChatVisibility(false); return; }
  if(USUARIO.admin){ setChatVisibility(true); return; }
  if(database){
    try{
      const snap = await database.ref('aiUsers/'+emailPath(USUARIO.correo)).once('value');
      setChatVisibility(!!snap.val());
    }catch(e){ setChatVisibility(false); }
  } else {
    setChatVisibility(false);
  }
}

async function ensureGeminiApiKey(){
  if(GEMINI_API_KEY) return;
  const codigo = USUARIO?.codigo || 'anon';
  const localKey = localStorage.getItem(`geminiKey_${codigo}`);
  if(localKey){
    GEMINI_API_KEY = localKey;
    return;
  }
  if(database){
    try{
      const snap = await database.ref('geminiKeys/'+codigo).once('value');
      const val = snap.val();
      if(val){
        GEMINI_API_KEY = val;
        localStorage.setItem(`geminiKey_${codigo}`, GEMINI_API_KEY);
        return;
      }
    }catch(err){
      console.error('Error al leer API key de Firebase:', err);
    }
  }
  const key = prompt('Ingresa tu API key de Gemini:');
  if(key){
    GEMINI_API_KEY = key.trim();
    localStorage.setItem(`geminiKey_${codigo}`, GEMINI_API_KEY);
    if(database){
      database.ref('geminiKeys/'+codigo).set(GEMINI_API_KEY).catch(err=>{
        console.error('Error al guardar API key en Firebase:', err);
      });
    }
  }
}

// Abrir y cerrar la ventana de chat
chatBtn.addEventListener('click', () => iniciarAsistenteIA());
closeBtn.addEventListener('click', () => chatContainer.classList.remove('visible'));

// Enviar mensaje al hacer clic o presionar Enter
sendBtn.addEventListener('click', () => handleUserMessage());
chatInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    handleUserMessage();
  }
});

// Funci√≥n para formatear el cat√°logo LS.025 para la IA
function formatLs025ForAI() {
  let context = "Contexto del Formulario LS.025:\n\n";
  context += CATALOG_LS025.map(item => `- ID ${item.id} (${item.bloque}): ${item.txt} ${item.req ? '(Obligatorio)' : ''}`).join('\n');
  return context;
}

// Maneja el mensaje del usuario y llama a la IA
async function handleUserMessage() {
  const userQuery = chatInput.value.trim();
  if (!userQuery) return;

  addMessage(userQuery, 'user');
  chatInput.value = '';
  conversation.push({ role: 'user', parts: [{ text: userQuery }] });
  saveConversation();
  addMessage('Pensando...', 'ai', 'loading-message');

  try {
    // La funci√≥n askAI ahora devuelve el objeto JSON directamente
    const responseJson = await askAI();
    
    // Eliminamos el mensaje "Pensando..."
    const loadingMessage = document.getElementById('loading-message');
    if (loadingMessage) {
      loadingMessage.remove();
    }

    // Mostramos solo el mensaje amigable al usuario
    if (responseJson.mensaje) {
      addMessage(responseJson.mensaje, 'ai');
    }

    // Procesamos los IDs internamente
    if (responseJson.ids && responseJson.ids.length > 0) {
      const idsUpper = responseJson.ids.map(id => id.toUpperCase());
       // Aseguramos que los √≠tems de MA obligatorios est√©n si aplica
      ['L067','L068','L069','L082'].forEach(id => { if (!idsUpper.includes(id)) idsUpper.push(id); });
      ls025FilteredIds = new Set(idsUpper);
    }

    // Si el bot confirma que est√° listo, filtramos el formulario
    if (responseJson.cerrar && ls025FilteredIds) {
      // Damos una confirmaci√≥n final y aplicamos el filtro
      addMessage("Perfecto, aplicando el filtro ahora.", 'ai');
      buildLs025();

      // Opcional: Cerrar el chat despu√©s de filtrar
      setTimeout(() => chatContainer.classList.remove('visible'), 2000); 
    }

    if (responseJson.proyecto && !currentProyecto) {
        currentProyecto = responseJson.proyecto;
    }

  } catch (error) {
    console.error("Error al procesar la respuesta de la IA:", error);
    const loadingMessage = document.getElementById('loading-message');
    if(loadingMessage){
        loadingMessage.textContent = "Lo siento, hubo un error al conectar con el asistente.";
        loadingMessage.removeAttribute('id');
    }
  }
  saveConversation();
}

// Agrega un mensaje a la ventana de chat
function addMessage(text, sender, id = '') {
  const messageEl = document.createElement('div');
  messageEl.className = `chat-message ${sender}`;
  messageEl.textContent = text;
  if (id) {
    messageEl.id = id;
  }
  chatMessages.appendChild(messageEl);
  // Hace scroll hacia el √∫ltimo mensaje
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Extrae un objeto JSON v√°lido desde un texto del modelo
function extractResponseObject(text) {
  let jsonString = text;
  const codeBlockMatch = jsonString.match(/```(?:json)?\s*([\s\S]*?)```/);
  if (codeBlockMatch) {
    jsonString = codeBlockMatch[1];
  } else {
    const firstBrace = jsonString.indexOf('{');
    const lastBrace = jsonString.lastIndexOf('}');
    if (firstBrace !== -1 && lastBrace > firstBrace) {
      jsonString = jsonString.substring(firstBrace, lastBrace + 1);
    } else {
      return null;
    }
  }
  try {
    return JSON.parse(jsonString);
  } catch (e) {
    return null;
  }
}

// Reemplaza tu funci√≥n askAI existente con esta
async function askAI() {
  await ensureGeminiApiKey();
  if (!GEMINI_API_KEY) {
    return { mensaje: "Error: La clave API de Gemini no ha sido configurada.", ids: null, cerrar: false };
  }

  const ls025Context = formatLs025ForAI();
  const historial = currentProyecto ? obtenerHistorialProyecto(currentProyecto).slice(-5) : [];
  let historialPrompt = '';
  if (historial.length) {
    historialPrompt = '\nHistorial previo para proyectos similares (' + currentProyecto + '):\n' +
      historial.map(h => `- Alcance: ${h.alcance}; TipoContrato: ${h.tipoContrato}; Personal: ${h.personal}; LS025: ${(h.ids||[]).join(',')}`).join('\n');
  }
    
  // Usamos la instrucci√≥n mejorada para mantener el chat limpio
  const systemInstruction = `Eres "iDavid", un asistente experto en la habilitaci√≥n de proyectos bajo la normativa LS.025. Tu objetivo es guiar al usuario a trav√©s de un proceso conversacional para identificar con precisi√≥n todos los √≠tems del formulario LS.025 que aplican a su proyecto.

    **Tu Misi√≥n:**

    1.  **Conversaci√≥n Limpia y Natural:** Mant√©n los mensajes cortos, amigables y libres de jerga t√©cnica. **Nunca muestres el JSON o listas de IDs en el chat.** Toda esa informaci√≥n se procesa internamente.
    2.  **Inicio Amplio:** Comienza siempre con una pregunta general para entender la visi√≥n global del proyecto.
    3.  **Di√°logo Guiado:** Realiza preguntas espec√≠ficas y secuenciales para aclarar los detalles del proyecto (personal, actividades, MA, RSE, etc.).
    4.  **Justificaci√≥n Bajo Demanda:** Solo explica el porqu√© de un √≠tem si el usuario te lo pregunta directamente. S√© conciso en tu explicaci√≥n.
    5.  **Confirmaci√≥n Final sin Listas:** Cuando hayas recopilado toda la informaci√≥n, no listes los IDs. En su lugar, confirma que est√°s listo para filtrar. Por ejemplo: "¬°Listo! Ya he identificado los requisitos. ¬øConfirmo para filtrar el formulario?".
    6.  **Formato de Respuesta JSON (Interno):** Tu respuesta final DEBE ser un objeto JSON puro. El campo "mensaje" es para el usuario y el campo "ids" es para el sistema. La estructura es: \`{"mensaje": "Tu mensaje para el usuario.", "ids": ["L001", ...], "cerrar": boolean}\`. Durante la conversaci√≥n, \`cerrar\` es \`false\`. Solo es \`true\` en el mensaje final de confirmaci√≥n.

    **Cat√°logo LS.025 para tu referencia:**
    \${ls025Context}\${historialPrompt}`;

  const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";

  const response = await fetch(apiUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-goog-api-key': GEMINI_API_KEY,
    },
    body: JSON.stringify({
      contents: conversation,
      systemInstruction: { parts: [{ text: systemInstruction }] }
    })
  });

  if (!response.ok) {
    throw new Error(`Error de la API: ${response.statusText}`);
  }

  const data = await response.json();
  const rawText = data.candidates[0].content.parts.map(p => p.text).join('');
  let parsed = extractResponseObject(rawText);
  if (!parsed) {
    console.error("Fallo al parsear el JSON. Usando respuesta cruda como fallback. Respuesta:", rawText);
    parsed = { mensaje: rawText, ids: null, cerrar: false };
  }
  conversation.push({ role: 'model', parts: [{ text: JSON.stringify(parsed) }] });
  saveConversation();
  return parsed;
}

function renderConversation(){
  chatMessages.innerHTML = '';
  conversation.forEach(msg => {
    const sender = msg.role === 'user' ? 'user' : 'ai';
    let text = msg.parts.map(p=>p.text).join('');
    if (sender === 'ai') {
      const parsed = extractResponseObject(text);
      if (parsed && parsed.mensaje) {
        text = parsed.mensaje;
      }
    }
    addMessage(text, sender);
  });
}

async function iniciarAsistenteIA() {
  if(chatContainer.classList.contains('visible')){
    chatContainer.classList.remove('visible');
    return;
  }
  await ensureGeminiApiKey();
  renderConversation();
  chatContainer.classList.add('visible');
}

// ================== Configuraci√≥n y gesti√≥n de IA ==================
function clearActiveSession(){
  localStorage.removeItem("usuarioActual");
  sessionStorage.removeItem("usuarioActual");
  USUARIO = {nombre:"", correo:"", codigo:"", admin:false};
  ES_RESPONSABLE = false;
  USER_ROLES = new Set();
  toggleAdminUI(false);
  toggleResponsableUI(false);
  const emailInput = $("#userEmail");
  if(emailInput) emailInput.value = "";
  GEMINI_API_KEY = '';
  setChatVisibility(false);
}

function openLoginFromConfig(){
  const desiredEmail = ($('#cfg-session-email')?.value || '').trim().toLowerCase();
  if(USUARIO && USUARIO.correo){
    const proceed = confirm('Esto cerrar√° la sesi√≥n actual para volver a iniciarla. ¬øDesea continuar?');
    if(!proceed) return;
  }
  closeConfig();
  clearActiveSession();
  showLoginModal();
  if(desiredEmail){
    const persona = PERSONAL_LIST.find(p=>p.correo && p.correo.toLowerCase()===desiredEmail);
    if(persona){
      applyPersonaToLogin(persona);
    }else{
      const correoInput=$("#login-correo");
      if(correoInput){
        correoInput.value = desiredEmail;
        correoInput.readOnly = false;
      }
    }
  }
}

function openConfig(){
  $('#cfg-gemini').value = GEMINI_API_KEY || '';
  $('#cfg-script').value = SHEET_WEBAPP_URL || '';
  const sessionField = $('#cfg-session-email');
  if(sessionField){
    const email = USUARIO?.correo || '';
    sessionField.value = email;
  }
  if(USUARIO.admin){ $('#cfg-admin').style.display='block'; }
  else { $('#cfg-admin').style.display='none'; }
  $('#config-modal').style.display='flex';
}

function closeConfig(){ $('#config-modal').style.display='none'; }

async function saveConfig(){
  const apiKey = $('#cfg-gemini').value.trim();
  const script = $('#cfg-script').value.trim();
  const codigo = USUARIO?.codigo || 'anon';
  if(apiKey){
    GEMINI_API_KEY = apiKey;
    localStorage.setItem(`geminiKey_${codigo}`, apiKey);
    if(database) database.ref('geminiKeys/'+codigo).set(apiKey);
  }
  if(script){
    SHEET_WEBAPP_URL = script;
    localStorage.setItem('sheetWebAppUrl', script);
  }
  alert('Configuraci√≥n guardada');
  closeConfig();
}

async function changePassword(){
  const oldP = $('#cfg-oldpass').value.trim();
  const newP = $('#cfg-newpass').value.trim();
  if(!auth || !auth.currentUser){ alert('No autenticado'); return; }
  try{
    const cred = firebase.auth.EmailAuthProvider.credential(auth.currentUser.email, oldP);
    await auth.currentUser.reauthenticateWithCredential(cred);
    await auth.currentUser.updatePassword(newP);
    alert('Contrase√±a actualizada');
    $('#cfg-oldpass').value='';
    $('#cfg-newpass').value='';
  }catch(e){
    alert('Error: '+e.message);
  }
}

function grantAi(email){
  if(!database) return;
  database.ref('aiUsers/'+emailPath(email)).set(true);
}
function revokeAi(email){
  if(!database) return;
  database.ref('aiUsers/'+emailPath(email)).remove();
}

$('#btnConfig').addEventListener('click', openConfig);
$('#cfg-close').addEventListener('click', closeConfig);
$('#cfg-save').addEventListener('click', saveConfig);
$('#cfg-change-pass').addEventListener('click', changePassword);
$('#cfg-open-login').addEventListener('click', openLoginFromConfig);
$('#cfg-ai-enable').addEventListener('click', ()=>{ const em=$('#cfg-ai-email').value.trim().toLowerCase(); if(em){ grantAi(em); if(em===USUARIO.correo) checkAiAccess(); }});
$('#cfg-ai-disable').addEventListener('click', ()=>{ const em=$('#cfg-ai-email').value.trim().toLowerCase(); if(em){ revokeAi(em); if(em===USUARIO.correo) checkAiAccess(); }});

/* ================== Integraci√≥n con Power Automate ================== */
async function crearCarpetaSharePoint(clave, pid) {
  const powerAutomateUrl = 'https://prod-26.brazilsouth.logic.azure.com:443/workflows/2480fe6b97d44e86942d97d07a7db52f/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Zy5PNnODvzk8EfH9fc4SmPAZFZYFoMFoWAtfdwwWa9E';

  const empresa = DBCACHE[clave]?.empresa;
  const proyecto = DBCACHE[clave]?.proyectos?.[pid]?.proyecto;
  const nombreEmpresa = sanitizeName(empresa?.datos?.empresa || empresa?.nombre || clave);
  const nombreProyecto = sanitizeName(proyecto?.nombre || pid);

  const folderName = `${nombreEmpresa} - ${nombreProyecto}`;

  alert(`Creando carpeta para "${folderName}"... Por favor, espera.`);

  try {
    const response = await fetch(powerAutomateUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        nombreCarpeta: folderName
      }),
    });

    if (!response.ok) {
      throw new Error(`Error del servidor: ${response.status} ${response.statusText}`);
    }

    const data = await response.json();
    prompt(
      '¬°Carpeta creada con √©xito! Copia el siguiente enlace:',
      data.folderUrl
    );

  } catch (error) {
    console.error('Error al crear la carpeta en SharePoint:', error);
    alert('Hubo un error al intentar crear la carpeta. Revisa la consola para m√°s detalles.');
  }
}

/* ================== Integraci√≥n con MS Teams (Deep Links) ================== */
function iniciarChatTeams(clave, pid) {
  const empresa = DBCACHE[clave];
  const pr = empresa?.proyectos?.[pid];
  if (!empresa || !pr) {
    alert('No se encontraron datos para este proyecto.');
    return;
  }
  const resp = pr.proyecto?.responsables || {};
  const emails = [];
  if (resp.sst?.correo) emails.push(resp.sst.correo);
  if (resp.ma?.correo) emails.push(resp.ma.correo);
  if (resp.rse?.correo) emails.push(resp.rse.correo);
  if (resp.proyecto?.correo) emails.push(resp.proyecto.correo);
  if (emails.length === 0) {
    alert('No se encontraron correos de responsables configurados.');
    return;
  }
  const empresaName = empresa.empresa?.datos?.empresa || clave;
  const proyectoName = pr.proyecto?.nombre || pid;
  const topic = `Proyecto ${proyectoName} - ${empresaName}`;
  const message = `Hola equipo, por favor revisar el proyecto ${proyectoName} de ${empresaName}. en la siguiente pagina pueden ingresar para verificar https://dmachacap33.github.io/Habilitaci-n-para-Proyectos/`;
  const teamsUrl = `https://teams.microsoft.com/l/chat/0/0?users=${encodeURIComponent(emails.join(','))}&topicName=${encodeURIComponent(topic)}&message=${encodeURIComponent(message)}`;
  window.open(teamsUrl, '_blank');
}

/* ================== Pruebas manuales ================== */
function pruebasSanitizeName() {
  const ejemplos = [
    { empresa: 'Empre/sa#1 ', proyecto: ' Proy?:*1' },
    { empresa: 'A<B>C', proyecto: 'D|E%F.' },
    { empresa: 'Compa√±√≠a & Asociados', proyecto: 'Plan {Alpha}~2024' },
    { empresa: 'Nombre\nConSaltos', proyecto: 'Otro\nProyecto' }
  ];
  ejemplos.forEach(({ empresa, proyecto }) => {
    const empSan = sanitizeName(empresa);
    const proySan = sanitizeName(proyecto);
    console.log(`Empresa: "${empresa}" -> "${empSan}"`);
    console.log(`Proyecto: "${proyecto}" -> "${proySan}"`);
    console.log(`Nombre carpeta: "${empSan}${proySan}"`);
  });
}

// Ejecutar manualmente desde la consola cuando se necesiten pruebas:
// pruebasSanitizeName();

/* ================== Inicio ================== */
function init(){
    cargarUsuariosDesdeFirebase();
    cargarHistorialDesdeFirebase();
    cargarDatosDesdeFirebase();
    populatePersonalList();
    attachLoginListeners();
    refreshEmpresaList();
    toggleAdminUI(USUARIO.admin);
    checkAiAccess();
    if(USUARIO && USUARIO.correo){
        $("#userEmail").value = USUARIO.correo;
        if(USUARIO.admin){
            renderUsuarios();
            setTimeout(()=>{iniciarAsistenteIA();},1000);
        }
    } else {
        showLoginModal();
    }
    renderYPFB();
    updateNuevoProyectoBtn();
    const nombreInput=$("#emp-nombre");
    if(nombreInput){
        nombreInput.addEventListener("input", ()=>{
            $("#emp-clave").value = slugify(nombreInput.value);
        });
        nombreInput.addEventListener("change", ()=>{
            const clave = slugify(nombreInput.value);
            const emp = DBCACHE[clave];
            if(emp && emp.empresa){
                $("#emp-tel").value = emp.empresa.datos?.telefono || "";
                $("#emp-mail").value = emp.empresa.datos?.correo || "";
                $("#emp-clave").value = clave;
                renderListaProyectos();
            } else {
                ["#emp-tel","#emp-mail"].forEach(sel=>{ const el=$(sel); if(el) el.value=""; });
                const tb=$("#tb-proyectos"); if(tb) tb.innerHTML="";
            }
        });
    }
    $("#ls-rol").addEventListener("change", buildLs025);
    startTourOnce();
}
init();
if("serviceWorker" in navigator){navigator.serviceWorker.register("service-worker.js");}
</script>
</body>
</html>
